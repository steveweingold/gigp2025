forward
global type w_util from window
end type
type cb_147 from commandbutton within w_util
end type
type cb_146 from commandbutton within w_util
end type
type cb_145 from commandbutton within w_util
end type
type cb_144 from commandbutton within w_util
end type
type cb_143 from commandbutton within w_util
end type
type cb_142 from commandbutton within w_util
end type
type cb_141 from commandbutton within w_util
end type
type cb_140 from commandbutton within w_util
end type
type cb_139 from commandbutton within w_util
end type
type cb_138 from commandbutton within w_util
end type
type cb_137 from commandbutton within w_util
end type
type cb_136 from commandbutton within w_util
end type
type cb_135 from commandbutton within w_util
end type
type cb_134 from commandbutton within w_util
end type
type cb_133 from commandbutton within w_util
end type
type cb_132 from commandbutton within w_util
end type
type cb_131 from commandbutton within w_util
end type
type cb_130 from commandbutton within w_util
end type
type cb_129 from commandbutton within w_util
end type
type cb_128 from commandbutton within w_util
end type
type cb_127 from commandbutton within w_util
end type
type cb_126 from commandbutton within w_util
end type
type cb_125 from commandbutton within w_util
end type
type cb_124 from commandbutton within w_util
end type
type cb_123 from commandbutton within w_util
end type
type cb_122 from commandbutton within w_util
end type
type cb_121 from commandbutton within w_util
end type
type cb_120 from commandbutton within w_util
end type
type cb_119 from commandbutton within w_util
end type
type cb_118 from commandbutton within w_util
end type
type cb_117 from commandbutton within w_util
end type
type cb_116 from commandbutton within w_util
end type
type cb_115 from commandbutton within w_util
end type
type cb_114 from commandbutton within w_util
end type
type cb_113 from commandbutton within w_util
end type
type cb_112 from commandbutton within w_util
end type
type cb_111 from commandbutton within w_util
end type
type cb_110 from commandbutton within w_util
end type
type cb_109 from commandbutton within w_util
end type
type cb_108 from commandbutton within w_util
end type
type cb_107 from commandbutton within w_util
end type
type cb_106 from commandbutton within w_util
end type
type cb_105 from commandbutton within w_util
end type
type cb_104 from commandbutton within w_util
end type
type cb_103 from commandbutton within w_util
end type
type cb_102 from commandbutton within w_util
end type
type cb_101 from commandbutton within w_util
end type
type cb_100 from commandbutton within w_util
end type
type cb_99 from commandbutton within w_util
end type
type cb_98 from commandbutton within w_util
end type
type cb_97 from commandbutton within w_util
end type
type cb_96 from commandbutton within w_util
end type
type cb_95 from commandbutton within w_util
end type
type cb_94 from commandbutton within w_util
end type
type cb_93 from commandbutton within w_util
end type
type cb_92 from commandbutton within w_util
end type
type cb_91 from commandbutton within w_util
end type
type cb_90 from commandbutton within w_util
end type
type cb_89 from commandbutton within w_util
end type
type cb_88 from commandbutton within w_util
end type
type cb_87 from commandbutton within w_util
end type
type cb_86 from commandbutton within w_util
end type
type cb_85 from commandbutton within w_util
end type
type cb_84 from commandbutton within w_util
end type
type cb_83 from commandbutton within w_util
end type
type cb_82 from commandbutton within w_util
end type
type cb_81 from commandbutton within w_util
end type
type cb_80 from commandbutton within w_util
end type
type cb_79 from commandbutton within w_util
end type
type cb_78 from commandbutton within w_util
end type
type cb_77 from commandbutton within w_util
end type
type cb_76 from commandbutton within w_util
end type
type cb_75 from commandbutton within w_util
end type
type cb_74 from commandbutton within w_util
end type
type cb_73 from commandbutton within w_util
end type
type cb_72 from commandbutton within w_util
end type
type cb_71 from commandbutton within w_util
end type
type cb_70 from commandbutton within w_util
end type
type cb_69 from commandbutton within w_util
end type
type cb_68 from commandbutton within w_util
end type
type cb_67 from commandbutton within w_util
end type
type cb_66 from commandbutton within w_util
end type
type cb_65 from commandbutton within w_util
end type
type cb_64 from commandbutton within w_util
end type
type cb_63 from commandbutton within w_util
end type
type cb_62 from commandbutton within w_util
end type
type cb_61 from commandbutton within w_util
end type
type cb_60 from commandbutton within w_util
end type
type cb_59 from commandbutton within w_util
end type
type cb_58 from commandbutton within w_util
end type
type cb_57 from commandbutton within w_util
end type
type cb_56 from commandbutton within w_util
end type
type cb_55 from commandbutton within w_util
end type
type cb_54 from commandbutton within w_util
end type
type cb_53 from commandbutton within w_util
end type
type cb_52 from commandbutton within w_util
end type
type cb_51 from commandbutton within w_util
end type
type cb_50 from commandbutton within w_util
end type
type cb_49 from commandbutton within w_util
end type
type cb_48 from commandbutton within w_util
end type
type cb_47 from commandbutton within w_util
end type
type cb_46 from commandbutton within w_util
end type
type cb_45 from commandbutton within w_util
end type
type cb_44 from commandbutton within w_util
end type
type cb_43 from commandbutton within w_util
end type
type cb_42 from commandbutton within w_util
end type
type cb_41 from commandbutton within w_util
end type
type cb_40 from commandbutton within w_util
end type
type cb_39 from commandbutton within w_util
end type
type cb_38 from commandbutton within w_util
end type
type cb_37 from commandbutton within w_util
end type
type cb_36 from commandbutton within w_util
end type
type cb_35 from commandbutton within w_util
end type
type cb_34 from commandbutton within w_util
end type
type cb_33 from commandbutton within w_util
end type
type cb_32 from commandbutton within w_util
end type
type cb_31 from commandbutton within w_util
end type
type cb_30 from commandbutton within w_util
end type
type cb_29 from commandbutton within w_util
end type
type cb_28 from commandbutton within w_util
end type
type cb_27 from commandbutton within w_util
end type
type cb_26 from commandbutton within w_util
end type
type cb_25 from commandbutton within w_util
end type
type cb_24 from commandbutton within w_util
end type
type cb_23 from commandbutton within w_util
end type
type cb_22 from commandbutton within w_util
end type
type cb_21 from commandbutton within w_util
end type
type cb_20 from commandbutton within w_util
end type
type cb_19 from commandbutton within w_util
end type
type cb_18 from commandbutton within w_util
end type
type cb_17 from commandbutton within w_util
end type
type cb_16 from commandbutton within w_util
end type
type cb_15 from commandbutton within w_util
end type
type cb_14 from commandbutton within w_util
end type
type cb_13 from commandbutton within w_util
end type
type cb_12 from commandbutton within w_util
end type
type cb_11 from commandbutton within w_util
end type
type cb_10 from commandbutton within w_util
end type
type cb_7 from commandbutton within w_util
end type
type pb_1 from picturebutton within w_util
end type
type cb_9 from commandbutton within w_util
end type
type cb_8 from commandbutton within w_util
end type
type cb_report_count from commandbutton within w_util
end type
type cb_6 from commandbutton within w_util
end type
type st_1 from statictext within w_util
end type
type sle_entry from singlelineedit within w_util
end type
type cb_5 from commandbutton within w_util
end type
type cb_4 from commandbutton within w_util
end type
type cb_3 from commandbutton within w_util
end type
type cb_1 from commandbutton within w_util
end type
type dw_log from u_dw within w_util
end type
type cb_2 from commandbutton within w_util
end type
type gb_1 from groupbox within w_util
end type
type dw_cfa from datawindow within w_util
end type
type gb_2 from groupbox within w_util
end type
end forward

global type w_util from window
integer width = 2789
integer height = 3224
boolean titlebar = true
string title = "Miscellaneous Utilities"
boolean controlmenu = true
windowtype windowtype = response!
long backcolor = 67108864
string icon = "AppIcon!"
boolean center = true
cb_147 cb_147
cb_146 cb_146
cb_145 cb_145
cb_144 cb_144
cb_143 cb_143
cb_142 cb_142
cb_141 cb_141
cb_140 cb_140
cb_139 cb_139
cb_138 cb_138
cb_137 cb_137
cb_136 cb_136
cb_135 cb_135
cb_134 cb_134
cb_133 cb_133
cb_132 cb_132
cb_131 cb_131
cb_130 cb_130
cb_129 cb_129
cb_128 cb_128
cb_127 cb_127
cb_126 cb_126
cb_125 cb_125
cb_124 cb_124
cb_123 cb_123
cb_122 cb_122
cb_121 cb_121
cb_120 cb_120
cb_119 cb_119
cb_118 cb_118
cb_117 cb_117
cb_116 cb_116
cb_115 cb_115
cb_114 cb_114
cb_113 cb_113
cb_112 cb_112
cb_111 cb_111
cb_110 cb_110
cb_109 cb_109
cb_108 cb_108
cb_107 cb_107
cb_106 cb_106
cb_105 cb_105
cb_104 cb_104
cb_103 cb_103
cb_102 cb_102
cb_101 cb_101
cb_100 cb_100
cb_99 cb_99
cb_98 cb_98
cb_97 cb_97
cb_96 cb_96
cb_95 cb_95
cb_94 cb_94
cb_93 cb_93
cb_92 cb_92
cb_91 cb_91
cb_90 cb_90
cb_89 cb_89
cb_88 cb_88
cb_87 cb_87
cb_86 cb_86
cb_85 cb_85
cb_84 cb_84
cb_83 cb_83
cb_82 cb_82
cb_81 cb_81
cb_80 cb_80
cb_79 cb_79
cb_78 cb_78
cb_77 cb_77
cb_76 cb_76
cb_75 cb_75
cb_74 cb_74
cb_73 cb_73
cb_72 cb_72
cb_71 cb_71
cb_70 cb_70
cb_69 cb_69
cb_68 cb_68
cb_67 cb_67
cb_66 cb_66
cb_65 cb_65
cb_64 cb_64
cb_63 cb_63
cb_62 cb_62
cb_61 cb_61
cb_60 cb_60
cb_59 cb_59
cb_58 cb_58
cb_57 cb_57
cb_56 cb_56
cb_55 cb_55
cb_54 cb_54
cb_53 cb_53
cb_52 cb_52
cb_51 cb_51
cb_50 cb_50
cb_49 cb_49
cb_48 cb_48
cb_47 cb_47
cb_46 cb_46
cb_45 cb_45
cb_44 cb_44
cb_43 cb_43
cb_42 cb_42
cb_41 cb_41
cb_40 cb_40
cb_39 cb_39
cb_38 cb_38
cb_37 cb_37
cb_36 cb_36
cb_35 cb_35
cb_34 cb_34
cb_33 cb_33
cb_32 cb_32
cb_31 cb_31
cb_30 cb_30
cb_29 cb_29
cb_28 cb_28
cb_27 cb_27
cb_26 cb_26
cb_25 cb_25
cb_24 cb_24
cb_23 cb_23
cb_22 cb_22
cb_21 cb_21
cb_20 cb_20
cb_19 cb_19
cb_18 cb_18
cb_17 cb_17
cb_16 cb_16
cb_15 cb_15
cb_14 cb_14
cb_13 cb_13
cb_12 cb_12
cb_11 cb_11
cb_10 cb_10
cb_7 cb_7
pb_1 pb_1
cb_9 cb_9
cb_8 cb_8
cb_report_count cb_report_count
cb_6 cb_6
st_1 st_1
sle_entry sle_entry
cb_5 cb_5
cb_4 cb_4
cb_3 cb_3
cb_1 cb_1
dw_log dw_log
cb_2 cb_2
gb_1 gb_1
dw_cfa dw_cfa
gb_2 gb_2
end type
global w_util w_util

type prototypes
FUNCTION ulong GetSysColor (int index) LIBRARY "USER32.DLL"

FUNCTION integer IDCQRY (string buffer, long length, long flag) LIBRARY "IDCLIB32.DLL"

function ulong SHGetFolderPath(ulong hwndOwner, long nFolder, ulong hToken, long dwFlags, Ref string pszPath) library 'shell32.dll'

FUNCTION string GetString() LIBRARY "C:\Users\weingold\Documents\TestComFolder\TestCom.dll"

FUNCTION long GetWindow (UINT handle, INT direction) LIBRARY "user32.dll"
FUNCTION int GetWindowTextW (UINT handle, REF STRING window_title, INT buffer_size) LIBRARY "user32.dll"
end prototypes

type variables
Inet iinet
n_ir ir
integer ii_round = 3

long il_row, il_currentrow

datetime idt_app

string is_json

//Blob lblb_data
//Blob lblb_key
//Blob lblb_iv
//Blob lblb_encrypt
//Blob lblb_decrypt

end variables

forward prototypes
public subroutine of_add_log (string as_log)
public subroutine of_insertmetric (integer ai_metric, long al_gigpid, long al_cfa, string as_subcat, string as_refcode)
public subroutine of_insertsummary (integer ai_summary, long al_gigpid, long al_cfa, string as_type)
public subroutine of_insertamount (integer ai_amttype, long al_gigpid, long al_cfa, string as_code, string as_subcat)
public function boolean of_checkcusip (string as_cusip)
public subroutine of_cleanse_text (ref string as_text)
public function integer of_load_rawdata ()
public function string of_getlist (string as_type, integer ai_proj)
public function string gf_convert_num (integer ai_num)
public function string of_get_answer (long ai_question, long ai_application)
public function integer of_get_cvap_token (string as_tokentype, long an_tokencnt)
protected function string of_convert_decimal (string as_coord)
public function long of_get_staff (string as_name)
public function long of_get_window_handle_by_title (string as_windowtitle, boolean ab_exactmatch)
public function string of_get_window_title_text (long ll_handle)
public function jsonpackage of_getjsondatda ()
public function integer of_insertmetric (long al_phaseid, string as_category, string as_type, decimal ad_value)
end prototypes

public subroutine of_add_log (string as_log);long ll_row

If dw_log.DataObject = 'd_util_log' Then
	
	ll_row = dw_log.InsertRow(dw_log.RowCount() + 1)
	
	dw_log.SetItem(ll_row, 'message', as_log)
	
End If
end subroutine

public subroutine of_insertmetric (integer ai_metric, long al_gigpid, long al_cfa, string as_subcat, string as_refcode);string ls_metric
decimal ld_metric
n_cst_string ln_string

ls_metric = of_get_answer(ai_metric, al_cfa)
ls_metric = ln_string.of_globalreplace(ls_metric, ';', '')


If IsNumber(ls_metric) Then
	ld_metric = Dec(ls_metric)
	
	insert into gigp_project_metrics(gigp_id, category, sub_category, ref_code, metric_value, last_updated_by, last_updated_dt)
	values(:al_gigpID, 'projectMetric', :as_subcat, :as_refcode, :ld_metric, 'SYSTEM', getdate());
	
End If
end subroutine

public subroutine of_insertsummary (integer ai_summary, long al_gigpid, long al_cfa, string as_type);string ls_comments

ls_comments = of_get_answer(ai_summary, al_cfa)

If NOT IsNull(ls_comments) and ls_comments > '' Then

	insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
	values (:al_gigpid, :idt_app, 'appNote', :as_type, 'SYSTEM', :ls_comments);
	
End If
end subroutine

public subroutine of_insertamount (integer ai_amttype, long al_gigpid, long al_cfa, string as_code, string as_subcat);long ll_amtid
string ls_desc, ls_amt
decimal ld_amt
n_cst_string ln_string

ll_amtid = f_gettokenvalue('amountID', 1)

ls_amt = of_get_answer(ai_amttype, al_cfa)
ls_desc = ls_amt
ls_amt = ln_string.of_globalreplace(ls_amt, ';', '')
ls_amt = ln_string.of_globalreplace(ls_amt, '$', '')
ls_amt = ln_string.of_globalreplace(ls_amt, '/', '')
ls_amt = Trim(ls_amt)

If NOT IsNull(ls_amt) and ls_amt > '' Then

	If IsNumber(ls_amt) Then
		ld_amt = Dec(ls_amt)
		ls_desc = ''
	Else
		ld_amt = 0
	End If
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_amtid, :al_gigpid, :as_code, :as_subcat, :ls_desc, :ld_amt, 0, 'SYSTEM', getdate());
	
End If
end subroutine

public function boolean of_checkcusip (string as_cusip);string ls_cusip, ls_check, ls_char
integer li_len, li_place, li_sum, li_val, li_check

/*******************************************************************************************
*  Validate CUSIP based on the "Modulus 10 Double Add Double" technique *
*******************************************************************************************/
//Can only evaluate the full 9 char cusip
If IsNull(as_cusip) or Len(as_cusip) <> 9 Then Return False  

//Cusip is first 8 characters, Check digit is last character
ls_cusip = Left(Trim(as_cusip), 8)
ls_check = Right(Trim(as_cusip), 1)

//Make sure check digit is a number
If NOT IsNumber(ls_check) Then
	Return False
End If

li_sum = 0

//Loop through each character of the 8-character cusip and perform some ludicrous math
For li_place = 1 to 8
	//Get the character at the given place
	ls_char = Mid(ls_cusip, li_place, 1)
	
	If IsNumber(ls_char) Then  //If a number, take that value
		li_val = Integer(ls_char)
		
	Else
		If (Asc(ls_char) >= 65 and Asc(ls_char) <= 90) OR (Asc(ls_char) >= 97 and Asc(ls_char) <= 122) Then  //Determine if a letter (65 - 90 is upper case, 97 - 122 is lower)
			ls_char = Upper(ls_char)  //If a letter, Make sure capitalized
			
			li_val = (Asc(ls_char) - 64) + 9  //Get ordinal value for the letter (A=1, B=2, etc) and add 9 (sure, why not!)
			
		ElseIf ls_char = '*' Then  //Hard code value for *
			li_val = 36
		ElseIf ls_char = '@' Then  //Hard code value for @
			li_val = 37
		ElseIf ls_char = '#' Then  //Hard code value for #
			li_val = 38
		Else  //Not a valid character???
			Return False
		End If
		
	End If
	
	//If even place in the set, double the value
	If Mod(li_place, 2) = 0 Then
		li_val = li_val * 2
	End If
	
	//Add to running sum which splits out >1 digit number (ie 1 + 8 instead of 18)
	li_sum = li_sum + li_val / 10 + Mod(li_val, 10)
	
Next

li_check = Mod((10 - (Mod(li_sum, 10))), 10)  //Yea, sure... try to follow that!

//If the calculated check digit does not match the entered check digit then cusip is not valid
If li_check <> Integer(ls_check) Then
	Return False
Else
	Return True
End If
end function

public subroutine of_cleanse_text (ref string as_text);
Integer			li_UBound, N
n_cst_string		lu_string
String 			ls_text

String ls_find[]		= {'“', '”', '’', '…', '–', '‘'}
String ls_replace[] = {'"', '"', "'", '...','-', "'"}

//*************************************************************
// Cleanse text of special characters that cause issues with database.
//*************************************************************

ls_text = as_text

li_UBound = UpperBound(ls_find)

FOR N = 1 TO li_UBound
     ls_text =  lu_string.of_globalreplace(ls_text, ls_find[N], ls_replace[N])
NEXT

ls_text = lu_string.of_removenonprint(ls_text)

as_text = Trim(ls_text)


end subroutine

public function integer of_load_rawdata ();long ll_row, ll_count, ll_rc, ll_questionId
String ls_text

If MessageBox('CSV Import', 'Is the file saved as C:\GIGP4.csv?', Question!, YesNo!) = 2 Then
	Return 1
End If

dw_cfa.SetTransObject(SQLCA)

If dw_cfa.ImportFile("C:\GIGP4.csv") <= 0 Then
	Return 1
End If

ll_count = dw_cfa.RowCount()

If ll_count > 0 Then
	For ll_row = 1 to ll_count
		
		sle_entry.Text = 'Working on row ' + String(ll_row) + ' of ' + String(ll_count)
		
		ll_questionId = dw_cfa.GetItemNumber(ll_row, 'question_id')
		
		select question
		into :ls_text
		from gigp_round4_questions
		where question_id = :ll_questionId;
				
//		ls_text = dw_cfa.GetItemString(ll_row, 'question')
		this.of_cleanse_text(ls_text)
		dw_cfa.SetItem(ll_row, 'question', ls_text)
		
		ls_text = dw_cfa.GetItemString(ll_row, 'answer')
		this.of_cleanse_text(ls_text)
		dw_cfa.SetItem(ll_row, 'answer', ls_text)
		
		dw_cfa.SetItemStatus(ll_row, 0, Primary!, NewModified!)
		
	Next
End If

ll_rc = dw_cfa.Update()

If ll_rc = 1 Then
	Return 1
Else
	of_add_log(SQLCA.SQLErrText)
	Return -1
End If

Return 1
end function

public function string of_getlist (string as_type, integer ai_proj);string ls_list, ls_select, ls_syntax, ls_error
long ll_count, ll_row
datastore lds_data

//Make sure a valid project_id is passed in
If IsNull(ai_proj) or ai_proj <= 0 Then Return ''

//Make sure a list type was passed in
If IsNull(as_type) or as_type = '' Then Return ''

//Based on the type of list, create the select statement - NOTE: a column (or psuedocolumn) should be called "description" in the select for the list to work
Choose Case Lower(as_type)
	Case 'waterbody'
		ls_select = "select r.description from cv_reference r, cv_project_waterbody w where w.waterbody_cd = r.code and r.ref_type = 'waterbody_cd' and w.project_id = " + string(ai_proj) + " order by r.description"
		
	Case 'restriction'
		ls_select = "select r.description + ' = ' + convert(varchar(255), p.restriction_desc)  as description  from cv_reference r, cv_project_restriction p where p.restriction_type_cd = r.code and r.ref_type = 'restriction_type_cd' and p.project_id = " + string(ai_proj) + " order by description"
		
	Case 'operation'
		ls_select = "select r.description from cv_reference r, cv_project_operation o where o.operation_type_cd = r.code and r.ref_type = 'operation_type_cd' and o.project_id = " + string(ai_proj) + " order by r.description"
		
	Case 'type'
		ls_select = "select r.description from cv_reference r, cv_project_type t where t.project_type_cd = r.code and r.ref_type = 'project_type_cd' and t.project_id = " + string(ai_proj) + " order by r.description"
	Case Else
		Return ''
		
End Choose

If ls_select > '' Then
	//Create the datastore holder
	If NOT IsValid(lds_data) Then lds_data = CREATE datastore

	//Create the dataobject syntax from the sql statement
	ls_syntax = SQLCA.SyntaxFromSQL(ls_select, "", ls_error)
	
	If ls_syntax > '' Then
		//Create the datastore with the new sytax
		lds_data.CREATE(ls_syntax)
		
		//Retrieve the data
		lds_data.SetTransObject(SQLCA)
		ll_count = lds_data.Retrieve()
		
		//Loop through the data and create the list
		If ll_count > 0 Then
			For ll_row = 1 to ll_count
				
				If ls_list = '' Then
					ls_list = lds_data.GetItemString(ll_row, 'description')
				Else
					ls_list += '; ' + lds_data.GetItemString(ll_row, 'description')
				End If
				
			Next
			
		End If
		
	Else
		If IsValid(lds_data) Then DESTROY lds_data
		Return ls_error
	End If
	
End If

If IsValid(lds_data) Then DESTROY lds_data

Return ls_list

end function

public function string gf_convert_num (integer ai_num);/************************************************************************
** This function returns the 1st, 2nd, 3rd, etc equivalent of an integer
*************************************************************************/
string ls_num, ls_first

//If the number passed in is null or <= 0 then return it
If IsNull(ai_num) or ai_num <= 0 Then
	Return String(ai_num)
End If

//Get the right most digit of the number
ls_num = String(ai_num)
ls_first = Right(ls_num,1)

//Add the appropriate suffix based on the right most digit
Choose Case ls_first
	Case '1'
		If ai_num = 11 Then
			ls_num += 'th'
		Else
			ls_num += 'st'
		End If
		
	Case '2'
		If ai_num = 12 Then
			ls_num += 'th'
		Else
			ls_num += 'nd'
		End If
		
	Case '3'
		If ai_num = 13 Then
			ls_num += 'th'
		Else
			ls_num += 'rd'
		End If
		
	Case else
		ls_num += 'th'
		
End Choose

Return ls_num
end function

public function string of_get_answer (long ai_question, long ai_application);string ls_answer

select Max(convert(varchar(5000), answer))
into :ls_answer
from gigp_cfa_raw_data
where app_id = :ai_application
and question_id = :ai_question
and round_no = :ii_round;

Return ls_answer
end function

public function integer of_get_cvap_token (string as_tokentype, long an_tokencnt);//*********************************************************************
//	DESC:	Gets next value for non-sensible, sequential database
//			keys (in place of 'identity' columns).
//			In most cases, call this from ue_PreUpdate() on datawindows.
//		
//	NOTE: If more than one user gets the same value, causing a
//			'duplicate key' error, move the call to this function
//			into the ue_PreUpdate() on the window since this event
//			is outside the overall update transaction and will be
//			committed immediately.
//
//       Code compliments of Mark Callahan (6/03)
//*********************************************************************

Integer	li_rc
Long		ll_nextValue, ll_currValue
String		ls_User, ls_Msg
Datetime	ldt_Today

ls_User   = gnv_app.of_GetUserId()
ldt_Today = f_GetDBDatetime()

//***********************************
// Get current token value:
//***********************************

Select token_value
Into  :ll_currValue
From   cv_token_table 
Where  token_type = :as_TokenType;

//***********************************
// Add 1 to get next token value &
// update the token table:
//***********************************

ll_nextValue = (ll_currValue + an_tokenCnt)

Update cv_token_table
Set 	 token_value     	= :ll_nextValue,
		 last_updated_by 	= :ls_User,
		 last_updated_dt 	= :ldt_Today
Where token_type = :as_TokenType;
	
If sqlca.SQLCode <> 0 Then Goto Error

Return ll_nextValue

Error:

	ls_Msg = "Error retrieving next value for ' + as_TokenType + ' in function of_GetTokenValue()."
				
	MessageBox("ERRROR!", ls_Msg)		
	
	Return -1



end function

protected function string of_convert_decimal (string as_coord);string ls_deg, ls_min, ls_sec, ls_entry
integer li_space1, li_space2, li_length
decimal ld_gis, ld_deg, ld_min, ld_sec

//Coordinates should be the format: DEG MIN SEC  ex: "74 32 16"

ls_entry = Trim(as_coord)

li_length = Len(ls_entry)

If li_length <= 0 Then Return ''

li_space1 = Pos(ls_entry, ' ', 1)

If li_space1 > 0 Then
	ls_deg = left(ls_entry, li_space1 - 1)
End If

li_space2 = Pos(ls_entry, ' ', li_space1 + 1)

If li_space2 > 0 Then
	ls_min = Mid(ls_entry, li_space1 + 1, li_space2 - li_space1)
End If

ls_sec = Right(ls_entry, li_length - li_space2)

ld_deg = Dec(ls_deg)
ld_min = Dec(ls_min)
ld_sec = Dec(ls_sec)

ld_gis = Round((ld_deg + (ld_min / 60) + (ld_sec / 3600)), 8)

Return String(ld_gis)
end function

public function long of_get_staff (string as_name);long ll_staff
	
Choose Case as_name
	Case 'Denno'
		ll_staff = 4849
	Case 'Deuel'
		ll_staff = 4137
	Case 'Earley'
		ll_staff = 7203
	Case 'Ferebee'
		ll_staff = 8396
	Case 'Smith'
		ll_staff = 4134
	Case 'Ng'
		ll_staff = 4805
	Case 'Sammons'
		ll_staff = 1139
	Case 'Blackwell'
		ll_staff = 1751
	Case 'Eichenlaub'
		ll_staff = 7189
	Case 'Grazulis'
		ll_staff = 1748
	Case 'Lanigan'
		ll_staff = 1745
	Case 'Lipiec'
		ll_staff = 8375
	Case 'Ferrentino'
		ll_staff = 0
	Case 'Hale'
		ll_staff = 1746
	Case 'Sellman'
		ll_staff = 8376
	Case 'Rusin'
		ll_staff = 4616
	Case 'Stearns'
		ll_staff = 0
	Case 'Hawley'
		ll_staff = 7781
	Case 'Lanahan'
		ll_staff = 7861
	Case 'Krembs'
		ll_staff = 7530
	Case 'Geiger'
		ll_staff = 1136
	Case "O'Neil"
		ll_staff = 2885
	Case 'VanDerhoof'
		ll_staff = 1138
	Case 'Ricci'
		ll_staff = 6705
	Case 'Blount'
		ll_staff = 2398
	Case 'Caban'
		ll_staff = 8037
	Case 'Kerzic'
		ll_staff = 1135
	Case 'LaPan'
		ll_staff = 8384
	Case 'Nelson'
		ll_staff = 1233
	Case 'Penner'
		ll_staff = 1137
	Case 'Magee'
		ll_staff = 0
	Case 'Wright'
		ll_staff = 6091
	Case Else
		ll_staff = 0
End Choose


Return ll_staff
end function

public function long of_get_window_handle_by_title (string as_windowtitle, boolean ab_exactmatch);long ll_handle
string ls_Null, ls_WindowTitle

// Initialize.
SetNull(ls_Null)
as_WindowTitle = Lower(Trim(as_WindowTitle))

// Error checking.
IF IsNull(as_WindowTitle) OR as_WindowTitle = '' Then Return 0
IF IsNull(ab_ExactMatch) Then Return 0

//Loop through open windows and match title
ll_handle = FindWindowA(ls_Null, ls_Null)

DO WHILE ll_handle > 0
	//Get window's title
	ls_WindowTitle = Lower(This.of_get_window_title_text(ll_handle))

	IF ls_WindowTitle > '' Then
		IF ab_ExactMatch Then
			
			IF ls_WindowTitle = as_WindowTitle Then
				Return ll_handle
			End If
			
		Else
			
			IF Pos(ls_WindowTitle, as_WindowTitle) > 0 Then
				Return ll_handle
			End If
			
		End If
	End If

    // Find next window.
    ll_handle = GetWindow(ll_handle, 2)
	 
Loop

Return 0
end function

public function string of_get_window_title_text (long ll_handle);string ls_WindowTitle

ls_WindowTitle = Space(255)	//This has to remain or fatal error occurs
GetWindowTextW(ll_handle, ls_WindowTitle, 255)

Return Trim(ls_WindowTitle)
end function

public function jsonpackage of_getjsondatda ();JsonPackage lj_data

lj_data = CREATE JsonPackage

lj_data.loadstring( '{"FirstName":"Steve","LastName":"Weingold","Age":53}')

Return lj_data

end function

public function integer of_insertmetric (long al_phaseid, string as_category, string as_type, decimal ad_value);
If ad_value > 0 or IsNull(ad_value) Then
	insert into ProjectPhaseMetric(ProjectPhaseId, MetricCategory, MetricType, MetricValue, LastupdatedDate, LastUpdatedBy)
	values (:al_phaseid, :as_category, :as_type, :ad_value, getdate(), 'SYSTEM');
End If

					
Return 1
end function

on w_util.create
this.cb_147=create cb_147
this.cb_146=create cb_146
this.cb_145=create cb_145
this.cb_144=create cb_144
this.cb_143=create cb_143
this.cb_142=create cb_142
this.cb_141=create cb_141
this.cb_140=create cb_140
this.cb_139=create cb_139
this.cb_138=create cb_138
this.cb_137=create cb_137
this.cb_136=create cb_136
this.cb_135=create cb_135
this.cb_134=create cb_134
this.cb_133=create cb_133
this.cb_132=create cb_132
this.cb_131=create cb_131
this.cb_130=create cb_130
this.cb_129=create cb_129
this.cb_128=create cb_128
this.cb_127=create cb_127
this.cb_126=create cb_126
this.cb_125=create cb_125
this.cb_124=create cb_124
this.cb_123=create cb_123
this.cb_122=create cb_122
this.cb_121=create cb_121
this.cb_120=create cb_120
this.cb_119=create cb_119
this.cb_118=create cb_118
this.cb_117=create cb_117
this.cb_116=create cb_116
this.cb_115=create cb_115
this.cb_114=create cb_114
this.cb_113=create cb_113
this.cb_112=create cb_112
this.cb_111=create cb_111
this.cb_110=create cb_110
this.cb_109=create cb_109
this.cb_108=create cb_108
this.cb_107=create cb_107
this.cb_106=create cb_106
this.cb_105=create cb_105
this.cb_104=create cb_104
this.cb_103=create cb_103
this.cb_102=create cb_102
this.cb_101=create cb_101
this.cb_100=create cb_100
this.cb_99=create cb_99
this.cb_98=create cb_98
this.cb_97=create cb_97
this.cb_96=create cb_96
this.cb_95=create cb_95
this.cb_94=create cb_94
this.cb_93=create cb_93
this.cb_92=create cb_92
this.cb_91=create cb_91
this.cb_90=create cb_90
this.cb_89=create cb_89
this.cb_88=create cb_88
this.cb_87=create cb_87
this.cb_86=create cb_86
this.cb_85=create cb_85
this.cb_84=create cb_84
this.cb_83=create cb_83
this.cb_82=create cb_82
this.cb_81=create cb_81
this.cb_80=create cb_80
this.cb_79=create cb_79
this.cb_78=create cb_78
this.cb_77=create cb_77
this.cb_76=create cb_76
this.cb_75=create cb_75
this.cb_74=create cb_74
this.cb_73=create cb_73
this.cb_72=create cb_72
this.cb_71=create cb_71
this.cb_70=create cb_70
this.cb_69=create cb_69
this.cb_68=create cb_68
this.cb_67=create cb_67
this.cb_66=create cb_66
this.cb_65=create cb_65
this.cb_64=create cb_64
this.cb_63=create cb_63
this.cb_62=create cb_62
this.cb_61=create cb_61
this.cb_60=create cb_60
this.cb_59=create cb_59
this.cb_58=create cb_58
this.cb_57=create cb_57
this.cb_56=create cb_56
this.cb_55=create cb_55
this.cb_54=create cb_54
this.cb_53=create cb_53
this.cb_52=create cb_52
this.cb_51=create cb_51
this.cb_50=create cb_50
this.cb_49=create cb_49
this.cb_48=create cb_48
this.cb_47=create cb_47
this.cb_46=create cb_46
this.cb_45=create cb_45
this.cb_44=create cb_44
this.cb_43=create cb_43
this.cb_42=create cb_42
this.cb_41=create cb_41
this.cb_40=create cb_40
this.cb_39=create cb_39
this.cb_38=create cb_38
this.cb_37=create cb_37
this.cb_36=create cb_36
this.cb_35=create cb_35
this.cb_34=create cb_34
this.cb_33=create cb_33
this.cb_32=create cb_32
this.cb_31=create cb_31
this.cb_30=create cb_30
this.cb_29=create cb_29
this.cb_28=create cb_28
this.cb_27=create cb_27
this.cb_26=create cb_26
this.cb_25=create cb_25
this.cb_24=create cb_24
this.cb_23=create cb_23
this.cb_22=create cb_22
this.cb_21=create cb_21
this.cb_20=create cb_20
this.cb_19=create cb_19
this.cb_18=create cb_18
this.cb_17=create cb_17
this.cb_16=create cb_16
this.cb_15=create cb_15
this.cb_14=create cb_14
this.cb_13=create cb_13
this.cb_12=create cb_12
this.cb_11=create cb_11
this.cb_10=create cb_10
this.cb_7=create cb_7
this.pb_1=create pb_1
this.cb_9=create cb_9
this.cb_8=create cb_8
this.cb_report_count=create cb_report_count
this.cb_6=create cb_6
this.st_1=create st_1
this.sle_entry=create sle_entry
this.cb_5=create cb_5
this.cb_4=create cb_4
this.cb_3=create cb_3
this.cb_1=create cb_1
this.dw_log=create dw_log
this.cb_2=create cb_2
this.gb_1=create gb_1
this.dw_cfa=create dw_cfa
this.gb_2=create gb_2
this.Control[]={this.cb_147,&
this.cb_146,&
this.cb_145,&
this.cb_144,&
this.cb_143,&
this.cb_142,&
this.cb_141,&
this.cb_140,&
this.cb_139,&
this.cb_138,&
this.cb_137,&
this.cb_136,&
this.cb_135,&
this.cb_134,&
this.cb_133,&
this.cb_132,&
this.cb_131,&
this.cb_130,&
this.cb_129,&
this.cb_128,&
this.cb_127,&
this.cb_126,&
this.cb_125,&
this.cb_124,&
this.cb_123,&
this.cb_122,&
this.cb_121,&
this.cb_120,&
this.cb_119,&
this.cb_118,&
this.cb_117,&
this.cb_116,&
this.cb_115,&
this.cb_114,&
this.cb_113,&
this.cb_112,&
this.cb_111,&
this.cb_110,&
this.cb_109,&
this.cb_108,&
this.cb_107,&
this.cb_106,&
this.cb_105,&
this.cb_104,&
this.cb_103,&
this.cb_102,&
this.cb_101,&
this.cb_100,&
this.cb_99,&
this.cb_98,&
this.cb_97,&
this.cb_96,&
this.cb_95,&
this.cb_94,&
this.cb_93,&
this.cb_92,&
this.cb_91,&
this.cb_90,&
this.cb_89,&
this.cb_88,&
this.cb_87,&
this.cb_86,&
this.cb_85,&
this.cb_84,&
this.cb_83,&
this.cb_82,&
this.cb_81,&
this.cb_80,&
this.cb_79,&
this.cb_78,&
this.cb_77,&
this.cb_76,&
this.cb_75,&
this.cb_74,&
this.cb_73,&
this.cb_72,&
this.cb_71,&
this.cb_70,&
this.cb_69,&
this.cb_68,&
this.cb_67,&
this.cb_66,&
this.cb_65,&
this.cb_64,&
this.cb_63,&
this.cb_62,&
this.cb_61,&
this.cb_60,&
this.cb_59,&
this.cb_58,&
this.cb_57,&
this.cb_56,&
this.cb_55,&
this.cb_54,&
this.cb_53,&
this.cb_52,&
this.cb_51,&
this.cb_50,&
this.cb_49,&
this.cb_48,&
this.cb_47,&
this.cb_46,&
this.cb_45,&
this.cb_44,&
this.cb_43,&
this.cb_42,&
this.cb_41,&
this.cb_40,&
this.cb_39,&
this.cb_38,&
this.cb_37,&
this.cb_36,&
this.cb_35,&
this.cb_34,&
this.cb_33,&
this.cb_32,&
this.cb_31,&
this.cb_30,&
this.cb_29,&
this.cb_28,&
this.cb_27,&
this.cb_26,&
this.cb_25,&
this.cb_24,&
this.cb_23,&
this.cb_22,&
this.cb_21,&
this.cb_20,&
this.cb_19,&
this.cb_18,&
this.cb_17,&
this.cb_16,&
this.cb_15,&
this.cb_14,&
this.cb_13,&
this.cb_12,&
this.cb_11,&
this.cb_10,&
this.cb_7,&
this.pb_1,&
this.cb_9,&
this.cb_8,&
this.cb_report_count,&
this.cb_6,&
this.st_1,&
this.sle_entry,&
this.cb_5,&
this.cb_4,&
this.cb_3,&
this.cb_1,&
this.dw_log,&
this.cb_2,&
this.gb_1,&
this.dw_cfa,&
this.gb_2}
end on

on w_util.destroy
destroy(this.cb_147)
destroy(this.cb_146)
destroy(this.cb_145)
destroy(this.cb_144)
destroy(this.cb_143)
destroy(this.cb_142)
destroy(this.cb_141)
destroy(this.cb_140)
destroy(this.cb_139)
destroy(this.cb_138)
destroy(this.cb_137)
destroy(this.cb_136)
destroy(this.cb_135)
destroy(this.cb_134)
destroy(this.cb_133)
destroy(this.cb_132)
destroy(this.cb_131)
destroy(this.cb_130)
destroy(this.cb_129)
destroy(this.cb_128)
destroy(this.cb_127)
destroy(this.cb_126)
destroy(this.cb_125)
destroy(this.cb_124)
destroy(this.cb_123)
destroy(this.cb_122)
destroy(this.cb_121)
destroy(this.cb_120)
destroy(this.cb_119)
destroy(this.cb_118)
destroy(this.cb_117)
destroy(this.cb_116)
destroy(this.cb_115)
destroy(this.cb_114)
destroy(this.cb_113)
destroy(this.cb_112)
destroy(this.cb_111)
destroy(this.cb_110)
destroy(this.cb_109)
destroy(this.cb_108)
destroy(this.cb_107)
destroy(this.cb_106)
destroy(this.cb_105)
destroy(this.cb_104)
destroy(this.cb_103)
destroy(this.cb_102)
destroy(this.cb_101)
destroy(this.cb_100)
destroy(this.cb_99)
destroy(this.cb_98)
destroy(this.cb_97)
destroy(this.cb_96)
destroy(this.cb_95)
destroy(this.cb_94)
destroy(this.cb_93)
destroy(this.cb_92)
destroy(this.cb_91)
destroy(this.cb_90)
destroy(this.cb_89)
destroy(this.cb_88)
destroy(this.cb_87)
destroy(this.cb_86)
destroy(this.cb_85)
destroy(this.cb_84)
destroy(this.cb_83)
destroy(this.cb_82)
destroy(this.cb_81)
destroy(this.cb_80)
destroy(this.cb_79)
destroy(this.cb_78)
destroy(this.cb_77)
destroy(this.cb_76)
destroy(this.cb_75)
destroy(this.cb_74)
destroy(this.cb_73)
destroy(this.cb_72)
destroy(this.cb_71)
destroy(this.cb_70)
destroy(this.cb_69)
destroy(this.cb_68)
destroy(this.cb_67)
destroy(this.cb_66)
destroy(this.cb_65)
destroy(this.cb_64)
destroy(this.cb_63)
destroy(this.cb_62)
destroy(this.cb_61)
destroy(this.cb_60)
destroy(this.cb_59)
destroy(this.cb_58)
destroy(this.cb_57)
destroy(this.cb_56)
destroy(this.cb_55)
destroy(this.cb_54)
destroy(this.cb_53)
destroy(this.cb_52)
destroy(this.cb_51)
destroy(this.cb_50)
destroy(this.cb_49)
destroy(this.cb_48)
destroy(this.cb_47)
destroy(this.cb_46)
destroy(this.cb_45)
destroy(this.cb_44)
destroy(this.cb_43)
destroy(this.cb_42)
destroy(this.cb_41)
destroy(this.cb_40)
destroy(this.cb_39)
destroy(this.cb_38)
destroy(this.cb_37)
destroy(this.cb_36)
destroy(this.cb_35)
destroy(this.cb_34)
destroy(this.cb_33)
destroy(this.cb_32)
destroy(this.cb_31)
destroy(this.cb_30)
destroy(this.cb_29)
destroy(this.cb_28)
destroy(this.cb_27)
destroy(this.cb_26)
destroy(this.cb_25)
destroy(this.cb_24)
destroy(this.cb_23)
destroy(this.cb_22)
destroy(this.cb_21)
destroy(this.cb_20)
destroy(this.cb_19)
destroy(this.cb_18)
destroy(this.cb_17)
destroy(this.cb_16)
destroy(this.cb_15)
destroy(this.cb_14)
destroy(this.cb_13)
destroy(this.cb_12)
destroy(this.cb_11)
destroy(this.cb_10)
destroy(this.cb_7)
destroy(this.pb_1)
destroy(this.cb_9)
destroy(this.cb_8)
destroy(this.cb_report_count)
destroy(this.cb_6)
destroy(this.st_1)
destroy(this.sle_entry)
destroy(this.cb_5)
destroy(this.cb_4)
destroy(this.cb_3)
destroy(this.cb_1)
destroy(this.dw_log)
destroy(this.cb_2)
destroy(this.gb_1)
destroy(this.dw_cfa)
destroy(this.gb_2)
end on

type cb_146 from commandbutton within w_util
integer x = 567
integer y = 1284
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Upd GRG"
end type

event clicked;long ll_gigpId, ll_row, ll_count, ll_applicant, ll_id, ll_customer, ll_plc
string ls_applicant, ls_eligible, ls_appStatus, ls_fips, ls_projname, ls_projstatus, ls_funding_rec, ls_projno, ls_sql, ls_redc, ls_lat, ls_long, ls_location
datastore lds_data

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_sql = 'select gigp_id, project_name as Awardee, CustomerId, project_name, 0.000000 as latitude, 0.000000 as longitude, project_name as munui, project_name as CountyName, county_fips_code, redc_region from gigp_application where 1 = 2'

f_createdatastore(lds_data, SQLCA, ls_sql)

ll_count = lds_data.ImportFile('G:\PowerBuilder\Small Grants\GRG\GrgApplications.txt')

If ll_count <= 0 Then
	MessageBox('Import', 'No data found to import')
	Return
End If

If MessageBox('Import', String(ll_count) + ' rows imported. Continue"', Question!, YesNoCancel!, 1) <> 1 Then Return

of_add_log(String(ll_count) + ' awarded records found.')

//New round for GRG
ii_round = 600

For ll_row = 1 to ll_count
	ls_applicant = lds_data.GetItemString(ll_row, 'Awardee')
	ls_projname = lds_data.GetItemString(ll_row, 'project_name')
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	ls_projstatus = 'projectActive'
	ll_gigpID = lds_data.GetItemNumber(ll_row, 'gigp_id')
	ll_customer = lds_data.GetItemNumber(ll_row, 'CustomerId')
	ls_lat = String(lds_data.GetItemDecimal(ll_row, 'latitude'))
	ls_long = String(lds_data.GetItemDecimal(ll_row, 'longitude'))
	ls_fips = lds_data.GetItemString(ll_row, 'county_fips_code')
	ls_redc = lds_data.GetItemString(ll_row, 'redc_region')
	
	update gigp_application
	set redc_region = :ls_redc,
		county_fips_code = :ls_fips
	where gigp_id = :ll_gigpID;

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

end event

type cb_145 from commandbutton within w_util
integer x = 128
integer y = 1284
integer width = 361
integer height = 100
integer taborder = 310
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load GRG"
end type

event clicked;long ll_gigpId, ll_row, ll_count, ll_applicant, ll_id, ll_customer, ll_plc
string ls_applicant, ls_eligible, ls_appStatus, ls_fips, ls_projname, ls_projstatus, ls_funding_rec, ls_projno, ls_sql, ls_redc, ls_lat, ls_long, ls_location
datastore lds_data

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_sql = 'select gigp_id, project_name as Awardee, CustomerId, project_name, 0.000000 as latitude, 0.000000 as longitude, project_name as Muni, project_name as CountyName, county_fips_code, redc_region from gigp_application where 1 = 2'

f_createdatastore(lds_data, SQLCA, ls_sql)

ll_count = lds_data.ImportFile('G:\PowerBuilder\Small Grants\GRG\GrgApplications.txt')

If ll_count <= 0 Then
	MessageBox('Import', 'No data found to import')
	Return
End If

If MessageBox('Import', String(ll_count) + ' rows imported. Continue"', Question!, YesNoCancel!, 1) <> 1 Then Return

of_add_log(String(ll_count) + ' awarded records found.')

//New round for GRG
ii_round = 600

For ll_row = 1 to ll_count
	ls_applicant = lds_data.GetItemString(ll_row, 'Awardee')
	ls_projname = lds_data.GetItemString(ll_row, 'project_name')
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	ls_projstatus = 'projectActive'
	ll_gigpID = lds_data.GetItemNumber(ll_row, 'gigp_id')
	ll_customer = lds_data.GetItemNumber(ll_row, 'CustomerId')
	ls_lat = String(lds_data.GetItemDecimal(ll_row, 'latitude'))
	ls_long = String(lds_data.GetItemDecimal(ll_row, 'longitude'))
	ls_fips = lds_data.GetItemString(ll_row, 'county_fips_code')
	ls_redc = lds_data.GetItemString(ll_row, 'redc_region')
	
	
	//Create application record
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete, redc_region)
	values (:ll_gigpID, :ii_round, 'GRG', :ls_projname, :ls_projstatus, null, 'Construction', null, null, null, null, :ls_projno, null, null, null, null, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, :ls_fips, null, null, null, 0, getdate(), 'SYSTEM', null, 0, null, 0, null);
	
	of_add_log('Application added for ' + ls_applicant)
	

	//Add or Link to Contact
	ll_applicant = f_gettokenvalue('contactID', 1)
	
	insert into gigp_contacts (contact_id, organization, first_name, last_name, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, phone_2, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_applicant, :ls_applicant,  'GRG Project', null, null, null, null, null, null, null, null, 'Active', 'SYSTEM', getdate(), null, null);
		
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	//Project Location record
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_location = 'Project location record for GRG Small Grant ID ' + String(ll_gigpID)
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_location, null, null, null, null, null, 'Active', 'SYSTEM', getdate(), :ls_long, :ls_lat);
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

end event

type cb_144 from commandbutton within w_util
integer x = 2327
integer y = 1496
integer width = 361
integer height = 100
integer taborder = 350
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2023 EfcDesc"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_value, ls_projno, ls_projname, ls_apptype, ls_applicant, ls_coordinator, ls_techlead, ls_engineer, ls_mwbe, ls_projdesc
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id
decimal ld_tpc, ld_requested, ld_award, ld_local
decimal ld_fundreq, ld_recfund, ld_eligible, ld_req, ld_app
datetime ldt_date
n_ds lds_data

//ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_application where round_no = 102', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL("select gigp_id, comments from gigp_notes where 1=2", 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\Small Grants\EPG (Engineering Planning Grant)\Round 2023\EfcProjectDesc.txt')

If MessageBox('Data import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

ldt_date = DateTime(Today(), Now())

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'gigp_id')	//really cfa_no but using gigp_id as a placeholder
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	If ll_gigp > 0 Then
			ls_projdesc = Trim(lds_data.GetItemString(ll_row, 'comments'))
			
			ls_projdesc = Upper(Left(ls_projdesc, 1)) + Right(ls_projdesc, Len(ls_projdesc) - 1)
			
			of_add_log('Inserting for gigpid ' + string(ll_gigp) + ':  ' + ls_projdesc)
			
			//Applicant Project Description
			insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
			values (:ll_gigp, :ldt_date, 'appNote', 'projDescription', 'SYSTEM', :ls_projdesc);

	End If

Next

of_add_log('Done loading descriptions')
end event

type cb_143 from commandbutton within w_util
integer x = 2327
integer y = 1388
integer width = 361
integer height = 100
integer taborder = 310
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2023 15 Load"
end type

event clicked;integer li_district, li_checklist, li_pop, li_programId, li_upperbound, li_index
long ll_eng, ll_coordinator, ll_assist, ll_id, ll_comma
decimal ld_requested, ld_grant
datetime ldt_responseletterdate, ldt_targetdateforga, ldt_anticipatedcompletion, ldt_accepted
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret, ll_awarded_count, ll_pos, ll_paralegal, ll_legal, ll_deceng, ll_leadreviewer
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist, ls_program
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_recchigh, ls_ineligible, ls_eng
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop, ls_projname, ls_projstatus, ls_projdesc, ls_location
string ls_muni_name, ls_muni_type, ls_municode, ls_projecttypes, ls_granttype
string ls_agency, ls_spdes, ls_consent, ls_efcprojdesc, ls_projsummary, ls_typecode, ls_gigp, ls_applicanttype
string ls_typearray[], ls_null[]
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string
boolean lb_update = False

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))


ls_appStatus = 'ELIGIBLE'
ls_funding_rec = 'RECC-H'
ls_projstatus = 'projectActive'
idt_app = DateTime(Date('7/28/2023'))
ls_applicanttype = 'MUNI'
SetNull(ls_CFAtype)


//Retrieve projects
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_2023_15'
lds_apps.SetTransObject(SQLCA)
ll_count = lds_apps.Retrieve()

If MessageBox('Applications Found', String(ll_count) + ' applications found. Continue with load?', Question!, YesNo!, 2) = 2 Then
	Return
End If

If MessageBox('UPDATES?', 'Update database during load?', Question!, YesNo!, 1) = 1 Then
	lb_update = True
Else
	lb_update = False
End If

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
//For ll_row = 1 to 2	//*****************TESTING
	
	ll_gigpID = lds_apps.GetItemNumber(ll_row,	'gigp_id')
	ii_round = lds_apps.GetItemNumber(ll_row,	'round_no')
	li_programId = lds_apps.GetItemNumber(ll_row,'cfa_program_id')
	ll_cfa = lds_apps.GetItemNumber(ll_row,'cfa_no')
	ls_assembly = String(lds_apps.GetItemNumber(ll_row, 'assembly'))
	ls_senate = String(lds_apps.GetItemNumber(ll_row, 'senate'))
	ld_requested = lds_apps.GetItemDecimal(ll_row,'requested_amt')
	ld_grant = lds_apps.GetItemDecimal(ll_row,'recc_amt')
	ls_lat = String(lds_apps.GetItemDecimal(ll_row, 'latitude'))
	ls_lon = String(lds_apps.GetItemDecimal(ll_row, 'longitude'))
	ls_program = lds_apps.GetItemString(ll_row,'program')
	ls_applicant = lds_apps.GetItemString(ll_row,'applicant')
	ls_applicanttype = lds_apps.GetItemString(ll_row,'typeof_applicant')
	ls_projname = lds_apps.GetItemString(ll_row,'project_name')
	ls_redc = lds_apps.GetItemString(ll_row,'redc_region')
	ls_projdesc = lds_apps.GetItemString(ll_row,'project_descrption')
	ls_county = lds_apps.GetItemString(ll_row,'county')

	ls_gigp = String(ll_gigpID)
	
	
	//County
	select ref_code
	into :ls_fips
	from gigp_reference
	where category = 'County'
	and ref_value = :ls_county;
	
	//Muni
	SetNull(ls_municode)
	
	//Get Muni Name from full name
	ll_pos = Pos(ls_applicant, ' of ')
	
	If ll_pos > 0 Then
		ls_muni_name = Right(ls_applicant, Len(ls_applicant) - (ll_pos + 3))
		ls_muni_type = Left(ls_applicanttype, 1)
	
		select max(muni_code)
		into :ls_municode
		from fin_muni_codes
		where muni_name = :ls_muni_name
		and community_type = :ls_muni_type;
		
	End If
	
	If ls_program = 'GIGP' Then
		ls_granttype = 'Construction'
	Else
		ls_granttype = 'Design'
	End If
	

	If lb_update Then
		insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete, consent_order, redc_region)
		values (:ll_gigpID, :ii_round, :ls_program, :ls_projname, :ls_projstatus, 'CW', :ls_granttype, null, null, :ls_municode, null, null, null, :ls_CFAtype, :ls_applicanttype, :idt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, :ls_fips, null, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, 0, null, :ls_redc);
	End if
	
	of_add_log('Application added for ' + ls_applicant)
	
	//Create CFA Items
	If lb_update Then
		insert into gigp_cfa_items(gigp_id, grant_status, project_status, project_status_comment, last_updated_dt, last_updated_by)
		values (:ll_gigpID, 'statusPending', 'statusGreen', null, getdate(), 'SYSTEM');
	End If
	
	of_add_log('CFA Items added for ' + ls_applicant)
		

	//Create Summaries
	If lb_update Then
		//Applicant Project Description
		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
		values (:ll_gigpId, :idt_app, 'appNote', 'appProjDescription', 'SYSTEM', :ls_projdesc);
	
	End If
	


	//Insert checklist item for Project Required by MS 4...
	If lb_update Then
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
	End If
		
	
	//Insert Project Location Record (then link political districts to it)
	ls_addr = Left(of_get_answer(928, ll_cfa), 50)
	ls_city = Left(of_get_answer(565, ll_cfa), 30)
	ls_state = Left(of_get_answer(568, ll_cfa), 2)
	ls_zip = Left(of_get_answer(1034, ll_cfa), 10)
	
	ls_phone = Left(of_get_answer(651, ll_cfa), 25)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	

	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_location = 'Project location record for GIGP ' + String(ll_gigpID)
	
	If lb_update Then
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_location, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_plc, :ll_gigpID, 'PLC');
	End If
		
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				If lb_update Then
					insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
					values(:ll_plc, 'nysSenate', :li_district, 2010);
				End If
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
			End If
			
			
		Else
			li_district = Integer(ls_senate)
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
			End If
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				If lb_update Then
					insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
					values(:ll_plc, 'nysAssembly', :li_district, 2010);
				End If
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
			End If
			
			
		Else
			li_district = Integer(ls_assembly)
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
			End If
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	
	/*********************************************************
	FIGURE OUT BETTER WAY TO GET APPLICANT WITH OTHER FIELDS BLANK
	********************************************************/
	//Add or Link to Contact (***using contacts table instead of of_get_answer???)

	ll_applicant = f_gettokenvalue('contactID', 1)
	
	ls_addr = Left(of_get_answer(551, ll_cfa), 50)
	ls_city = Left(of_get_answer(565, ll_cfa), 30)
	ls_state = Left(of_get_answer(553, ll_cfa), 2)
	ls_zip = Left(of_get_answer(554, ll_cfa), 10)
	ls_email = Left(of_get_answer(555, ll_cfa), 75)

	ls_phone = Left(of_get_answer(651, ll_cfa), 25)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	If lb_update Then
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, comments, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'Application Record for GIGP' + :ls_gigp,'SYSTEM', getdate(), :ls_lon, :ls_lat);
	End If

	If lb_update Then
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_applicant, :ll_gigpID, 'APP');
	End If
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
			
			If lb_update Then
				insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
				values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			End If
			
		End If
		
		If lb_update Then
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			Values (:ll_other, :ll_gigpID, 'OTH');
		End If
		
	End If
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
			
			If lb_update Then
				insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
				values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			End If
			
		End If
		
		If lb_update Then
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			Values (:ll_other, :ll_gigpID, 'PRC');
		End If
		
	End If
	
	
//	//Add EFC Contacts
//	If lb_update Then
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ll_eng, :ll_gigpID, 'EFCENG');
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ll_coordinator, :ll_gigpID, 'EPGASSIGN');
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ll_paralegal, :ll_gigpID, 'EFCPARALGL');
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ll_legal, :ll_gigpID, 'EFCLGL');
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ll_deceng, :ll_gigpID, 'EFCDECENG');
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ll_leadreviewer, :ll_gigpID, 'EFCLEADREV');
//		
//	End If
	
	of_add_log('Done adding Contacts')
	
	
	//AMOUNTS
	ll_id = f_gettokenvalue('amountID', 1)
	
	If lb_update Then
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_requested, :ld_grant, 'SYSTEM', getdate());
	End If

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_142 from commandbutton within w_util
integer x = 2327
integer y = 1284
integer width = 361
integer height = 100
integer taborder = 310
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2023 15 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\Small Grants\GIGP\Round 15\GIGP Awarded Efficiencies_All_Answer_635_Vertical.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
Next

If IsValid(lds_data) Then Destroy lds_data


ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\Small Grants\GIGP\Round 15\GIGP Awarded Stormwater_All_Answer_636_Vertical.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
Next


If IsValid(lds_data) Then Destroy lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\Small Grants\EPG (Engineering Planning Grant)\Round 2023\EPG Awarded_All_Answer_637_Vertical.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
Next

If IsValid(lds_data) Then Destroy lds_data


of_add_log('Done')
end event

type cb_141 from commandbutton within w_util
integer x = 1920
integer y = 1504
integer width = 343
integer height = 100
integer taborder = 350
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Sym Decrypt"
end type

event clicked;Blob lblb_key
Blob lblb_encrypt
Blob lblb_decrypt
string ls_encrypt
string ls_password
CrypterObject lnv_CrypterObject

//Create the Crypter object
lnv_CrypterObject = Create CrypterObject

//Get the encrypted password from the .ini file
ls_encrypt = ProfileString(gnv_app.of_getappinifile(), 'EFC-Hub', 'Encrypt', '')

//Convert the encrypted password and key to a Blob
lblb_encrypt = Blob(ls_encrypt, EncodingANSI!)
lblb_key = Blob("EFC Key122079876", EncodingANSI!)

//Decrypt using AES
lblb_decrypt = lnv_CrypterObject.SymmetricDecrypt(AES!, lblb_encrypt, lblb_key)

//Convert the decrypted password back to plain text
ls_password = string(lblb_decrypt, EncodingANSI!)
of_add_log("SymmetricDecrypt = " + ls_password)

If IsValid(lnv_CrypterObject) Then DESTROY lnv_CrypterObject
end event

type cb_140 from commandbutton within w_util
integer x = 1582
integer y = 1504
integer width = 343
integer height = 100
integer taborder = 340
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Sym Encrypt"
end type

event clicked;Blob lblb_data
Blob lblb_key
Blob lblb_encrypt
string ls_encrypt
string ls_key
CrypterObject lnv_CrypterObject

//Create the Crypter object
lnv_CrypterObject = Create CrypterObject

//Convert the plain text password and key to a Blob using ANSI encoding
lblb_data = Blob(sle_entry.Text, EncodingANSI!)
lblb_key = Blob("EFC Key122079876", EncodingANSI!)	//128 Bit key (16 characters) required for AES encryption

//Encrypt the password
lblb_encrypt = lnv_CrypterObject.SymmetricEncrypt(AES!, lblb_data, lblb_key)

//Convert the encrypted password to string and store in the .ini file
ls_encrypt = String(lblb_encrypt, EncodingANSI!)
SetProfileString(gnv_app.of_getappinifile(), 'EFC-Hub', 'Encrypt', ls_encrypt)

If IsValid(lnv_CrypterObject) Then DESTROY lnv_CrypterObject

end event

type cb_139 from commandbutton within w_util
integer x = 105
integer y = 1504
integer width = 398
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Base32 Encode"
end type

event clicked;Blob lblb_data
string ls_encode
CoderObject lnv_CoderObject

//Create the coder object
lnv_CoderObject = Create CoderObject

//Convert the plain text password to binary ANSI
lblb_data = Blob(sle_entry.Text, EncodingUTF8! )

//Encode the password using Base32 Encoding
ls_encode = lnv_CoderObject.Base32Encode(lblb_data)

of_add_log('Base32 Encoded Password = ' + ls_encode)

If NOT IsNull(ls_encode) Then
	Messagebox('Encrypt', 'Encryption successful')
Else
	Messagebox('Encrypt', 'Encryption failed')
End If

SetProfileString(gnv_app.of_getappinifile(), 'EFC-Hub', 'key', ls_encode)

If IsValid(lnv_CoderObject) Then DESTROY lnv_CoderObject

end event

type cb_138 from commandbutton within w_util
integer x = 494
integer y = 1504
integer width = 416
integer height = 100
integer taborder = 330
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Base32 Decrode"
end type

event clicked;Blob lblb_data
string ls_value, ls_encode
CoderObject lnv_CoderObject

//Create the coder object
lnv_CoderObject = Create CoderObject

//Get the encrypted password stored in the ini file
ls_encode = ProfileString(gnv_app.of_getappinifile(), 'EFC-Hub', 'key', '')

//Decode using Base32
lblb_data = lnv_CoderObject.Base32Decode(ls_encode)

//Get the plain text value out of the Blob
ls_value = string(lblb_data, EncodingUTF8!)

messagebox("Base32Decode value", ls_value)

If IsValid(lnv_CoderObject) Then DESTROY lnv_CoderObject


end event

type cb_137 from commandbutton within w_util
integer x = 1243
integer y = 1504
integer width = 343
integer height = 100
integer taborder = 330
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Hex Decode"
end type

event clicked;Blob lblb_data
string ls_value, ls_encode
CoderObject lnv_CoderObject

//Create the coder object
lnv_CoderObject = Create CoderObject

//Get the encrypted password stored in the database
//select Value
//into :ls_encode
//from EfcReference
//where Module = 'TestEncryption'
//and Category = 'Key';

ls_encode = ProfileString(gnv_app.of_getappinifile(), 'EFC-Hub', 'key', '')

//Decode using Hex
lblb_data = lnv_CoderObject.HexDecode(ls_encode)

//Get the plain text value out of the Blob
ls_value = string(lblb_data, EncodingANSI!)

messagebox("HexDecode value", ls_value)

If IsValid(lnv_CoderObject) Then DESTROY lnv_CoderObject
end event

type cb_136 from commandbutton within w_util
integer x = 905
integer y = 1504
integer width = 343
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Hex Encode"
end type

event clicked;Blob lblb_data
string ls_encode
CoderObject lnv_CoderObject

//Create the coder object
lnv_CoderObject = Create CoderObject

//Convert the plain text password to binary ANSI
lblb_data = Blob(sle_entry.Text, EncodingANSI!)

//Encode the password using Hex Encoding
ls_encode = lnv_CoderObject.HexEncode(lblb_data)

of_add_log('Hex Encoded Password = ' + ls_encode)

If NOT IsNull(ls_encode) Then
	Messagebox('Encrypt', 'Encryption successful')
Else
	Messagebox('Encrypt', 'Encryption failed')
End If

//Store the encrypted password in the database
SetProfileString(gnv_app.of_getappinifile(), 'EFC-Hub', 'key', ls_encode)

//update EfcReference
//set Value = :ls_encode
//where Module = 'TestEncryption'
//and Category = 'Key';

If IsValid(lnv_CoderObject) Then DESTROY lnv_CoderObject
end event

type cb_135 from commandbutton within w_util
integer x = 2327
integer y = 1180
integer width = 361
integer height = 100
integer taborder = 310
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "OSG"
end type

event clicked;long ll_gigpId, ll_row, ll_count, ll_applicant, ll_id
string ls_applicant, ls_eligible, ls_appStatus, ls_fips, ls_projname, ls_projstatus, ls_funding_rec, ls_projno
decimal ld_amount

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ii_round = 500

//Retrieve awarded - Original Load
string ls_applicants[] = {'Carthage (V)', 'Herkimer (V)', 'Whitehall (V)'}
string ls_fipsarray[] = {'045', '043', '115'}
//long ll_amounts[] = {500000,350000,343000,1334500,21000000,1000000}

ll_count = Upperbound(ls_applicants)

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
	ls_applicant = ls_applicants[ll_row]
	ls_projname = 'OSG Project for ' + ls_applicant

	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	ls_projstatus = 'projectActive'
	ls_fips = ls_fipsarray[ll_row]
	
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	
	//Create application record
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete, redc_region)
	values (:ll_gigpID, :ii_round, 'OSG', :ls_projname, :ls_projstatus, null, 'Construction', null, null, null, null, :ls_projno, null, null, null, null, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, :ls_fips, null, null, null, 0, getdate(), 'SYSTEM', null, 0, null, 0, null);
	
	of_add_log('Application added for ' + ls_applicant)
	

	//Add or Link to Contact
	ll_applicant = f_gettokenvalue('contactID', 1)
	
	insert into gigp_contacts (contact_id, organization, first_name, last_name, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, phone_2, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_applicant, :ls_applicant,  'OSG Project', null, null, null, null, null, null, null, null, 'Active', 'SYSTEM', getdate(), null, null);
		
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//AMOUNTS
//	ll_id = f_gettokenvalue('amountID', 1)
//	
//	ld_amount = Dec(ll_amounts[ll_row])
//	
//	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
//	values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_amount, :ld_amount, 'SYSTEM', getdate());
	
	//Add vendors
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (10758, :ll_gigpID, 'VEND');
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (10759, :ll_gigpID, 'VEND');

	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (10760, :ll_gigpID, 'VEND');
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (10761, :ll_gigpID, 'VEND');

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

end event

type cb_134 from commandbutton within w_util
integer x = 1888
integer y = 1180
integer width = 361
integer height = 100
integer taborder = 330
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Uber Log"
end type

event clicked;string	ls_Log_File_Name, ls_data[], &
			ls_Code, gs_INI
long gl_Log_File
n_cst_gwsend	lnvo_gwsend
n_cst_authentication_service lnv_AuthService
ContextKeyword lcxk_base
environment		le_Env

GetEnvironment(le_Env)

IF le_Env.osmajorrevision >= 6 THEN
	this.GetContextService("Keyword",lcxk_base)

	lcxk_base.GetContextKeywords("APPDATA",ls_data)

   IF Upperbound(ls_data) > 0 THEN
		IF NOT DirectoryExists(ls_Data[1] + "\EFC") THEN
			CreateDirectory(ls_Data[1] + "\EFC")
		END IF

		IF NOT FileExists(ls_data[1] + "\EFC\efc.ini") THEN
			FileCopy("\\efc-fs01\f-drive\Powerbuilder Apps (EFC)\exe\efc.ini",ls_Data[1] + "\EFC\efc.ini")
		END IF

		gs_INI = ls_data[1] + "\EFC\efc.ini"
//		ls_Log_File_Name = ls_data[1] + "\EFC\uberbatch.log"	SW, 5/2023
		ls_Log_File_Name = '\\efc-fs01\F-Drive\PB\Uberbatch\Logs\uberbatch.log'
	ELSE
		gs_INI = "c:\windows\efc.ini"
//		ls_Log_File_Name = ProfileString(gs_INI,"uberbatch","logfile","c:\windows\uberbatch.log")	SW, 5/2023
		ls_Log_File_Name = '\\efc-fs01\F-Drive\PB\Uberbatch\Logs\uberbatch.log'
	END IF
ELSE
	gs_INI = "c:\windows\efc.ini"
//	ls_Log_File_Name = ProfileString(gs_INI,"uberbatch","logfile","c:\windows\uberbatch.log")	SW, 5/2023
	ls_Log_File_Name = '\\efc-fs01\F-Drive\PB\Uberbatch\Logs\uberbatch.log'
END IF

// Open Log File.
gl_Log_File = FileOpen(ls_Log_File_Name,LineMode!,Write!,LockReadWrite!,Append!)

FileWrite(gl_Log_File,"TEST STEVE")
FileWrite(gl_Log_File,String(Today(),"mm/dd/yyyy") + " - " + String(Now(),"hh:mm:ss") + " - UberBatch Process Started.")

FileClose(gl_Log_File)
end event

type cb_133 from commandbutton within w_util
integer x = 1449
integer y = 1180
integer width = 361
integer height = 100
integer taborder = 270
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "REDCs"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_fips, ls_program
long ll_ret, ll_row, ll_gigp
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_application where redc_region is null and county_fips_code is not null', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

If ll_ret > 0 Then
	For ll_row = 1 to ll_ret
		ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
		ls_fips = lds_data.GetItemString(ll_row, 'county_fips_code')
		ls_program = lds_data.GetitemString(ll_row, 'program')
		ls_region = ''
		
		select Max(RedcRegion)
		into :ls_region
		from CountyRegion
		where CountyCode = :ls_fips;
		
		of_add_log('REDC Region for ' + ls_program + ' GIGP ' + String(ll_gigp) + ' set to ' + ls_region)
		
		If ls_region > '' Then
			update gigp_application
			set redc_region = :ls_region
			where gigp_id = :ll_gigp;
		End If
		
	Next
	
End If

of_add_log('Done')
end event

type cb_132 from commandbutton within w_util
integer x = 1015
integer y = 1176
integer width = 361
integer height = 100
integer taborder = 310
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "18/19 Types"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant, ls_staff, ls_reviewer
string ls_proj, ls_decregion, ls_scoping, ls_scoping_comment, ls_efc_comments, ls_review_agency, ls_consent, ls_consent_order, ls_redc, ls_project_name, ls_types, ls_typecode
string ls_project_types[], ls_type, ls_projtypeitem, ls_note, ls_null[], ls_typearray[]
datetime ldt_scoping
integer li_create, li_round, li_upperbound, li_index
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app, ll_staff, ll_amtcount, ll_reviewer, ll_count, ll_legal
decimal ld_grant, ld_award_letter, ld_award_amt
boolean lb_update = False
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, consent_order_comments as types from gigp_application where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\EPG (Engineering Planning Grant)\EPG2018_2019ProjectTypes.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ls_types = lds_data.GetItemString(ll_row, 'types')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	ls_typearray[] = ls_null[]
	
	ln_string.of_parsetoarray(ls_types, ',', ls_typearray)
	
	li_upperbound = UpperBound(ls_typearray)
	
	If li_upperbound > 0 Then
		For li_index = 1 to li_upperbound
			ls_type = Trim(ls_typearray[li_index])
			
			select ref_code
			into :ls_typecode
			from gigp_reference
			where category = 'ProjectType'
			and Convert(varchar(200), description) = :ls_type;
			
			If IsNull(ls_typecode) Then Continue
			
			of_add_log('Adding GIGP# ' + String(ll_gigp) + '  /  Project Type:  '+ ls_typecode)
			
			insert into gigp_project_types (gigp_id, project_type)
			values (:ll_gigp, :ls_typecode);
			
			SetNull(ls_typecode)
			
		Next
		
	End If
	
Next

of_add_log('Done at ' + String(Today(), "m/d/yy hh:mm"))
end event

type cb_131 from commandbutton within w_util
integer x = 567
integer y = 1176
integer width = 361
integer height = 100
integer taborder = 360
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2022 Load"
end type

event clicked;integer li_district, li_checklist, li_pop, li_programId, li_upperbound, li_index
long ll_eng, ll_coordinator, ll_assist, ll_id, ll_comma
decimal ld_requested, ld_grant
datetime ldt_responseletterdate, ldt_targetdateforga, ldt_anticipatedcompletion, ldt_accepted
datetime ldt_award, ldt_shporeview
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret, ll_awarded_count, ll_pos, ll_paralegal, ll_legal, ll_deceng, ll_leadreviewer
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_recchigh, ls_ineligible, ls_eng
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop, ls_projname, ls_projstatus, ls_projdesc, ls_location
string ls_muni_name, ls_muni_type, ls_municode, ls_proj_stat_comment, ls_projecttypes
string ls_agency, ls_spdes, ls_consent, ls_efcprojdesc, ls_projsummary, ls_typecode, ls_gigp, ls_applicanttype
string ls_typearray[], ls_null[]
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string
boolean lb_update = False

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ii_round = 2022
li_programId = 596
ls_proj_stat_comment = 'The grant award letter has been sent out and documents to develop the grant agreement are being collected.'
ldt_award = DateTime(Date('11/4/2022'))
ldt_shporeview = DateTime(Date('11/14/2022'))
ls_appStatus = 'ELIGIBLE'
ls_funding_rec = 'RECC-H'
ls_projstatus = 'projectActive'
idt_app = DateTime(Date('11/4/2022'))
ls_applicanttype = 'MUNI'
SetNull(ls_CFAtype)


//Retrieve projects
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_round2022'
lds_apps.SetTransObject(SQLCA)
ll_count = lds_apps.Retrieve()

If MessageBox('Applications Found', String(ll_count) + ' applications found. Continue with load?', Question!, YesNo!, 2) = 2 Then
	Return
End If

If MessageBox('UPDATES?', 'Update database during load?', Question!, YesNo!, 1) = 1 Then
	lb_update = True
Else
	lb_update = False
End If

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
	
	ll_cfa = lds_apps.GetItemNumber(ll_row,'cfa_no')
	ls_muni_name = lds_apps.GetItemString(ll_row, 'muni_name')
	ls_muni_type = lds_apps.GetItemString(ll_row, 'muni_type')
	ls_projname = lds_apps.GetItemString(ll_row, 'project_name')
	ls_applicant = lds_apps.GetItemString(ll_row,'muni_name')
	ld_requested = lds_apps.GetItemDecimal(ll_row,'grant_amount')
	ld_grant = lds_apps.GetItemDecimal(ll_row,'grant_amount')
	ls_consent = lds_apps.GetItemString(ll_row,'consent_order')
	ls_redc = lds_apps.GetItemString(ll_row,'redc_region')
	ls_projdesc = lds_apps.GetItemString(ll_row,'applicant_description')
	ls_county = lds_apps.GetItemString(ll_row, 'county')
	ls_region = String(lds_apps.GetItemNumber(ll_row, 'dec_region'))
	ls_agency = lds_apps.GetItemString(ll_row,'review_agency')
	
	ll_coordinator = lds_apps.GetItemNumber(ll_row,'epg_coordinator')
	ll_eng = lds_apps.GetItemNumber(ll_row,'efc_engineer')
	
	ll_paralegal = lds_apps.GetItemNumber(ll_row,'efc_paralegal')
	ll_legal = lds_apps.GetItemNumber(ll_row,'efc_legal')
	ll_deceng = lds_apps.GetItemNumber(ll_row,'dec_engineer')
	ll_leadreviewer = lds_apps.GetItemNumber(ll_row,'lead_reviewer')
	
	ls_lat = String(lds_apps.GetItemDecimal(ll_row, 'latitude'))
	ls_lon = String(lds_apps.GetItemDecimal(ll_row, 'longitude'))
	
	ls_assembly = String(lds_apps.GetItemNumber(ll_row, 'assembly'))
	ls_senate = String(lds_apps.GetItemNumber(ll_row, 'senate'))
	
	ls_efcprojdesc = lds_apps.GetItemString(ll_row, 'efc_project_description')
	ls_projsummary = lds_apps.GetItemString(ll_row, 'efc_project_summary')
	
	ls_projecttypes = lds_apps.GetItemString(ll_row, 'projec_types')
	
	
	
	If lb_update Then
		ll_gigpID = f_gettokenvalue('gigpID', 1)
	Else
		ll_gigpID = 0
	End If
	ls_gigp = String(ll_gigpID)
	
	
	//County
	select ref_code
	into :ls_fips
	from gigp_reference
	where category = 'County'
	and ref_value = :ls_county;
	
	//Muni
	SetNull(ls_municode)
	
	//Get Muni Name from full name
	ll_pos = Pos(ls_muni_name, ' of ')
	
	If ll_pos > 0 Then
		ls_muni_name = Right(ls_muni_name, Len(ls_muni_name) - (ll_pos + 3))
	
		select max(muni_code)
		into :ls_municode
		from fin_muni_codes
		where muni_name = :ls_muni_name
		and community_type = :ls_muni_type;
		
	End If
	
	
	//Consent Order
	Choose Case ls_consent
		Case 'Compliance Schedule'
			ls_consent = 'COComp'
		Case 'Consent Order', 'Yes'
			ls_consent = 'COOrder'
		Case 'None', 'No'
			ls_consent = 'CONone'
	End Choose
	
	

	If lb_update Then
		insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete, consent_order, redc_region)
		values (:ll_gigpID, :ii_round, 'EPG', :ls_projname, :ls_projstatus, 'CW', 'Design', null, :ls_region, :ls_municode, null, null, null, :ls_CFAtype, :ls_applicanttype, :idt_app, :ls_appStatus, null, :ls_funding_rec, :ls_agency, null, null, null, :ls_fips, :ls_spdes, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, 0, :ls_consent, :ls_redc);
	End if
	
	of_add_log('Application added for ' + ls_applicant)
	
	//Create CFA Items
	If lb_update Then
		insert into gigp_cfa_items(gigp_id, grant_status, project_status, project_status_comment, last_updated_dt, last_updated_by)
		values (:ll_gigpID, 'statusPending', 'statusGreen', :ls_proj_stat_comment, getdate(), 'SYSTEM');
	End If
	
	of_add_log('CFA Items added for ' + ls_applicant)
		
		
	/****************************************************
	Response Letter Date (contracts tab) for all: 12/21/2018
	Target Date for GA for all: 12/31/2019
	Anticipated Completion Date for all: 12/31/2019
	*****************************************************/
//	ldt_responseletterdate = lds_apps.GetItemDateTime(ll_row,'award_letter_date')
//	ldt_targetdateforga = lds_apps.GetItemDateTime(ll_row,'target_for_ga')
//	ldt_anticipatedcompletion = lds_apps.GetItemDateTime(ll_row,'anticipated_completion')
//	ldt_accepted = lds_apps.GetItemDateTime(ll_row, 'award_accepted')
//
//	//Insert dates
//	If lb_update Then
//		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
//		values (:ll_gigpID, 'agreeCOMLTRSEN', :ldt_responseletterdate, 'SYSTEM', getdate());
//		
//		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
//		values (:ll_gigpID, 'epgTARGETDATE', :ldt_targetdateforga, 'SYSTEM', getdate());
//		
//		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
//		values (:ll_gigpID, 'epgANTICIPATEDCOMPL', :ldt_anticipatedcompletion, 'SYSTEM', getdate());
//		
//		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
//		values (:ll_gigpID, 'epgAWARDACCEPT', :ldt_accepted, 'SYSTEM', getdate());
//	End if
	
	
	 
	//Create Summaries
	If lb_update Then
		//Applicant Project Description
		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
		values (:ll_gigpId, :idt_app, 'appNote', 'appProjDescription', 'SYSTEM', :ls_projdesc);
		
		//EFC Project Description
		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
		values (:ll_gigpId, :idt_app, 'appNote', 'projDescription', 'SYSTEM', :ls_efcprojdesc);
		
		//Project Summary
		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
		values (:ll_gigpId, :idt_app, 'appNote', 'projSummary', 'SYSTEM', :ls_projsummary);

	End If
	


	//Insert checklist item for Project Required by MS 4...
	If lb_update Then
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
	End If
		
	
	//Insert Project Location Record (then link political districts to it)
	ls_addr = Left(of_get_answer(928, ll_cfa), 50)
	ls_city = Left(of_get_answer(565, ll_cfa), 30)
	ls_state = Left(of_get_answer(568, ll_cfa), 2)
	ls_zip = Left(of_get_answer(1034, ll_cfa), 10)
	
	

	ls_phone = Left(of_get_answer(651, ll_cfa), 25)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	

	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_location = 'Project location record for GIGP ' + String(ll_gigpID)
	
	If lb_update Then
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_location, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_plc, :ll_gigpID, 'PLC');
	End If
		
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				If lb_update Then
					insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
					values(:ll_plc, 'nysSenate', :li_district, 2010);
				End If
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
			End If
			
			
		Else
			li_district = Integer(ls_senate)
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
			End If
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				If lb_update Then
					insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
					values(:ll_plc, 'nysAssembly', :li_district, 2010);
				End If
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
			End If
			
			
		Else
			li_district = Integer(ls_assembly)
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
			End If
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	
	/*********************************************************
	FIGURE OUT BETTER WAY TO GET APPLICANT WITH OTHER FIELDS BLANK
	********************************************************/
	//Add or Link to Contact (***using contacts table instead of of_get_answer???)

	ll_applicant = f_gettokenvalue('contactID', 1)
	
	ls_addr = Left(of_get_answer(551, ll_cfa), 50)
	ls_city = Left(of_get_answer(565, ll_cfa), 30)
	ls_state = Left(of_get_answer(553, ll_cfa), 2)
	ls_zip = Left(of_get_answer(554, ll_cfa), 10)
	ls_email = Left(of_get_answer(555, ll_cfa), 75)

	ls_phone = Left(of_get_answer(651, ll_cfa), 25)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	If lb_update Then
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, comments, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'Application Record for GIGP' + :ls_gigp,'SYSTEM', getdate(), :ls_lon, :ls_lat);
	End If

	If lb_update Then
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_applicant, :ll_gigpID, 'APP');
	End If
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
			
			If lb_update Then
				insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
				values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			End If
			
		End If
		
		If lb_update Then
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			Values (:ll_other, :ll_gigpID, 'OTH');
		End If
		
	End If
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
			
			If lb_update Then
				insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
				values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			End If
			
		End If
		
		If lb_update Then
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			Values (:ll_other, :ll_gigpID, 'PRC');
		End If
		
	End If
	
	
	//Add EFC Contacts
	If lb_update Then
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		values (:ll_eng, :ll_gigpID, 'EFCENG');
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		values (:ll_coordinator, :ll_gigpID, 'EPGASSIGN');
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		values (:ll_paralegal, :ll_gigpID, 'EFCPARALGL');
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		values (:ll_legal, :ll_gigpID, 'EFCLGL');
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		values (:ll_deceng, :ll_gigpID, 'EFCDECENG');
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		values (:ll_leadreviewer, :ll_gigpID, 'EFCLEADREV');
		
	End If
	
	of_add_log('Done adding Contacts')
	
	
	//AMOUNTS
	ll_id = f_gettokenvalue('amountID', 1)
	
	If lb_update Then
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_requested, :ld_grant, 'SYSTEM', getdate());
	End If
	
	//Project Types
	ls_typearray[] = ls_null[]
	
	ln_string.of_parsetoarray(ls_projecttypes, ',', ls_typearray)
	
	li_upperbound = UpperBound(ls_typearray)
	
	If li_upperbound > 0 Then
		For li_index = 1 to li_upperbound
			ls_type = Trim(ls_typearray[li_index])
			
			select ref_code
			into :ls_typecode
			from gigp_reference
			where category = 'ProjectType'
			and Convert(varchar(200), description) = :ls_type;
			
			If IsNull(ls_typecode) Then ls_typecode = 'Could not find code for ' + ls_type
			
			of_add_log('Adding GIGP# ' + String(ll_gigpID) + '  /  Project Type:  '+ ls_typecode)
			
			If lb_update Then
				insert into gigp_project_types (gigp_id, project_type)
				values (:ll_gigpID, :ls_typecode);		//*********UPDATED 1/4/2023 FOR NEXT ROUND!!!!
			End If
			
			SetNull(ls_typecode)
			
		Next
		
	End If

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_130 from commandbutton within w_util
integer x = 128
integer y = 1180
integer width = 361
integer height = 100
integer taborder = 300
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2022 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\EPG (Engineering Planning Grant)\Round 2022\Load2022.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
Next

of_add_log('Done')
end event

type cb_129 from commandbutton within w_util
integer x = 1888
integer y = 1076
integer width = 361
integer height = 100
integer taborder = 300
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "14 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\GIGP\Round 14\Load14_2022.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
Next

of_add_log('Done')
end event

type cb_128 from commandbutton within w_util
integer x = 2327
integer y = 1076
integer width = 361
integer height = 100
integer taborder = 360
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "14 Load"
end type

event clicked;integer li_district, li_checklist, li_pop, li_programId
long ll_eng, ll_coordinator, ll_assist, ll_id, ll_comma, ll_mwbe, ll_tech_lead
decimal ld_requested, ld_grant, ld_totalcost, ld_eligiblepct, ld_recommended
datetime ldt_responseletterdate, ldt_targetdateforga, ldt_anticipatedcompletion, ldt_accepted
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret, ll_awarded_count
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible, ls_eng
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop, ls_projname, ls_projstatus, ls_projdesc, ls_location, ls_project_no
string ls_muni_name, ls_muni_type, ls_municode, ls_proj_stat_comment
string ls_agency, ls_spdes, ls_consent, ls_projtype, ls_program, ls_grant_type
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string
boolean lb_update = False

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

//Retrieve projects
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_r14'
lds_apps.SetTransObject(SQLCA)
ll_count = lds_apps.Retrieve()

If MessageBox('Applications Found', String(ll_count) + ' applications found. Continue with load?', Question!, YesNo!, 2) = 2 Then
	Return
End If

If MessageBox('UPDATES?', 'Update database during load?', Question!, YesNo!, 1) = 1 Then
	lb_update = True
Else
	lb_update = False
End If

of_add_log(String(ll_count) + ' awarded records found.')


ii_round = 14
idt_app = DateTime(Date('7/29/2022'))

For ll_row = 1 to ll_count
	
	ll_coordinator = lds_apps.GetItemNumber(ll_row,'coordinator')
	ll_mwbe = lds_apps.GetItemNumber(ll_row,'mwbe')	//contact_type = 'MWO'
	ll_tech_lead = lds_apps.GetItemNumber(ll_row,'tech_lead')
	
	ll_cfa = lds_apps.GetItemNumber(ll_row,'cfa_no')
	ls_redc = lds_apps.GetItemString(ll_row, 'redc_region')
	ls_applicant = lds_apps.GetItemString(ll_row,'applicant')
	ls_projname = lds_apps.GetItemString(ll_row, 'project_name')
	ls_projdesc = lds_apps.GetItemString(ll_row,'project_description')
	ls_program = 'GIGP'
	ls_grant_type = 'Construction'
	ll_gigpID =	lds_apps.GetItemNumber(ll_row,'gigp_id')
	li_programId = lds_apps.GetItemNumber(ll_row,'program_id')
	ls_project_no = lds_apps.GetItemString(ll_row, 'project_no')
	
	ld_requested = lds_apps.GetItemDecimal(ll_row,'funding_requested')
	ld_grant = lds_apps.GetItemDecimal(ll_row,'funding_recommended')

	ld_eligiblepct = lds_apps.GetItemDecimal(ll_row,'eligible_pct')		//??????
		
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	ls_projstatus = 'projectActive'

	If lb_update Then
		insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, app_recvd_dt, app_status, funding_recommendation, reviewing_agency, county_fips_code, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, redc_region, project_pct_complete)
		values (:ll_gigpID, :ii_round, :ls_program, :ls_projname, :ls_projstatus, 'CW', :ls_grant_type, :ld_eligiblepct, null, :idt_app, :ls_appStatus, :ls_funding_rec, 'EFC', :ls_fips, 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, :ls_redc, 0);
	End if
	
	of_add_log('Application added for ' + ls_applicant)
	
	//Create CFA Items
	If lb_update Then
		insert into gigp_cfa_items(gigp_id, grant_status, project_status, project_status_comment, last_updated_dt, last_updated_by)
		values (:ll_gigpID, 'statusPending', 'statusGreen', :ls_proj_stat_comment, getdate(), 'SYSTEM');
	End If
	
	of_add_log('CFA Items added for ' + ls_applicant)
		

	//Create Summaries
	If lb_update Then
		of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
		
		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
		values (:ll_gigpID, :idt_app, 'appNote', 'projDescription', 'SYSTEM', :ls_projdesc);
	End If
	
	//Create Metrics
	If ls_program = 'GIGP' and lb_update = True Then
		of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
		of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
		of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
		of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')
	End If
	
	//Insert checklist item for Project Required by MS 4...
	If lb_update Then
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
	End If
		
	
	//Insert Project Location Record (then link political districts to it)
	ls_addr = Left(of_get_answer(928, ll_cfa), 50)
	ls_city = Left(of_get_answer(565, ll_cfa), 30)
	ls_state = Left(of_get_answer(568, ll_cfa), 2)
	ls_zip = Left(of_get_answer(1034, ll_cfa), 10)
	
	ls_lon = Left(of_get_answer(573, ll_cfa), 40)
	ls_lat = Left(of_get_answer(572, ll_cfa), 40)

	ls_phone = Left(of_get_answer(651, ll_cfa), 25)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	

	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_location = 'Project location record for GIGP ' + String(ll_gigpID)
	
	If lb_update Then
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_location, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_plc, :ll_gigpID, 'PLC');
	End If
		
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				If lb_update Then
					insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
					values(:ll_plc, 'nysSenate', :li_district, 2010);
				End If
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
			End If
			
			
		Else
			li_district = Integer(ls_senate)
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
			End If
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				If lb_update Then
					insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
					values(:ll_plc, 'nysAssembly', :li_district, 2010);
				End If
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
			End If
			
			
		Else
			li_district = Integer(ls_assembly)
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
			End If
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	
	/*********************************************************
	FIGURE OUT BETTER WAY TO GET APPLICANT WITH OTHER FIELDS BLANK
	********************************************************/
//	select max(contact_id)
//	into :ll_applicant
//	from gigp_contacts
//	where Upper(organization) = Upper(:ls_applicant);
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		
		ls_addr = Left(of_get_answer(551, ll_cfa), 50)
		ls_city = Left(of_get_answer(565, ll_cfa), 30)
		ls_state = Left(of_get_answer(553, ll_cfa), 2)
		ls_zip = Left(of_get_answer(554, ll_cfa), 10)
		ls_email = Left(of_get_answer(555, ll_cfa), 75)

		ls_phone = Left(of_get_answer(651, ll_cfa), 25)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
		If lb_update Then
			insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
			values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		End If
		
	End if
	
	If lb_update Then
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_applicant, :ll_gigpID, 'APP');
	End If
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
			
			If lb_update Then
				insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
				values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			End If
			
		End If
		
		If lb_update Then
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			Values (:ll_other, :ll_gigpID, 'OTH');
		End If
		
	End If
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
			
			If lb_update Then
				insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
				values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			End If
			
		End If
		
		If lb_update Then
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			Values (:ll_other, :ll_gigpID, 'PRC');
		End If
		
	End If
	
	//AMOUNTS
	ll_id = f_gettokenvalue('amountID', 1)
	
	If lb_update Then
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', :ld_requested, :ld_grant, 'SYSTEM', getdate());
	End If
	
	//Staf contacts ********************************
	
	//Coordinator
	If lb_update Then
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_coordinator, :ll_gigpID, 'EFCPROJCOORD');
	End If
	
	//MWBE
	If lb_update Then
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_mwbe, :ll_gigpID, 'MWO');
	End If
	
	//Tech Lead
	If lb_update Then
		If ll_tech_lead = 2506 Then	//Gyory
			ls_type = 'EFCLANDARCH'
		Else	//9052	Lennox
			ls_type = 'EFCENG'
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_tech_lead, :ll_gigpID, :ls_type);
			
	End If
	

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_127 from commandbutton within w_util
integer x = 1449
integer y = 1076
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "App Score"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_value, ls_projno, ls_projname, ls_apptype, ls_project, ls_category, ls_type
string ls_wwtp1, ls_wwtp2, ls_wwtp3, ls_collection1, ls_collection2, ls_collection3, ls_manholes, ls_cipp, ls_sewerrehab, ls_septics, ls_sansewer, ls_storm, ls_meters, ls_capacity
long ll_ret, ll_row, ll_cfa, ll_efc, ll_dec, ll_addldec, ll_lead, ll_gigp, ll_projectid, ll_phaseId, ll_count, ll_applicationid
integer li_score
decimal ld_value, ld_null
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select ApplicationId, Score from Application where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\Hub\MiscTasks\CWIIA Scores Load.txt')

If MessageBox('Data import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

If ll_ret > 0 Then
	For ll_row = 1 to ll_ret
		ll_applicationid = lds_data.GetItemNumber(ll_row, 'applicationid')
		li_score = lds_data.GetItemNumber(ll_row, 'Score')
		
		of_add_log('Application Score for ApplicationId = ' + String(ll_applicationid) + ' is ' + String(li_score))
		
		update Application
		set Score = :li_score
		where ApplicationId = :ll_applicationid;

		
	Next
	
End If

of_add_log('Done')
end event

type cb_126 from commandbutton within w_util
integer x = 1015
integer y = 1072
integer width = 361
integer height = 100
integer taborder = 260
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Metrics"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_value, ls_projno, ls_projname, ls_apptype, ls_project, ls_category, ls_type
string ls_wwtp1, ls_wwtp2, ls_wwtp3, ls_collection1, ls_collection2, ls_collection3, ls_manholes, ls_cipp, ls_sewerrehab, ls_septics, ls_sansewer, ls_storm, ls_meters, ls_capacity
long ll_ret, ll_row, ll_cfa, ll_efc, ll_dec, ll_addldec, ll_lead, ll_gigp, ll_projectid, ll_phaseId, ll_count
decimal ld_value, ld_null
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select ProjectNumber, Status as capacity, Status as wwtp1, Status as wwtp2, Status as wwtp3, Status as collection1, Status as collection2, Status as collection3, Status as manholes, Status as cipp, Status as sewerrehab, Status as septics, Status as sansewer, Status as storm, Status as meters from ProjectPhase where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\Hub\MetricTracking\Conversion.txt')

SetNull(ld_null)

If MessageBox('Data import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

If ll_ret > 0 Then
	For ll_row = 1 to ll_ret
		ls_projno = lds_data.GetItemString(ll_row,'ProjectNumber')
		
		If ls_projno = '6680-04-00' Then
			ls_projno = ls_projno
		End If
		
		select max(projectphaseid)
		into :ll_phaseId
		from ProjectPhase
		where ProjectNumber = :ls_projno;
		
		If ll_phaseId > 0 Then
			ls_capacity =  lds_data.GetItemString(ll_row, 'capacity')
			ls_wwtp1 = lds_data.GetItemString(ll_row, 'wwtp1')
			ls_wwtp2 = lds_data.GetItemString(ll_row, 'wwtp2')
			ls_wwtp3 = lds_data.GetItemString(ll_row, 'wwtp3')
			ls_collection1 = lds_data.GetItemString(ll_row, 'collection1')
			ls_collection2 = lds_data.GetItemString(ll_row, 'collection2')
			ls_collection3 = lds_data.GetItemString(ll_row, 'collection3')
			ls_manholes = lds_data.GetItemString(ll_row, 'manholes')
			ls_cipp = lds_data.GetItemString(ll_row, 'cipp')
			ls_sewerrehab = lds_data.GetItemString(ll_row, 'sewerrehab')
			ls_septics = lds_data.GetItemString(ll_row, 'septics')
			ls_sansewer = lds_data.GetItemString(ll_row, 'sansewer')
			ls_storm = lds_data.GetItemString(ll_row, 'storm')
			ls_meters = lds_data.GetItemString(ll_row, 'meters')
			
			If ls_capacity > '' Then
				If IsNumber(ls_capacity) Then
					ld_value = Dec(ls_capacity)
					of_insertmetric(ll_phaseid, 'WWTP Capacity', 'Capacity Value', ld_value)
				End If
			End If
			
			If ls_wwtp1 > '' Then
				of_insertmetric(ll_phaseid, 'WWTP Improvements', ls_wwtp1, ld_null)
			End If
			If ls_wwtp2 > '' Then
				of_insertmetric(ll_phaseid, 'WWTP Improvements', ls_wwtp2, ld_null)
			End If
			If ls_wwtp3 > '' Then
				of_insertmetric(ll_phaseid, 'WWTP Improvements', ls_wwtp3, ld_null)
			End If
			
			If ls_collection1 > '' Then
				of_insertmetric(ll_phaseid, 'Collection System Improvements', ls_collection1, ld_null)
			End If
			If ls_collection2 > '' Then
				of_insertmetric(ll_phaseid, 'Collection System Improvements', ls_collection2, ld_null)
			End If
			If ls_collection3 > '' Then
				of_insertmetric(ll_phaseid, 'Collection System Improvements', ls_collection3, ld_null)
			End If
			
			If ls_manholes > '' Then
				If IsNumber(ls_manholes) Then
					ld_value = Dec(ls_manholes)
					of_insertmetric(ll_phaseid, 'Infrastructure Installed', 'Manholes Replaced/Rehabilitation', ld_value)
				End If
			End If
			
			If ls_cipp > '' Then
				If IsNumber(ls_cipp) Then
					ld_value = Dec(ls_cipp)
					of_insertmetric(ll_phaseid, 'Infrastructure Installed', 'Sewers Lined', ld_value)
				End If
			End If
			
			If ls_sewerrehab > '' Then
				If IsNumber(ls_sewerrehab) Then
					ld_value = Dec(ls_sewerrehab)
					of_insertmetric(ll_phaseid, 'Infrastructure Installed', 'Sewer Rehabilitation', ld_value)
				End If
			End If
			
			If ls_septics > '' Then
				If IsNumber(ls_septics) Then
					ld_value = Dec(ls_septics)
					of_insertmetric(ll_phaseid, 'Infrastructure Installed', 'Septic Systems Taken Out of Service (EDUs served)', ld_value)
				End If
			End If
			
			If ls_sansewer > '' Then
				If IsNumber(ls_sansewer) Then
					ld_value = Dec(ls_sansewer)
					of_insertmetric(ll_phaseid, 'Infrastructure Installed', 'San. Sewer Installed (New and Existing)', ld_value)
				End If
			End If
			
			If ls_storm > '' Then
				If IsNumber(ls_storm) Then
					ld_value = Dec(ls_storm)
					of_insertmetric(ll_phaseid, 'Infrastructure Installed', 'New Storm Sewer Installed', ld_value)
				End If
			End If
			
			If ls_meters > '' Then
				If IsNumber(ls_meters) Then
					ld_value = Dec(ls_meters)
					of_insertmetric(ll_phaseid, 'Infrastructure Installed', 'Water Meters Installed', ld_value)
				End If
			End If
			
			
		Else
			
			of_add_log('No project found for ' + String(ll_phaseid))
			
		End If
		
		of_add_log('Metrics for ' + ls_projno + ' added.')
		
	Next
	
End If

of_add_log('Done')
end event

type cb_125 from commandbutton within w_util
integer x = 571
integer y = 1072
integer width = 361
integer height = 100
integer taborder = 310
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "EJ Tags"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_value, ls_projno, ls_projname, ls_apptype, ls_project
long ll_ret, ll_row, ll_cfa, ll_efc, ll_dec, ll_addldec, ll_lead, ll_gigp, ll_projectid, ll_phaseId, ll_count
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select ProjectPhaseId from ProjectPhase where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\Hub\IUP2023\EJTags.txt')

If MessageBox('Data import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

If ll_ret > 0 Then
	For ll_row = 1 to ll_ret
		ll_phaseId = lds_data.GetItemNumber(ll_row, 'ProjectPhaseId')
		
		select max(projectid)
		into :ll_projectid
		from ProjectPhase
		where ProjectPhaseId = :ll_phaseid;
		
		If ll_projectid > 0 Then
			select count(*)
			into :ll_count
			from EfcTag
			where KeyField = 'ProjectId'
			and KeyId = :ll_projectid
			and TagValue = 'Environmental Justice Area';
			
			If ll_count > 0 Then
				of_add_log('Tag already created for ProjectId ' + String(ll_projectid))
				
			Else
				insert into EfcTag (Module, KeyField, KeyId, TagValue, LastUpdatedBy, LastUpdatedDate)
				values ('SRF Project', 'ProjectId', :ll_projectid, 'Environmental Justice Area', 'SYSTEM', getdate());
			
				of_add_log('Tag added for ProjectId = ' + String(ll_projectid))
				
			End If
			
		Else
			
			of_add_log('No project found for ' + String(ll_phaseid))
			
		End If
		
	Next
	
End If

of_add_log('Done')
end event

type cb_124 from commandbutton within w_util
integer x = 133
integer y = 1072
integer width = 361
integer height = 100
integer taborder = 250
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Upd EPG Con"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_value, ls_projno, ls_projname, ls_apptype, ls_applicant
long ll_ret, ll_row, ll_cfa, ll_efc, ll_dec, ll_addldec, ll_lead, ll_gigp
n_ds lds_data

//ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, customerid as EfcEngineer, customerid as DecEngineer, customerid as AddlDecEngineer, customerid as LeadReviewer from gigp_application where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, customerid as EFCENG, customerid as EFCDECENG, customerid as EFCLEADREV from gigp_application where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\ContactsFix\PriorRoundStaffUpdates.txt')

//cfa_no	EFCENG	EFCDECENG	EFCLEADREV

If MessageBox('Data import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

If ll_ret > 0 Then
	For ll_row = 1 to ll_ret
		ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
		ll_efc = lds_data.GetItemNumber(ll_row, 'EFCENG')
		ll_dec = lds_data.GetItemNumber(ll_row, 'EFCDECENG')
		ll_lead = lds_data.GetItemNumber(ll_row, 'EFCLEADREV')
		
		If ll_cfa > 0 Then
			select gigp_id
			into :ll_gigp
			from gigp_application
			where cfa_no = :ll_cfa;
			
			If ll_gigp > 0 Then
				
				//Delete and insert EFC Engineer
				delete gigp_contact_links
				where gigp_id = :ll_gigp
				and contact_type = 'EFCENG';
				
				insert into gigp_contact_links(gigp_id, contact_id, contact_type)
				values (:ll_gigp, :ll_efc, 'EFCENG');
				
				//Delete and insert DEC Engineer
				If ll_dec > 0 Then
					delete gigp_contact_links
					where gigp_id = :ll_gigp
					and contact_type = 'EFCDECENG';
				
					insert into gigp_contact_links(gigp_id, contact_id, contact_type)
					values (:ll_gigp, :ll_dec, 'EFCDECENG');
				End If
				
				//Delete and insert Lead Reviewer
				If ll_lead > 0 Then
					delete gigp_contact_links
					where gigp_id = :ll_gigp
					and contact_type = 'EFCLEADREV';
					
					insert into gigp_contact_links(gigp_id, contact_id, contact_type)
					values (:ll_gigp, :ll_lead, 'EFCLEADREV');
				End If
				
				of_add_log('CFA: ' + String(ll_cfa) + ' / EFC: ' + String(ll_efc) + ' / DEC: ' + String(ll_dec) + ' / AddlDec: ' + String(ll_addldec) + ' / Lead: ' + String(ll_lead))
				
			End If
			
		End If
		
	Next
	
End If

of_add_log('Done')
end event

type cb_123 from commandbutton within w_util
integer x = 2327
integer y = 968
integer width = 361
integer height = 100
integer taborder = 250
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Septic Disb"
end type

event clicked;long ll_gigpId, ll_row, ll_count, ll_county_count, ll_county_row, ll_request_count, ll_request_row, ll_disbid, ll_disburseamtid, ll_contract
string ls_county, ls_project
integer li_request
decimal ld_amount, ld_releasedamount, ld_release_amt, ld_total_cost, ld_allocation
datetime ldt_received, ldt_wiredate, ldt_date_received
n_ds lds_counties, lds_requests, lds_detail, lds_data

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

If NOT IsValid(lds_counties) Then lds_counties = CREATE n_ds
If NOT IsValid(lds_requests) Then lds_requests = CREATE n_ds
If NOT IsValid(lds_detail) Then lds_detail = CREATE n_ds

lds_counties.DataObject = 'd_septic_disbursement_counties'
lds_requests.DataObject = 'd_septic_disbursement_requests'
lds_detail.DataObject = 'd_septic_disbursement_detail'

lds_counties.SetTransObject(SQLCA)
lds_requests.SetTransObject(SQLCA)
lds_detail.SetTransObject(SQLCA)

ll_county_count = lds_counties.Retrieve()

If MessageBox('Data import', String(ll_county_count) + ' counties found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

//Delete current Professional contracts for Septic because will create them here
delete gigp_professional_contracts
where gigp_id in (select gigp_id from gigp_application where program = 'Septic');


If ll_county_count > 0 Then
	For ll_county_row = 1 to ll_county_count
		ls_county = lds_counties.GetItemString(ll_county_row, 'county')
		
		If ls_county > '' Then
			
			SetNull(ll_gigpid)
		
			//Get GIGP Id
			select a.gigp_id
			into :ll_gigpid
			from gigp_application a, gigp_reference r
			where a.program = 'Septic'
			and a.county_fips_code = r.ref_code
			and r.category = 'County'
			and r.ref_value = :ls_county;
			
			If IsNull(ll_gigpid) Then Continue
			If ll_gigpid <= 0 Then Continue
			
			//Create Professional Contract
			select allocation
			into :ld_allocation
			from septicallocation
			where county = :ls_county;
			
			ll_contract = f_gettokenvalue('professContractID', 1)
			
			INSERT INTO gigp_professional_contracts
				(profess_contract_id
				,amended_id
				,gigp_id
				,contact_id
				,contract_no
				,contract_amt
				,eligible_amt
				,contract_dt
				,contract_type
				,contract_status
				,amend_flag
				,mwbe_review_flag
				,lobby_hold_flag
				,lobby_cert_recd_flag
				,comments
				,up_approval_dt
				,approval_dt
				,issue_notice_award_dt
				,issue_notice_proceed_dt
				,received_dt
				,last_updated_dt
				,last_updated_by
				,aecert_hold_flag
				,aecert_recd_flag
				,ContractorId)
			VALUES
				(:ll_contract
				,0
				,:ll_gigpid
				,9839
				,null
				,:ld_allocation
				,:ld_allocation
				,'3/1/2018'
				,'Small Grants Vendor'
				,'ACTIVE'
				,0
				,0
				,0
				,0
				,'Septic spreadsheet load'
				,null
				,null
				,null
				,null
				,null
				,getdate()
				,'system'
				,0
				,0
				,null);
				
			If SQLCA.SQLCode <> 0 Then 
				of_add_log('Error inserting Professional Contract for ' + ls_county)
				of_add_log('		' + sqlca.SQLERRText)
			End If
			
			
			//Retrieve Requests for that County
			ll_request_count = lds_requests.Retrieve(ls_county)
			
			If ll_request_count > 0 then
				For ll_request_row = 1 to ll_request_count
					li_request = lds_requests.GetItemNumber(ll_request_row, 'request_no')
					
					//Get Date Received
					select min(date_received)
					into :ldt_received
					from septicdisb
					where county = :ls_county
					and request_no = :li_request;
					
					//Get wire date
					select min(wire_date)
					into :ldt_wiredate
					from septicdisb
					where county = :ls_county
					and request_no = :li_request;
					
					//Get total released
					select sum(release_amt)
					into :ld_releasedamount
					from septicdisb
					where county = :ls_county
					and request_no = :li_request;
					
					//Get new disbursement id
					ll_disbid = f_gettokenvalue('disburseID', 1)
					
					//Insert Request
					INSERT INTO gigp_disbursement_request
							(disbursement_id,
							gigp_id,
							request_no,
							received_dt,
							documents_complete_dt,
							to_accting_dt,
							finance_approval_dt,
							release_no,
							release_amt,
							release_dt,
							lock_flag,
							comments,
							last_updated_dt,
							last_updated_by,
							federal_amt,
							state_amt,
							override_state_federal_split)
					VALUES
							(:ll_disbid,
							:ll_gigpid,
							:li_request,
							:ldt_received,
							null,
							null,
							null,
							null,
							:ld_releasedamount,
							:ldt_wiredate,
							0,
							'Septic spreadsheet load',
							getdate(),
							'system',
							null,
							null,
							0);
							
						If SQLCA.SQLCode <> 0 Then
							of_add_log('Error inserting Disbursement Request for ' + ls_county + ' Request# ' + String(li_request))
							of_add_log('		' + sqlca.SQLERRText)
						End If

					
					If li_request > 0 Then
						ll_count = lds_detail.Retrieve(ls_county, li_request)
						
						If ll_count > 0 Then
							For ll_row = 1 to ll_count
								ll_disburseamtid = f_gettokenvalue('disburseAmtID', 1)
								ld_total_cost = lds_detail.GetItemDecimal(ll_row, 'total_cost')
								ld_release_amt = lds_detail.GetItemDecimal(ll_row, 'release_amt')
								ldt_date_received = lds_detail.GetItemDateTime(ll_row, 'date_received')
								ls_project = lds_detail.GetItemString(ll_row, 'project')

								INSERT INTO gigp_disbursement_amount
											  (disbursement_amt_id
												,disbursement_id
												,gigp_id
												,transaction_type
												,cost_category
												,professional_contract_id
												,adj_disbursement_amt_id
												,requested_amt
												,ineligible_amt
												,withheld_amt
												,netrequest_amt
												,eligible_amt
												,retained_amt
												,disbursed_amt
												,invoice_no
												,invoice_dt
												,comments
												,proofof_pmt_flag
												,retainage_pd_flag
												,last_updated_dt
												,last_updated_by)
									  VALUES
											  (:ll_disburseamtid
												,:ll_disbid
												,:ll_gigpid
												,'DISBURSE'
												,'Small Grants Vendor'
												,:ll_contract
												,null
												,:ld_total_cost
												,0
												,0
												,:ld_total_cost
												,:ld_release_amt
												,0
												,:ld_release_amt
												,null
												,:ldt_date_received
												,:ls_project
												,1
												,1
												,getdate()
												,'system');
												
										If SQLCA.SQLCode <> 0 Then
											of_add_log('Error inserting Disbursement Amount for ' + ls_county + ' Request# ' + String(li_request) + ' line item# ' + String(ll_row))
											of_add_log('		' + sqlca.SQLERRText)
										End If

								
							Next
						End If
					End If
				Next
			End If
		End If
	Next
End If

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

end event

type cb_122 from commandbutton within w_util
integer x = 1015
integer y = 968
integer width = 361
integer height = 100
integer taborder = 300
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Target Dts"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_value, ls_projno, ls_projname, ls_apptype, ls_applicant
string ls_muni, ls_consent, ls_muniname, ls_munitype, ls_municode, ls_dec
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id, ll_eng, ll_paralegal, ll_legal, ll_coordinator, ll_assembly, ll_senate, ll_congress, ll_place
decimal ld_tpc, ld_requested, ld_award, ld_local
decimal ld_fundreq, ld_recfund, ld_eligible, ld_req, ld_app
string ls_reviewagency, ls_reviewer, ls_projtypes, ls_efcdesc, ls_appdesc, ls_typecode
string ls_types[]
decimal ld_lat, ld_long
long ll_upper, ll_index
datetime ldt_awardaccepted, ldt_date
n_ds lds_data
n_cst_string ln_string

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, ready_to_target_dt from gigp_application where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'C:\temp\TargetDates.txt')

If MessageBox('Data import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If


For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')	
	ldt_date = lds_data.GetItemDateTime(ll_row, 'ready_to_target_dt')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	update gigp_application
	set ready_to_target = 1,
		ready_to_target_dt = getdate(),
		ready_to_target_by = 'system'
	where cfa_no = :ll_cfa;
	
	insert into gigp_key_dates(gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
	values (:ll_gigp, 'agreeGRANTCMTDATE', :ldt_date, 'system', getdate());

	

Next

of_add_log('Done')
end event

type cb_121 from commandbutton within w_util
integer x = 571
integer y = 968
integer width = 361
integer height = 100
integer taborder = 360
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "REDI Contrs"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_value, ls_projno, ls_projname, ls_apptype, ls_applicant, ls_coordinator, ls_techlead, ls_engineer, ls_mwbe
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id
decimal ld_tpc, ld_requested, ld_award, ld_local, ld_amt
decimal ld_fundreq, ld_recfund, ld_eligible, ld_req, ld_app
n_ds lds_data

ii_round = 8

//ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_application where round_no = 102', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL("select gigp_id from gigp_application where program = 'REDI' and gigp_id <> 1849", 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret

	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	//Get total amount
	select sum(approved_amt)
	into :ld_amt
	from gigp_amounts
	where gigp_id = :ll_gigp;
	
	ld_amt = Round(ld_amt / 4, 2)
	
	//Insert Vendors
	insert into gigp_contact_links(contact_id, gigp_id, contact_type)
	select contact_id, :ll_gigp, 'VEND'
	from gigp_contact_links
	where contact_id in (10758,10759,10760,10761)
	and gigp_id = 1849;
	
	//Insert Contracts
	ll_id = f_gettokenvalue('professContractID', 1)
	
	INSERT INTO gigp_professional_contracts (profess_contract_id,amended_id,gigp_id,contact_id,contract_no,contract_amt,eligible_amt,contract_dt,contract_type,contract_status,amend_flag,mwbe_review_flag,lobby_hold_flag,lobby_cert_recd_flag,comments,up_approval_dt,approval_dt,issue_notice_award_dt,issue_notice_proceed_dt,received_dt,last_updated_dt,last_updated_by,aecert_hold_flag,aecert_recd_flag)
	select :ll_id,0,:ll_gigp,contact_id,contract_no,contract_amt,:ld_amt,contract_dt,contract_type,contract_status,amend_flag,mwbe_review_flag,lobby_hold_flag,lobby_cert_recd_flag,comments,up_approval_dt,approval_dt,issue_notice_award_dt,issue_notice_proceed_dt,received_dt,getdate(),'SYSTEM',aecert_hold_flag,aecert_recd_flag
	from gigp_professional_contracts
	where gigp_id = 1849
	and contract_type = 'REDI Vendor - Construction';
	
	update gigp_professional_contracts
	set eligible_amt = 0, contract_amt = 0
	where gigp_id = :ll_gigp
	and contract_type = 'REDI Vendor';
	
	
	ll_id = f_gettokenvalue('professContractID', 1)
	
	INSERT INTO gigp_professional_contracts (profess_contract_id,amended_id,gigp_id,contact_id,contract_no,contract_amt,eligible_amt,contract_dt,contract_type,contract_status,amend_flag,mwbe_review_flag,lobby_hold_flag,lobby_cert_recd_flag,comments,up_approval_dt,approval_dt,issue_notice_award_dt,issue_notice_proceed_dt,received_dt,last_updated_dt,last_updated_by,aecert_hold_flag,aecert_recd_flag)
	select :ll_id,0,:ll_gigp,contact_id,contract_no,contract_amt,:ld_amt,contract_dt,contract_type,contract_status,amend_flag,mwbe_review_flag,lobby_hold_flag,lobby_cert_recd_flag,comments,up_approval_dt,approval_dt,issue_notice_award_dt,issue_notice_proceed_dt,received_dt,getdate(),'SYSTEM',aecert_hold_flag,aecert_recd_flag
	from gigp_professional_contracts
	where gigp_id = 1849
	and contract_type = 'REDI Vendor - Engineering';
	
	update gigp_professional_contracts
	set eligible_amt = 0, contract_amt = 0
	where gigp_id = :ll_gigp
	and contract_type = 'REDI Vendor';
	
	
	ll_id = f_gettokenvalue('professContractID', 1)
	
	INSERT INTO gigp_professional_contracts (profess_contract_id,amended_id,gigp_id,contact_id,contract_no,contract_amt,eligible_amt,contract_dt,contract_type,contract_status,amend_flag,mwbe_review_flag,lobby_hold_flag,lobby_cert_recd_flag,comments,up_approval_dt,approval_dt,issue_notice_award_dt,issue_notice_proceed_dt,received_dt,last_updated_dt,last_updated_by,aecert_hold_flag,aecert_recd_flag)
	select :ll_id,0,:ll_gigp,contact_id,contract_no,contract_amt,:ld_amt,contract_dt,contract_type,contract_status,amend_flag,mwbe_review_flag,lobby_hold_flag,lobby_cert_recd_flag,comments,up_approval_dt,approval_dt,issue_notice_award_dt,issue_notice_proceed_dt,received_dt,getdate(),'SYSTEM',aecert_hold_flag,aecert_recd_flag
	from gigp_professional_contracts
	where gigp_id = 1849
	and contract_type = 'REDI Vendor - Legal';
	
	update gigp_professional_contracts
	set eligible_amt = 0, contract_amt = 0
	where gigp_id = :ll_gigp
	and contract_type = 'REDI Vendor';
	
	
	ll_id = f_gettokenvalue('professContractID', 1)
	
	INSERT INTO gigp_professional_contracts (profess_contract_id,amended_id,gigp_id,contact_id,contract_no,contract_amt,eligible_amt,contract_dt,contract_type,contract_status,amend_flag,mwbe_review_flag,lobby_hold_flag,lobby_cert_recd_flag,comments,up_approval_dt,approval_dt,issue_notice_award_dt,issue_notice_proceed_dt,received_dt,last_updated_dt,last_updated_by,aecert_hold_flag,aecert_recd_flag)
	select :ll_id,0,:ll_gigp,contact_id,contract_no,contract_amt,:ld_amt,contract_dt,contract_type,contract_status,amend_flag,mwbe_review_flag,lobby_hold_flag,lobby_cert_recd_flag,comments,up_approval_dt,approval_dt,issue_notice_award_dt,issue_notice_proceed_dt,received_dt,getdate(),'SYSTEM',aecert_hold_flag,aecert_recd_flag
	from gigp_professional_contracts
	where gigp_id = 1849
	and contract_type = 'REDI Vendor - Miscellaneous';
	
	update gigp_professional_contracts
	set eligible_amt = 0, contract_amt = 0
	where gigp_id = :ll_gigp
	and contract_type = 'REDI Vendor';
	
	
Next

of_add_log('Done')
end event

type cb_120 from commandbutton within w_util
integer x = 133
integer y = 968
integer width = 361
integer height = 100
integer taborder = 300
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "JSON"
end type

event clicked;string ls_first, ls_last
integer li_age
JsonPackage lj_data

lj_data = of_getjsondatda()

ls_first = lj_data.GetValueString ("FirstName")
ls_last =  lj_data.GetValueString ("LastName")
li_age = lj_data.GetValueNumber("Age")

messagebox('First', ls_first)
messagebox('Last', ls_last)
messagebox('Age', li_age)


end event

type cb_119 from commandbutton within w_util
integer x = 2327
integer y = 860
integer width = 361
integer height = 100
integer taborder = 310
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Pattern Match"
end type

event clicked;string ls_entry

ls_entry = sle_entry.Text

If Match(ls_entry, '[0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9][0-9][0-9]') OR Match(ls_entry, '[0-9][0-9]-[0-9][0-9][0-9][0-9][0-9][0-9][0-9]') Then
	MessageBox('Pattern Match', 'Valid SSN')
Else
	MessageBox('Invalid', 'NOT a valid SSN')
End If
end event

type cb_118 from commandbutton within w_util
integer x = 1888
integer y = 860
integer width = 361
integer height = 100
integer taborder = 350
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2021 Updates"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_value, ls_projno, ls_projname, ls_apptype, ls_applicant
string ls_muni, ls_consent, ls_muniname, ls_munitype, ls_municode, ls_dec
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id, ll_eng, ll_paralegal, ll_legal, ll_coordinator, ll_assembly, ll_senate, ll_congress, ll_place
decimal ld_tpc, ld_requested, ld_award, ld_local
decimal ld_fundreq, ld_recfund, ld_eligible, ld_req, ld_app
string ls_reviewagency, ls_reviewer, ls_projtypes, ls_efcdesc, ls_appdesc, ls_typecode
string ls_types[]
decimal ld_lat, ld_long
long ll_upper, ll_index
datetime ldt_awardaccepted
n_ds lds_data
n_cst_string ln_string

ii_round = 8

//ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_application where round_no = 102', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL("select cfa_no, project_name 'applicant', project_name 'municipality', dec_region, cfa_no 'engineer', cfa_no 'paralegal', cfa_no 'legal', cfa_no 'coordinator', cfa_no 'grantamt', project_name, consent_order, reviewing_agency, project_name 'reviewer', project_name 'awardaccepted', space(1000) 'projectypes', cfa_no 'assembly', cfa_no 'senate', cfa_no 'congress', space(500) 'latitude', space(500) 'longitude', space(1000) 'efcdesc', space(1500) 'appdesc' from gigp_application where 1=2", 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\EPG (Engineering Planning Grant)\Round 2021\EPG2021Updates.txt')

If MessageBox('Data import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

//ALREADY DONE*************************************
//insert into gigp_key_dates(gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
//select gigp_id, 'agreeCOMLTRSEN', '12/14/2021', 'SYSTEM', getdate()
//from gigp_application
//where round_no = 2021;
//
//insert into gigp_key_dates(gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
//select gigp_id, 'epgTARGETDATE', '10/31/2022', 'SYSTEM', getdate()
//from gigp_application
//where round_no = 2021;
//
//insert into gigp_key_dates(gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
//select gigp_id, 'epgANTICIPATEDCOMPL', '10/31/2023', 'SYSTEM', getdate()
//from gigp_application
//where round_no = 2021;
//
//insert into gigp_key_dates(gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
//select gigp_id, 'epgSHPOPROJREVLTR', '1/20/2022', 'SYSTEM', getdate()
//from gigp_application
//where round_no = 2021;

//Set Applicant Type = Municipal
//update gigp_application
//set applicant_type = 'MUNI'
//where round_no = 2021;
//ALREADY DONE*************************************



For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')	//
	ls_dec = lds_data.GetItemString(ll_row, 'dec_region')	//
	ls_muni = lds_data.GetItemString(ll_row, 'municipality') //
//	ls_projname = lds_data.GetItemString(ll_row, 'project_name') //
//	ls_consent = lds_data.GetItemString(ll_row, 'consent_order') //
//	ls_reviewagency = lds_data.GetItemString(ll_row, 'reviewing_agency') //
	
//	ll_assembly = lds_data.GetItemNumber(ll_row, 'assembly') //
//	ll_senate = lds_data.GetItemNumber(ll_row, 'senate') //
//	ll_congress = lds_data.GetItemNumber(ll_row, 'congress') //
	
//	ll_eng = lds_data.GetItemNumber(ll_row, 'engineer') //
//	ll_paralegal= lds_data.GetItemNumber(ll_row, 'paralegal') //
//	ll_legal= lds_data.GetItemNumber(ll_row, 'legal') //
//	ll_coordinator= lds_data.GetItemNumber(ll_row, 'coordinator') //
//	ls_reviewer = lds_data.GetItemString(ll_row, 'reviewer') //
	
//	ls_applicant = lds_data.GetItemString(ll_row, 'applicant') //
//	
//	ld_award = Dec(lds_data.GetItemNumber(ll_row, 'grantamt')) //
//
//	ldt_awardaccepted = DateTime(Date(lds_data.GetItemString(ll_row, 'awardaccepted'))) //Already entered
	
//	ls_projtypes = lds_data.GetItemString(ll_row, 'projectypes') //
//	
//	ld_lat = Dec(lds_data.GetItemString(ll_row, 'latitude')) //
//	ld_long = Dec(lds_data.GetItemString(ll_row, 'longitude')) //
//	
//	ls_efcdesc = lds_data.GetItemString(ll_row, 'efcdesc') //
//	ls_appdesc = lds_data.GetItemString(ll_row, 'appdesc') //

	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	If ll_gigp > 0 Then
		
//		//Consent
//		Choose Case ls_consent
//			Case 'Compliance Schedule'
//				ls_consent = 'COComp'
//			Case 'Consent Order'
//				ls_consent = 'COOrder'
//			Case Else
//				ls_consent = 'CONone'
//		End Choose
		
		//Municode
		SetNull(ls_municode)
		SetNull(ls_muniname)
		SetNull(ls_munitype)
		
		ll_place = Pos(ls_muni, '(')
		If ll_place > 0 Then
			ls_muniname = Left(ls_muni, ll_place - 2)
			ls_munitype = Mid(ls_muni, ll_place + 1, 1)
		End If

		select max(muni_code)
		into :ls_municode
		from fin_muni_codes
		where muni_name = :ls_muniname
		and community_type = :ls_munitype;
		
		If ls_municode = '' Then SetNull(ls_municode)
		
		//Update	
		update gigp_application
		set muni_code = :ls_municode
//			dec_region = :ls_dec,
//			project_name = :ls_projname,
//			consent_order = :ls_consent,
//			reviewing_agency = :ls_reviewagency,
		where gigp_id = :ll_gigp;
		
//		//Applicant
//		update gigp_contacts
//		set organization = :ls_applicant
//		where contact_id = (select max(contact_id)
//									from gigp_contact_links
//									where gigp_id = :ll_gigp
//									and conact_type = 'APP');
//		
//		//EFC Contacts
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ll_eng, :ll_gigp, 'EFCENG');
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ll_paralegal, :ll_gigp, 'EFCPARALEGAL');
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ll_legal, :ll_gigp, 'EFCLGL');
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ll_coordinator, :ll_gigp, 'EPGASSIGN');
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		values (:ls_reviewer, :ll_gigp, 'EFCLEADREV');
//		
//		
//		//Coordinates
//		update gigp_contacts
//		set gis_latitude = :ld_lat,
//			gis_longitude = :ld_long
//		where contact_id = (select max(contact)
//									from gigp_contact_links
//									where gigp_id = :ll_gigp
//									and contact_type = 'PLC');
//		
//		//Grant amount
//		ll_id = f_gettokenvalue('amountID', 1)
//	
//		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
//		values (:ll_id, :ll_gigp, 'GIGPFR', 'Requested', 'From Spreadsheet', :ld_award, :ld_award, 'SYSTEM', getdate());
//		
//		
//		//Descriptions
//		delete gigp_notes
//		where gigp_id = :ll_gigp
//		and note_category = 'appNote'
//		and note_type = 'projDescription';
//		
//		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
//		values (:ll_gigp, getdate(), 'appNote', 'projDescription', 'SYSTEM', :ls_efcdesc);
//		
//		delete gigp_notes
//		where gigp_id = :ll_gigp
//		and note_category = 'appNote'
//		and note_type = 'appProjDescription';
//		
//		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
//		values (:ll_gigp, getdate(), 'appNote', 'appProjDescription', 'SYSTEM', :ls_appdesc);
//		
//		
//		//Project Types
//		ln_string.of_ParseToArray(ls_projtypes, ',', ls_types)
//	
//		ll_upper = UpperBound(ls_types)
//		
//		If ll_upper > 0 Then
//			For ll_index = 1 to ll_upper
//				Choose Case ls_types[ll_index]
//					Case 'Upgrade or Replacement of Existing System'
//						ls_typecode = 'PTUpgrReplExisiting'
//					Case 'Sanitary Sewer Overflows (SSO)'
//						ls_typecode = 'PTSSO'
//					Case 'Inflow and Infiltration (I&I)'
//						ls_typecode = 'PTII'
//					Case 'Collection System Improvements'
//						ls_typecode = 'PTCollection'
//					Case 'Part of Long-Term Control Plan (LTCP)'
//						ls_typecode = 'PTLTCP'
//					Case 'Pump Station Improvements'
//						ls_typecode = 'PTPumpStation'
//					Case 'Combined Sewer Overflows (CSO)'
//						ls_typecode = 'PTCSO'
//					Case 'Identified in a DEC-Approved Watershed Implementation Plan'
//						ls_typecode = 'PTDECWIP'
//					Case 'Existing Wastewater Treatment Plant Improvements or Upgrades'
//						ls_typecode = 'PTWWTPImprov'
//					Case 'Regional Consolidation'
//						ls_typecode = 'PTConsolidation'
//					Case 'Disinfection'
//						ls_typecode = 'PTDisinfection'
//					Case 'Green Infrastructure'
//						ls_typecode = 'PTGreenInfra'
//					Case 'Combined Sewer Separation'
//						ls_typecode = 'PTSewerSep'
//					Case 'Currently Unsewered Area'
//						ls_typecode = 'PTUnsewered'
//					Case 'Addressing Documented Failing On-Site Septic Systems'
//						ls_typecode = 'PTFailingSeptic'
//					Case 'Collection System Extension'
//						ls_typecode = 'PTExtension'
//					Case 'Nine Element Watershed Plan'
//						ls_typecode = 'PT9ElementPlan'
//					Case 'New Wastewater Treatment Plant'
//						ls_typecode = 'PTNewWWTP'
//					Case Else
//						ls_typecode = ''
//				End Choose
//				
//				If ls_typecode > '' Then
//					insert into gigp_project_types (gigp_id, project_type)
//					values(:ll_gigp, :ls_typecode);
//				End If
				
//			Next
//			
//		End If
		
	End If
	
Next

of_add_log('Done')
end event

type cb_117 from commandbutton within w_util
integer x = 1449
integer y = 860
integer width = 361
integer height = 100
integer taborder = 360
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Get ID"
end type

event clicked;long ll_id

INSERT INTO EfcLog
           (LogCategory,LogDate,LogType,LogMessage)
     VALUES
           ('Test',getdate(), 'Test', 'Test Message');

select @@identity
into :ll_id
from dual;

of_add_log('Last ID created from Insert: ' + String(ll_id))
end event

type cb_116 from commandbutton within w_util
integer x = 1010
integer y = 860
integer width = 361
integer height = 100
integer taborder = 300
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R13 Updates"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_value, ls_projno, ls_projname, ls_apptype, ls_applicant, ls_coordinator, ls_techlead, ls_engineer, ls_mwbe
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id
decimal ld_tpc, ld_requested, ld_award, ld_local
decimal ld_fundreq, ld_recfund, ld_eligible, ld_req, ld_app
n_ds lds_data

ii_round = 8

//ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_application where round_no = 102', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL("select cfa_no, gigp_id, project_no, project_name 'Applicant', project_name, typeof_applicant, 0.00 'tpc', 0.00 'requestedamt', 0.00 'awardamt', 0.00 'localmatch', project_name 'ej', project_name 'kickoffcall', project_name 'coordinator', project_name 'lead', project_name 'engineer', project_name 'mwbe' from gigp_application where 1=2", 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\GIGP\Round 13\R13Update.txt')

If MessageBox('Data import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	ls_projno = lds_data.GetItemString(ll_row, 'project_no')
	ls_applicant = lds_data.GetItemString(ll_row, 'applicant')
	ls_projname = lds_data.GetItemString(ll_row, 'project_name')
	ls_apptype = lds_data.GetItemString(ll_row, 'typeof_applicant')
	ld_tpc = lds_data.GetItemDecimal(ll_row, 'tpc')
	ld_requested = lds_data.GetItemDecimal(ll_row, 'requestedamt')
	ld_award = lds_data.GetItemDecimal(ll_row, 'awardamt')
	ld_local = lds_data.GetItemDecimal(ll_row, 'localmatch')
	
	ls_value = lds_data.GetItemString(ll_row, 'ej')
	ls_value = lds_data.GetItemString(ll_row, 'kickoffcall')
	
	ls_coordinator = lds_data.GetItemString(ll_row, 'coordinator')
	ls_techlead = lds_data.GetItemString(ll_row, 'lead')
	ls_engineer = lds_data.GetItemString(ll_row, 'engineer')
	ls_mwbe = lds_data.GetItemString(ll_row, 'mwbe')
	
	//Update application data
	update gigp_application
	set		project_no = :ls_projno,
			project_name = :ls_projname,
			typeof_applicant = :ls_apptype
	where gigp_id = :ll_gigp;
	
	//Update Applicant
	select max(contact_id)
	into :ll_id
	from gigp_contact_links
	where gigp_id = :ll_gigp
	and contact_type = 'APP';
	
	If ll_id > 0 Then
		update gigp_contacts
		set organization = :ls_applicant
		where contact_id = :ll_id;
	End If
	
	//Insert amounts
	ll_id = f_gettokenvalue('amountID', 1)
	ld_req = ld_requested
	ld_app = ld_award
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'GIGPFR', 'Requested', 'From Spreadsheet', :ld_req, :ld_app, 'SYSTEM', getdate());
	
	of_add_log('Amounts added for ' + string(ll_gigp) + ' for GIGPFR as ' + string(ld_req) + ' and ' + string(ld_app))
	
	
	ll_id = f_gettokenvalue('amountID', 1)
	ld_req = 0
	ld_app = ld_tpc - ld_award
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'FUNDLOCAL', 'Local', 'From Spreadsheet', :ld_req, :ld_app, 'SYSTEM', getdate());
	
	of_add_log('Amounts added for ' + string(ll_gigp) + ' for FUNDLOCAL as ' + string(ld_req) + ' and ' + string(ld_app))
	
	//Add EFC Contacts
	ls_coordinator = lds_data.GetItemString(ll_row, 'coordinator')
	ls_techlead = lds_data.GetItemString(ll_row, 'lead')
	ls_engineer = lds_data.GetItemString(ll_row, 'engineer')
	ls_mwbe = lds_data.GetItemString(ll_row, 'mwbe')
	
	select contact_id
	into :ll_id
	from gigp_contacts
	where upper(last_name) = upper(:ls_coordinator);
	
	If ll_id > 0 Then
		insert into gigp_contact_links(gigp_id, contact_id, contact_type)
		values (:ll_gigp, :ll_id, 'EFCPROJCOORD');
	Else
		of_add_log('No contact record found for:  ' + ls_coordinator)
	End If
	
	select contact_id
	into :ll_id
	from gigp_contacts
	where upper(last_name) = upper(:ls_techlead);
	
	If ll_id > 0 Then
		insert into gigp_contact_links(gigp_id, contact_id, contact_type)
		values (:ll_gigp, :ll_id, 'EFCREVASSGN');
	Else
		of_add_log('No contact record found for:  ' + ls_techlead)
	End If
	
	select contact_id
	into :ll_id
	from gigp_contacts
	where upper(last_name) = upper(:ls_engineer);
	
	If ll_id > 0 Then
		insert into gigp_contact_links(gigp_id, contact_id, contact_type)
		values (:ll_gigp, :ll_id, 'EFCENG');
	Else
		of_add_log('No contact record found for:  ' + ls_engineer)
	End If
	
	select contact_id
	into :ll_id
	from gigp_contacts
	where upper(last_name) = upper(:ls_mwbe);
	
	If ll_id > 0 Then
		insert into gigp_contact_links(gigp_id, contact_id, contact_type)
		values (:ll_gigp, :ll_id, 'EFCMWBEREP');
	Else
		of_add_log('No contact record found for:  ' + ls_mwbe)
	End If
	

Next

of_add_log('Done loading amounts')
end event

type cb_115 from commandbutton within w_util
integer x = 571
integer y = 860
integer width = 361
integer height = 100
integer taborder = 340
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "13/2021 Load"
end type

event clicked;integer li_district, li_checklist, li_pop, li_programId
long ll_eng, ll_coordinator, ll_assist, ll_id, ll_comma
decimal ld_requested, ld_grant, ld_totalcost, ld_eligiblepct
datetime ldt_responseletterdate, ldt_targetdateforga, ldt_anticipatedcompletion, ldt_accepted
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret, ll_awarded_count
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible, ls_eng
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop, ls_projname, ls_projstatus, ls_projdesc, ls_location
string ls_muni_name, ls_muni_type, ls_municode, ls_proj_stat_comment
string ls_agency, ls_spdes, ls_consent, ls_projtype, ls_program, ls_grant_type
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string
boolean lb_update = False

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

//Retrieve projects
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_r13_21'
lds_apps.SetTransObject(SQLCA)
ll_count = lds_apps.Retrieve()

If MessageBox('Applications Found', String(ll_count) + ' applications found. Continue with load?', Question!, YesNo!, 2) = 2 Then
	Return
End If

If MessageBox('UPDATES?', 'Update database during load?', Question!, YesNo!, 1) = 1 Then
	lb_update = True
Else
	lb_update = False
End If

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row,'cfa_no')
	ls_redc = lds_apps.GetItemString(ll_row, 'region')
	ls_county = lds_apps.GetItemString(ll_row, 'county')
	ls_applicant = lds_apps.GetItemString(ll_row,'applicant')
	ls_projname = lds_apps.GetItemString(ll_row, 'projectname')
	ls_projdesc = lds_apps.GetItemString(ll_row,'projectdescription')
	ld_grant = lds_apps.GetItemDecimal(ll_row,'draftaward')
	ld_totalcost = lds_apps.GetItemDecimal(ll_row,'totalprojectcost')
	li_programId = lds_apps.GetItemNumber(ll_row,'programid')
	ls_program = lds_apps.GetItemString(ll_row,'program')
	ld_eligiblepct = lds_apps.GetItemDecimal(ll_row,'eligible_pct')
	ll_gigpID =	lds_apps.GetItemNumber(ll_row,'gigp_id')
	
	If ls_program = 'GIGP' then
		ii_round = 13
		ls_grant_type = 'Construction'
	Else
		ii_round = 2021
		ls_grant_type = 'Design'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	ls_projstatus = 'projectActive'
	idt_app = DateTime(Date('7/30/2021'))
	
	//County
	select ref_code
	into :ls_fips
	from gigp_reference
	where category = 'County'
	and ref_value = :ls_county;
	
	If lb_update Then
		insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, app_recvd_dt, app_status, funding_recommendation, reviewing_agency, county_fips_code, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, redc_region, project_pct_complete)
		values (:ll_gigpID, :ii_round, :ls_program, :ls_projname, :ls_projstatus, 'CW', :ls_grant_type, :ld_eligiblepct, null, :idt_app, :ls_appStatus, :ls_funding_rec, 'EFC', :ls_fips, 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, :ls_redc, 0);
	End if
	
	of_add_log('Application added for ' + ls_applicant)
	
	//Create CFA Items
	If lb_update Then
		insert into gigp_cfa_items(gigp_id, grant_status, project_status, project_status_comment, last_updated_dt, last_updated_by)
		values (:ll_gigpID, 'statusPending', 'statusGreen', :ls_proj_stat_comment, getdate(), 'SYSTEM');
	End If
	
	of_add_log('CFA Items added for ' + ls_applicant)
		

	//Create Summaries
	If lb_update Then
		of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
		
		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
		values (:ll_gigpID, :idt_app, 'appNote', 'projDescription', 'SYSTEM', :ls_projdesc);
	End If
	
	//Create Metrics
	If ls_program = 'GIGP' and lb_update = True Then
		of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
		of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
		of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
		of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')
	End If
	
	//Insert checklist item for Project Required by MS 4...
	If lb_update Then
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
	End If
		
	
	//Insert Project Location Record (then link political districts to it)
	ls_addr = Left(of_get_answer(928, ll_cfa), 50)
	ls_city = Left(of_get_answer(565, ll_cfa), 30)
	ls_state = Left(of_get_answer(568, ll_cfa), 2)
	ls_zip = Left(of_get_answer(1034, ll_cfa), 10)
	
	ls_lon = Left(of_get_answer(573, ll_cfa), 40)
	ls_lat = Left(of_get_answer(572, ll_cfa), 40)

	ls_phone = Left(of_get_answer(651, ll_cfa), 25)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	

	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_location = 'Project location record for GIGP ' + String(ll_gigpID)
	
	If lb_update Then
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_location, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_plc, :ll_gigpID, 'PLC');
	End If
		
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				If lb_update Then
					insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
					values(:ll_plc, 'nysSenate', :li_district, 2010);
				End If
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
			End If
			
			
		Else
			li_district = Integer(ls_senate)
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
			End If
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				If lb_update Then
					insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
					values(:ll_plc, 'nysAssembly', :li_district, 2010);
				End If
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
			End If
			
			
		Else
			li_district = Integer(ls_assembly)
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
			End If
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	
	/*********************************************************
	FIGURE OUT BETTER WAY TO GET APPLICANT WITH OTHER FIELDS BLANK
	********************************************************/
//	select max(contact_id)
//	into :ll_applicant
//	from gigp_contacts
//	where Upper(organization) = Upper(:ls_applicant);
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		
		ls_addr = Left(of_get_answer(551, ll_cfa), 50)
		ls_city = Left(of_get_answer(565, ll_cfa), 30)
		ls_state = Left(of_get_answer(553, ll_cfa), 2)
		ls_zip = Left(of_get_answer(554, ll_cfa), 10)
		ls_email = Left(of_get_answer(555, ll_cfa), 75)

		ls_phone = Left(of_get_answer(651, ll_cfa), 25)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
		If lb_update Then
			insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
			values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		End If
		
	End if
	
	If lb_update Then
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_applicant, :ll_gigpID, 'APP');
	End If
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
			
			If lb_update Then
				insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
				values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			End If
			
		End If
		
		If lb_update Then
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			Values (:ll_other, :ll_gigpID, 'OTH');
		End If
		
	End If
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
			
			If lb_update Then
				insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
				values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			End If
			
		End If
		
		If lb_update Then
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			Values (:ll_other, :ll_gigpID, 'PRC');
		End If
		
	End If
	
	//AMOUNTS
//	ll_id = f_gettokenvalue('amountID', 1)
//	
//	If lb_update Then
//		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, ref_amt, approved_amt, last_updated_by, last_updated_dt)
//		values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', :ld_requested, :ld_grant, 'SYSTEM', getdate());
//	End If

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_114 from commandbutton within w_util
integer x = 133
integer y = 864
integer width = 361
integer height = 100
integer taborder = 290
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "13/2021 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'C:\Users\weingold\Desktop\Load\Load2021.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
Next

of_add_log('Done')
end event

type cb_113 from commandbutton within w_util
integer x = 2327
integer y = 760
integer width = 361
integer height = 100
integer taborder = 350
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2020 App Upd"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant, ls_staff, ls_reviewer, ls_org
string ls_proj, ls_decregion, ls_scoping, ls_scoping_comment, ls_efc_comments, ls_review_agency, ls_consent, ls_consent_order, ls_redc, ls_project_name
string ls_project_types[], ls_type, ls_projtypeitem, ls_note, ls_null[]
datetime ldt_scoping
integer li_create, li_round, li_upperbound, li_index
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app, ll_staff, ll_amtcount, ll_reviewer, ll_count, ll_legal, ll_newapp
decimal ld_grant, ld_award_letter, ld_award_amt
boolean lb_update = False
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_syntax = sqlca.SyntaxFromSQL('select gigp_id, contact_id, contact_type from gigp_contact_links where contact_type = "APP" and gigp_id in (select gigp_id from gigp_application where round_no = 2020)', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.Retrieve()

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	ll_app = lds_data.GetItemNumber(ll_row, 'contact_id')
	
	select organization
	into :ls_org
	from gigp_contacts
	where contact_id = :ll_app;
	
	//of_add_log('Applicant for ' + String(ll_gigp) + ' is ' + ls_org)
	
	select max(contact_id)
	into :ll_newapp
	from gigp_contacts
	where organization = :ls_org
	and first_name is null
	and last_name is null;
	
	If ll_newapp > 0 Then
//		of_add_log('New applicant found for ' + ls_org)
		
		update gigp_contact_links
		set contact_id = :ll_newapp
		where gigp_id = :ll_gigp
		and contact_type = 'APP';
		
	Else
		of_add_log('Please check Applicant Contact for ' + ls_org)
	End If

Next

end event

type cb_112 from commandbutton within w_util
integer x = 1888
integer y = 760
integer width = 361
integer height = 100
integer taborder = 350
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2020 Awd Acc"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant, ls_staff, ls_reviewer
string ls_proj, ls_decregion, ls_scoping, ls_scoping_comment, ls_efc_comments, ls_review_agency, ls_consent, ls_consent_order, ls_redc, ls_project_name
string ls_project_types[], ls_type, ls_projtypeitem, ls_note, ls_null[]
datetime ldt_scoping, ldt_accept
integer li_create, li_round, li_upperbound, li_index
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app, ll_staff, ll_amtcount, ll_reviewer, ll_count, ll_legal
decimal ld_grant, ld_award_letter, ld_award_amt
boolean lb_update = False
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, app_recvd_dt as award from gigp_application where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\EPG (Engineering Planning Grant)\Round 2020\2020 Award Accept.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ldt_accept = lds_data.GetItemDateTime(ll_row, 'award')
	
	If NOT IsNull(ldt_accept) Then
		select gigp_id
		into :ll_gigp
		from gigp_application
		where cfa_no = :ll_cfa;
		
		delete gigp_key_dates
		where gigp_id = :ll_gigp
		and ref_code = 'epgAWARDACCEPT';
		
		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
		values (:ll_gigp, 'epgAWARDACCEPT', :ldt_accept, 'SYSTEM', getdate());
		
		of_add_log('Adding GIGP# ' + String(ll_gigp) + '  /  Date:  ' + String(ldt_accept))
			
	End If
		
Next

of_add_log('Done at ' + String(Today(), "m/d/yy hh:mm"))
end event

type cb_111 from commandbutton within w_util
integer x = 1449
integer y = 760
integer width = 361
integer height = 100
integer taborder = 350
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2020 P Typ~'s"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant, ls_staff, ls_reviewer
string ls_proj, ls_decregion, ls_scoping, ls_scoping_comment, ls_efc_comments, ls_review_agency, ls_consent, ls_consent_order, ls_redc, ls_project_name, ls_types, ls_typecode
string ls_project_types[], ls_type, ls_projtypeitem, ls_note, ls_null[], ls_typearray[]
datetime ldt_scoping
integer li_create, li_round, li_upperbound, li_index
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app, ll_staff, ll_amtcount, ll_reviewer, ll_count, ll_legal
decimal ld_grant, ld_award_letter, ld_award_amt
boolean lb_update = False
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, ccr_name as types from gigp_application where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\EPG (Engineering Planning Grant)\Round 2020\2020 Project Types.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ls_types = lds_data.GetItemString(ll_row, 'types')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	ls_typearray[] = ls_null[]
	
	ln_string.of_parsetoarray(ls_types, ',', ls_typearray)
	
	li_upperbound = UpperBound(ls_typearray)
	
	If li_upperbound > 0 Then
		For li_index = 1 to li_upperbound
			ls_type = Trim(ls_typearray[li_index])
			
			select ref_code
			into :ls_typecode
			from gigp_reference
			where category = 'ProjectType'
			and Convert(varchar(200), description) = :ls_type;
			
			If IsNull(ls_typecode) Then ls_typecode = 'Could not find code for ' + ls_type
			
			of_add_log('Adding GIGP# ' + String(ll_gigp) + '  /  Project Type:  '+ ls_typecode)
			
			insert into gigp_project_types (gigp_id, project_type)
			values (:ll_gigp, :ls_type);
			
			SetNull(ls_typecode)
			
		Next
		
	End If
	
Next

of_add_log('Done at ' + String(Today(), "m/d/yy hh:mm"))
end event

type cb_110 from commandbutton within w_util
integer x = 1010
integer y = 760
integer width = 361
integer height = 100
integer taborder = 350
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R2020 Legal"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant, ls_staff, ls_reviewer
string ls_proj, ls_decregion, ls_scoping, ls_scoping_comment, ls_efc_comments, ls_review_agency, ls_consent, ls_consent_order, ls_redc, ls_project_name
string ls_project_types[], ls_type, ls_projtypeitem, ls_note, ls_null[]
datetime ldt_scoping
integer li_create, li_round, li_upperbound, li_index
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app, ll_staff, ll_amtcount, ll_reviewer, ll_count, ll_legal
decimal ld_grant, ld_award_letter, ld_award_amt
boolean lb_update = False
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, 5555 as legal from gigp_application where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\EPG (Engineering Planning Grant)\Round 2020\2020 Legal.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ll_legal = lds_data.GetItemNumber(ll_row, 'legal')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	If ll_cfa > 0 and ll_legal > 0 Then
		insert into gigp_contact_links (gigp_id, contact_id, contact_type)
		values (:ll_gigp, :ll_legal, 'EFCLGL');
		
		of_add_log('Adding CFA# ' + String(ll_cfa) + '  /  Legal Id ' + String(ll_legal))
		
	End If
	
Next

of_add_log('Done at ' + String(Today(), "m/d/yy hh:mm"))
end event

type cb_109 from commandbutton within w_util
integer x = 571
integer y = 760
integer width = 361
integer height = 100
integer taborder = 340
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2020 Load"
end type

event clicked;integer li_district, li_checklist, li_pop, li_programId
long ll_eng, ll_coordinator, ll_assist, ll_id, ll_comma
decimal ld_requested, ld_grant
datetime ldt_responseletterdate, ldt_targetdateforga, ldt_anticipatedcompletion, ldt_accepted
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret, ll_awarded_count
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible, ls_eng
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop, ls_projname, ls_projstatus, ls_projdesc, ls_location
string ls_muni_name, ls_muni_type, ls_municode, ls_proj_stat_comment
string ls_agency, ls_spdes, ls_consent, ls_projtype
//string ls_awarded = '*71098*71972*72884*73034*73301*73362*73644*73768*74322*75019*75279*76261*76422*77270*'
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string
boolean lb_update = False

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 2020
li_programId = 514
ls_proj_stat_comment = 'The grant award letter has been sent out and documents to develop the grant agreement are being collected.'

//Retrieve projects
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_round2020'
lds_apps.SetTransObject(SQLCA)
ll_count = lds_apps.Retrieve()

If MessageBox('Applications Found', String(ll_count) + ' applications found. Continue with load?', Question!, YesNo!, 2) = 2 Then
	Return
End If

If MessageBox('UPDATES?', 'Update database during load?', Question!, YesNo!, 1) = 1 Then
	lb_update = True
Else
	lb_update = False
End If

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
	ls_region = String(lds_apps.GetItemNumber(ll_row, 'dec_region'))
	ls_projname = lds_apps.GetItemString(ll_row, 'project_name')
	ls_county = lds_apps.GetItemString(ll_row, 'county')
	ls_muni_name = lds_apps.GetItemString(ll_row, 'municipality')
	ls_muni_type = lds_apps.GetItemString(ll_row, 'applicant_type')
	ll_cfa = lds_apps.GetItemNumber(ll_row,'cfa_no')
	ls_applicant = lds_apps.GetItemString(ll_row,'applicant')
	ls_CFAtype = lds_apps.GetItemString(ll_row,'applicant_type')
	ls_muni = lds_apps.GetItemString(ll_row,'municipality')
	ls_agency = lds_apps.GetItemString(ll_row,'reviewing_agency')
	ls_redc = lds_apps.GetItemString(ll_row,'redc_region')
	ls_spdes = lds_apps.GetItemString(ll_row,'spdes')
	ld_requested = lds_apps.GetItemDecimal(ll_row,'funds_requested')
	ld_grant = lds_apps.GetItemDecimal(ll_row,'grant_amount')
	ls_projdesc = lds_apps.GetItemString(ll_row,'app_project_desc')
	ll_coordinator = lds_apps.GetItemNumber(ll_row,'project_coordinator')
	ll_eng = lds_apps.GetItemNumber(ll_row,'efc_engineer')
	idt_app = lds_apps.GetItemDateTime(ll_row,'app_rec')
	ls_consent = lds_apps.GetItemString(ll_row,'consent_order')
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	ls_projstatus = 'projectActive'
	
	If lb_update Then
		ll_gigpID = f_gettokenvalue('gigpID', 1)
	Else
		ll_gigpID = 0
	End If
	

	//Muni Type
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	//County
	select ref_code
	into :ls_fips
	from gigp_reference
	where category = 'County'
	and ref_value = :ls_county;
	
	//Muni
	ll_comma = Pos(ls_muni_name, ',')
	
	If ll_comma > 0 Then
		ls_muni_name = Left(ls_muni_name, ll_comma - 1)
	End If
	
	
	Choose Case ls_muni_type
		Case 'City'
			ls_muni_type = 'C'
			
		Case 'County'
			ls_muni_type = 'CO'
			
		Case 'Public Benefit Corp'
			SetNull(ls_muni_type)
			
		Case 'Town'
			ls_muni_type = 'T'
			
		Case 'Village'
			ls_muni_type = 'V'
			
	End Choose
	
	SetNull(ls_municode)
	
	select max(muni_code)
	into :ls_municode
	from fin_muni_codes
	where muni_name = :ls_muni_name
	and community_type = :ls_muni_type;
	
	//Consent Order
	Choose Case ls_consent
		Case 'Compliance Schedule'
			ls_consent = 'COComp'
		Case 'Consent Order'
			ls_consent = 'COOrder'
		Case 'None'
			ls_consent = 'CONone'
	End Choose
	

	If lb_update Then
		insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete, consent_order, redc_region)
		values (:ll_gigpID, :ii_round, 'EPG', :ls_projname, :ls_projstatus, 'CW', 'Design', null, :ls_region, :ls_municode, null, null, null, :ls_CFAtype, :ls_type, :idt_app, :ls_appStatus, null, :ls_funding_rec, :ls_agency, null, null, null, :ls_fips, :ls_spdes, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, 0, :ls_consent, :ls_redc);
	End if
	
	of_add_log('Application added for ' + ls_applicant)
	
	//Create CFA Items
	If lb_update Then
		insert into gigp_cfa_items(gigp_id, grant_status, project_status, project_status_comment, last_updated_dt, last_updated_by)
		values (:ll_gigpID, 'statusPending', 'statusGreen', :ls_proj_stat_comment, getdate(), 'SYSTEM');
	End If
	
	of_add_log('CFA Items added for ' + ls_applicant)
		
		
	/****************************************************
	Response Letter Date (contracts tab) for all: 12/21/2018
	Target Date for GA for all: 12/31/2019
	Anticipated Completion Date for all: 12/31/2019
	*****************************************************/
	ldt_responseletterdate = lds_apps.GetItemDateTime(ll_row,'award_letter_date')
	ldt_targetdateforga = lds_apps.GetItemDateTime(ll_row,'target_for_ga')
	ldt_anticipatedcompletion = lds_apps.GetItemDateTime(ll_row,'anticipated_completion')
	ldt_accepted = lds_apps.GetItemDateTime(ll_row, 'award_accepted')

	//Insert dates
	If lb_update Then
		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
		values (:ll_gigpID, 'agreeCOMLTRSEN', :ldt_responseletterdate, 'SYSTEM', getdate());
		
		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
		values (:ll_gigpID, 'epgTARGETDATE', :ldt_targetdateforga, 'SYSTEM', getdate());
		
		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
		values (:ll_gigpID, 'epgANTICIPATEDCOMPL', :ldt_anticipatedcompletion, 'SYSTEM', getdate());
		
		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
		values (:ll_gigpID, 'epgAWARDACCEPT', :ldt_accepted, 'SYSTEM', getdate());
	End if
	
	
	 
	//Create Summaries
//	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	If lb_update Then
		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
		values (:ll_gigpId, :idt_app, 'appNote', 'appProjDescription', 'SYSTEM', :ls_projdesc);
	End If
	
	//Project Types	***WILL NEED TO PARSE OUT AND MATCH TO REFERENCE TABLE - currently do not match what is in the  reference table
	ls_projtype = lds_apps.GetItemString(ll_row,'project_types')
	

	//Insert checklist item for Project Required by MS 4...
	If lb_update Then
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
	End If
		
	
	//Insert Project Location Record (then link political districts to it)
	ls_addr = Left(of_get_answer(928, ll_cfa), 50)
	ls_city = Left(of_get_answer(565, ll_cfa), 30)
	ls_state = Left(of_get_answer(568, ll_cfa), 2)
	ls_zip = Left(of_get_answer(1034, ll_cfa), 10)
	
	ls_lon = Left(of_get_answer(573, ll_cfa), 40)
	ls_lat = Left(of_get_answer(572, ll_cfa), 40)

	ls_phone = Left(of_get_answer(651, ll_cfa), 25)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	

	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_location = 'Project location record for GIGP ' + String(ll_gigpID)
	
	If lb_update Then
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_location, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_plc, :ll_gigpID, 'PLC');
	End If
		
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				If lb_update Then
					insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
					values(:ll_plc, 'nysSenate', :li_district, 2010);
				End If
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
			End If
			
			
		Else
			li_district = Integer(ls_senate)
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
			End If
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				If lb_update Then
					insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
					values(:ll_plc, 'nysAssembly', :li_district, 2010);
				End If
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
			End If
			
			
		Else
			li_district = Integer(ls_assembly)
			
			If lb_update Then
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
			End If
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	
	/*********************************************************
	FIGURE OUT BETTER WAY TO GET APPLICANT WITH OTHER FIELDS BLANK
	********************************************************/
	
//	select max(contact_id)
//	into :ll_applicant
//	from gigp_contacts
//	where Upper(organization) = Upper(:ls_applicant);
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		
		ls_addr = Left(of_get_answer(551, ll_cfa), 50)
		ls_city = Left(of_get_answer(565, ll_cfa), 30)
		ls_state = Left(of_get_answer(553, ll_cfa), 2)
		ls_zip = Left(of_get_answer(554, ll_cfa), 10)
		ls_email = Left(of_get_answer(555, ll_cfa), 75)

		ls_phone = Left(of_get_answer(651, ll_cfa), 25)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
		If lb_update Then
			insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
			values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		End If
		
	End if
	
	If lb_update Then
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_applicant, :ll_gigpID, 'APP');
	End If
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
			
			If lb_update Then
				insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
				values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			End If
			
		End If
		
		If lb_update Then
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			Values (:ll_other, :ll_gigpID, 'OTH');
		End If
		
	End If
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
			
			If lb_update Then
				insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
				values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			End If
			
		End If
		
		If lb_update Then
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			Values (:ll_other, :ll_gigpID, 'PRC');
		End If
		
	End If
	
	
	//Add EFC Contacts
	If lb_update Then
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		values (:ll_eng, :ll_gigpID, 'EFCENG');
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		values (:ll_coordinator, :ll_gigpID, 'EPGASSIGN');
	End If
	
	of_add_log('Done adding Contacts')
	
	
	//AMOUNTS
	ll_id = f_gettokenvalue('amountID', 1)
	
	If lb_update Then
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_requested, :ld_grant, 'SYSTEM', getdate());
	End If

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_108 from commandbutton within w_util
integer x = 133
integer y = 760
integer width = 361
integer height = 100
integer taborder = 330
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2020 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\EPG (Engineering Planning Grant)\Round 2020\Round2020.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
Next

of_add_log('Done')
end event

type cb_107 from commandbutton within w_util
integer x = 1888
integer y = 664
integer width = 361
integer height = 100
integer taborder = 280
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "DDE"
end type

event clicked;integer li_rc
string ls_token_id, ls_proj
long ll_handle
n_cst_authentication_service	lu_auth

//Open a DDE Channel to the Hub based on the info set in StartServerDDE in the Hub Frame's Open event
//ll_handle = OpenChannel("EFCHub", "Null")
//
////If it is open then bring to top and send the Project Number over, if not then open and send via Authentication Service
//If ll_handle > 0 Then	//Hub is already open
//	//Bring Hub to the top and pass the project number
//	BringWindowToTop(ll_handle)
//	
//	//Send the Project Number to the Hub. Will be caught int the remoteexec event of the Hub frame window
//	//Send the Token iinstad of project number and put the project number in the authentication record
//	//ls_proj = '5566-01-00'
//	ls_proj = 'jjjjjjj'
//
//	lu_auth.of_add_parm('ProjectNumber', ls_proj, 'string')
//	ls_token_id = lu_auth.of_set_authentication_record("GIGP", 'EFC-Hub', '', gnv_app.of_getuserid())
//	
//	If ls_token_id > '' Then
//		ExecRemote(ls_token_id, ll_handle)
//	End If
//	
//	CloseChannel(ll_handle)
//	
//Else	//Hub is not open
//	//Open the hub and pass the project number
//	
//End If

li_rc = ExecRemote('Steve', 'EFCHub', 'Null')

messagebox('ExecRemote', li_rc)
end event

type cb_106 from commandbutton within w_util
integer x = 1449
integer y = 664
integer width = 361
integer height = 100
integer taborder = 330
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R12"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist, li_pop, li_programId
decimal ld_metric, ld_amt, ld_pct, ld_requested
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret, ll_id, ll_la
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop

decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 12
//li_programId = 529 //TWO programs this Round - 529 and 531 but not setup to do that so using 529 for now

ldt_app = DateTime(Date('2/12/2021'))

//Create Application Record
lds_apps = CREATE Datastore
//lds_apps.DataObject = 'd_roundxxx_apps'
lds_apps.DataObject = 'd_r12'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve()

of_add_log(String(ll_count) + ' raw applications found.')

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If

For ll_row = 1 to ll_count
	
	string ls_projectno, ls_projectname, ls_analyst
	decimal ld_award
	
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'appid')
	ll_gigpID = lds_apps.GetItemNumber(ll_row, 'gigpid')
	ls_projectno = lds_apps.GetItemString(ll_row, 'projectno')
	ls_applicant = lds_apps.GetItemString(ll_row, 'applicant')
	ls_projectname = lds_apps.GetItemString(ll_row, 'projectname')
	ld_award = lds_apps.GetItemNumber(ll_row, 'award')
	ll_la = Long(lds_apps.GetItemString(ll_row, 'analyst'))
	ls_region = lds_apps.GetItemString(ll_row, 'region')
	li_programid = lds_apps.GetItemNumber(ll_row, 'program')
	ld_requested = lds_apps.GetItemNumber(ll_row, 'requested')
	ld_pct = Dec(lds_apps.GetItemNumber(ll_row, 'eligiblepct'))
	
	
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete, redc_region)
	values (:ll_gigpID, :ii_round, 'GIGP', :ls_projectname, 'projectActive', 'CW', 'Construction', :ld_pct, null, null, null, :ls_projectno, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, 0, :ls_region);
	
	//Insert REDC region (question 548 from the CFA)
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, question, answer)
	values (12, 548, :ll_cfa, 'REDC Region', :ls_region);
	
	of_add_log('Application added for ' + ls_projectname)
	
	
	//Add amounts
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_requested, :ld_award, 'SYSTEM', getdate());
	
//	ll_id = f_gettokenvalue('amountID', 1)
//	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
//	values (:ll_id, :ll_gigp, 'FUNDLOCAL', 'Local', null, :ld_totalprojectcost, :ld_totalprojectcost, 'SYSTEM', getdate());



	//Insert Landscape Architect
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_la, :ll_gigpID, 'EFCLANDARCH');


	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_projectname)
	
	//Create Metrics  
	of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
	of_insertSummary(1296, ll_gigpId, ll_cfa, 'additWaterQualBen')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_add_log('Summaries added for ' + ls_projectname)

	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_addr = Left(of_get_answer(928, ll_cfa), 49)
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_busname = 'Project location record for GIGP ' + String(ll_gigpID)
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
		
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_city = of_get_answer(552, ll_cfa)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and upper(mail_city) = upper(:ls_city);
	
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(last_name) = upper(:ls_lname)
		and upper(email) = upper(:ls_email);
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	ls_email = of_get_answer(3692, ll_cfa) //as per Brian Hahn
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(last_name) = upper(:ls_lname)
		and upper(email) = upper(:ls_email);
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  :ls_email, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If

	of_add_log('Done adding Contacts')

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_105 from commandbutton within w_util
integer x = 1010
integer y = 664
integer width = 361
integer height = 100
integer taborder = 270
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R12 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\GIGP\Round 12\Round12.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
Next

of_add_log('Done')
end event

type cb_104 from commandbutton within w_util
integer x = 571
integer y = 664
integer width = 361
integer height = 100
integer taborder = 260
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Email"
end type

event clicked;String    ls_folderfile, ls_email_addr, ls_subject, ls_email_text_message, ls_sender_addr, ls_cc
 integer    li_return, li_result
 OLEObject ole_item, ole_attach, ole_outlook
 
 ls_sender_addr = 'noreply@wcb.ny.gov'
 ls_email_addr = 'sweingold@gmail.com;dlweingold@gmail.com'
 ls_subject = 'Test email subject'
 ls_email_text_message = 'This is the body of the email'
 ls_cc = ''

 ole_outlook = Create OLEObject
 li_result = ole_outlook.ConnectToNewObject("outlook.application")
 
 if li_result = 0 then
            ole_item = ole_outlook.CreateItem(0)
            ole_item.SentOnBehalfOfName = ls_sender_addr
            ole_item.To = ls_email_addr
            ole_item.Cc = ls_cc
            ole_item.Subject = ls_subject
            ole_item.Body = ls_email_text_message + char(13)
//            ole_attach = ole_item.Attachments
//            ole_attach.Add(ls_folderfile)

            ole_item.Display
end if

 ole_outlook.DisconnectObject()
 destroy ole_outlook
end event

type cb_103 from commandbutton within w_util
integer x = 133
integer y = 664
integer width = 361
integer height = 100
integer taborder = 260
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R2019 Legal"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep
decimal ld_amt
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select 9999 as legal, 8888 as cfa_no from gigp_reference where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP Application\EPG (Engineering Planning Grant)\Round 2019\R2019LegalUpdate.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

If MessageBox('Delete confirm', 'Delete existing Legal Reps for R1019?', Question!, YesNoCancel!, 1) = 1 Then

	delete gigp_contact_links
	where gigp_id in (select gigp_id from gigp_application where round_no = 2019)
	and contact_type = 'EFCLGL';
	
End If

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ll_rep = lds_data.GetItemNumber(ll_row, 'legal')

	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	values (:ll_rep, :ll_gigp, 'EFCLGL');
	
	of_add_log('Legal added for ' + String(ll_gigp))
	
Next

end event

type cb_102 from commandbutton within w_util
integer x = 1888
integer y = 968
integer width = 361
integer height = 100
integer taborder = 240
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load Septic"
end type

event clicked;long ll_gigpId, ll_row, ll_count, ll_applicant, ll_id
string ls_applicant, ls_eligible, ls_appStatus, ls_fips, ls_projname, ls_projstatus, ls_funding_rec
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_value, ls_projno, ls_apptype, ls_coordinator, ls_techlead, ls_engineer, ls_mwbe
decimal ld_amount
n_ds lds_data

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ii_round = 300

ls_syntax = sqlca.SyntaxFromSQL("select project_name as applicant, project_name, 0.00 as funding_amount from gigp_application where 1=2", 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

//ll_count = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\Septic Replacement\SepticLoad.txt')
//ll_count = lds_data.ImportFile(Text!, 'G:\PowerBuilder\GIGP Application\Septic Replacement\NewSepticCounties.txt')
ll_count = lds_data.ImportFile(Text!, 'G:\PowerBuilder\Small Grants\Septic Replacement\NewSepticCounties2024.txt')

If MessageBox('Data import', String(ll_count) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
	ls_applicant = lds_data.GetItemString(ll_row, 'applicant')
	ls_projname = lds_data.GetItemString(ll_row, 'project_name')
	ld_amount = lds_data.GetItemDecimal(ll_row, 'funding_amount')
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	ls_projstatus = 'projectActive'

	select ref_code
	into :ls_fips
	from gigp_reference
	where category = 'County'
	and ref_value = :ls_applicant;
	
	ll_gigpID = f_gettokenvalue('gigpID', 1)

	//Create application record
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete, redc_region)
	values (:ll_gigpID, :ii_round, 'Septic', :ls_projname, :ls_projstatus, 'CW', 'Construction', null, null, null, null, null, null, null, 'MUNI', null, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, :ls_fips, null, null, null, 0, getdate(), 'SYSTEM', null, 0, null, 0, null);
	
	of_add_log('Application added for ' + ls_applicant)
	

	//Add or Link to Contact
	ll_applicant = f_gettokenvalue('contactID', 1)
	
	insert into gigp_contacts (contact_id, organization, first_name, last_name, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, phone_2, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_applicant, :ls_applicant + ' County',  'Septic Project', null, null, null, null, null, null, null, null, 'Active', 'SYSTEM', getdate(), null, null);
		
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//AMOUNTS
	ll_id = f_gettokenvalue('amountID', 1)
	

	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_amount, :ld_amount, 'SYSTEM', getdate());
	
	//Add vendor
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (9839, :ll_gigpID, 'VEND');
	

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

end event

type cb_101 from commandbutton within w_util
integer x = 1449
integer y = 968
integer width = 361
integer height = 100
integer taborder = 240
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load WIQ"
end type

event clicked;long ll_gigpId, ll_row, ll_count, ll_applicant, ll_id
string ls_applicant, ls_eligible, ls_appStatus, ls_fips, ls_projname, ls_projstatus, ls_funding_rec, ls_projno
decimal ld_amount

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ii_round = 200

//Retrieve awarded - Original Load
//string ls_applicants[] = {'Aurora (V)','Ilion (V)','Lake George (T)','Springs Union Free SD','Patchogue (V)','Mayville (V)'}
//string ls_fipsarray[] = {'011','043','113','103','103','013'}
//long ll_amounts[] = {500000,350000,343000,1334500,21000000,1000000}

//Late addition
//string ls_applicants[] = {'Mount Vernon (C)'}
//string ls_fipsarray[] = {'119'}
//long ll_amounts[] = {500000}

////Next new one
//string ls_applicants[] = {'Lake George (T)'}
//string ls_fipsarray[] = {'113'}
//long ll_amounts[] = {4700000}

//Next new one
//string ls_applicants[] = {'Kiryas Joel (V)'}
//string ls_fipsarray[] = {'071'}
//long ll_amounts[] = {32000000}

//Next new one
//string ls_applicants[] = {'Mount Vernon (C) Board of Water Supply'}
//string ls_fipsarray[] = {'119'}
//long ll_amounts[] = {1000000}

//Next new one
//string ls_applicants[] = {'Mount Vernon (C) Administrative'}
//string ls_fipsarray[] = {'119'}
//long ll_amounts[] = {500000}

//Next new one
//string ls_applicants[] = {'Mount Vernon (C) CCTV'}
//string ls_fipsarray[] = {'119'}
//long ll_amounts[] = {500000}

////Next new one
//string ls_applicants[] = {'Mount Vernon (C) Third Street Project'}
//string ls_fipsarray[] = {'119'}
//long ll_amounts[] = {0}

//Next new one
//string ls_applicants[] = {'Erie County Water Authority'}
//string ls_fipsarray[] = {'029'}
//long ll_amounts[] = {20000000}

//Next new one
//string ls_applicants[] = {'Mount Vernon (C) CWIA Admin'}
//string ls_fipsarray[] = {'119'}
//long ll_amounts[] = {1000000}

//Next new one
//string ls_applicants[] = {'Mount Vernon (C) CWIA AFA'}
//string ls_fipsarray[] = {'119'}
//long ll_amounts[] = {500000}

//Next new one
//string ls_applicants[] = {'Smithtown Business District Sewer Improvement Area', 'Kings Park Waste Water Treatment Facility'}
//string ls_fipsarray[] = {'103', '103'}
//long ll_amounts[] = {20000000,20000000}

//Next new one
//string ls_applicants[] = {'Webster (T)'}
//string ls_fipsarray[] = {'055'}
//long ll_amounts[] = {20000000}

//Next new one
//string ls_applicants[] = {'City of Mount Vernon WQIP Prefinance'}
//string ls_fipsarray[] = {'119'}
//long ll_amounts[] = {2500000}

//Next new one
//string ls_applicants[] = {'Chautauqua Institution'}
//string ls_fipsarray[] = {'013'}
//long ll_amounts[] = {4700000}

//Next new one
//string ls_applicants[] = {'Mount Vernon (C) Edison Pump Station Project'}
//string ls_fipsarray[] = {'119'}
//long ll_amounts[] = {1322500}

//Next new one
string ls_applicants[] = {'Ticonderoga (T) Chilson / Eagle Lake Test Well Drilling Project'}
string ls_fipsarray[] = {'031'}
long ll_amounts[] = {300000}



ll_count = Upperbound(ls_applicants)

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
	ls_applicant = ls_applicants[ll_row]
	ls_projname = 'WQI Project for ' + ls_applicant

//	ls_projname = 'Wastewater Treatment Plant Replacement'  //Project specific
//	ls_projno = '5571-04-00'

//	ls_projname = 'Village of Kiryas Joel Public Drinking Water System Project'	//Project specific
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	ls_projstatus = 'projectActive'
	ls_fips = ls_fipsarray[ll_row]
	
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	
	
	//Create application record
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete, redc_region)
	values (:ll_gigpID, :ii_round, 'WQI', :ls_projname, :ls_projstatus, null, 'Construction', null, null, null, null, :ls_projno, null, null, null, null, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, :ls_fips, null, null, null, 0, getdate(), 'SYSTEM', null, 0, null, 0, null);
	
	of_add_log('Application added for ' + ls_applicant)
	

	//Add or Link to Contact
	ll_applicant = f_gettokenvalue('contactID', 1)
	
	insert into gigp_contacts (contact_id, organization, first_name, last_name, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, phone_2, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_applicant, :ls_applicant,  'WQI Project', null, null, null, null, null, null, null, null, 'Active', 'SYSTEM', getdate(), null, null);
		
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//AMOUNTS
	ll_id = f_gettokenvalue('amountID', 1)
	
	ld_amount = Dec(ll_amounts[ll_row])
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_amount, :ld_amount, 'SYSTEM', getdate());
	
	//Add vendors
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (10758, :ll_gigpID, 'VEND');
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (10759, :ll_gigpID, 'VEND');

	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (10760, :ll_gigpID, 'VEND');
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (10761, :ll_gigpID, 'VEND');

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

end event

type cb_100 from commandbutton within w_util
integer x = 1445
integer y = 516
integer width = 361
integer height = 100
integer taborder = 240
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "~'19 Proj Desc"
end type

event clicked;long ll_gigpId, ll_row, ll_count, ll_cfa, ll_appcount, ll_applicant, ll_index
string ls_name, ls_desc
string ls_syntax, error_syntaxfromSQL, errorCreate
integer ll_eng, ll_legal, ll_coordinator
n_ds lds_data

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, project_name, consent_order_comments "projdesc" from gigp_application where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)

ll_count = lds_data.ImportFile(Text!, 'G:\GIGP Application\EPG (Engineering Planning Grant)\Round 2019\2019DescUpdates.txt')

If MessageBox('Applications Found', String(ll_count) + ' applications found. Continue with load?', Question!, YesNo!, 2) = 2 Then
	Return
End If

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ls_name = lds_data.GetItemString(ll_row, 'project_name')
	ls_desc =  lds_data.GetItemString(ll_row, 'projdesc')
	
	of_add_log('GIGP ' + String(ll_gigpid) + ' Project Name = ' + ls_name)
	of_add_log('Proj Desc = ' + ls_Desc)
	
	//Check for gigpid
	select count(*)
	into :ll_appcount
	from gigp_application
	where cfa_no = :ll_cfa;
	
	If ll_appcount <= 0 Then
		CONTINUE
	End If
	
	//Get gigpid
	select gigp_id
	into :ll_gigpid
	from gigp_application
	where cfa_no = :ll_cfa;
	
	//update Project Name
	update 	gigp_application
	set 		project_name = :ls_name
	where 	gigp_id = :ll_gigpid;
	
	//Update EFC Proj Desc
	update gigp_notes
	set comments = :ls_desc
	where gigp_id = :ll_gigpid
	and note_category = 'appNote'
	and note_type = 'projDescription';
	
	
Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_data) Then DESTROY lds_data

end event

type cb_99 from commandbutton within w_util
integer x = 1006
integer y = 516
integer width = 361
integer height = 100
integer taborder = 240
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "New Parm"
end type

event clicked;string ls_return

OpenWithParm(w_select_program_round, 'MULTI')

ls_return = Message.StringParm

of_add_log(ls_return)
end event

type cb_98 from commandbutton within w_util
integer x = 567
integer y = 516
integer width = 361
integer height = 100
integer taborder = 230
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "REDI Load"
end type

event clicked;long ll_id, ll_plc, ll_other
decimal ld_requested, ld_grant
long ll_gigpId, ll_row, ll_count, ll_applicant
string ls_addr, ls_city, ls_state, ls_zip, ls_applicant, ls_email
string ls_fname, ls_lname, ls_title, ls_fullname, ls_funding_rec, ls_eligible, ls_appStatus
string ls_fips, ls_county, ls_region, ls_pop, ls_projname, ls_projstatus, ls_location, ls_decregion
string ls_projdesc, ls_phone1, ls_phone2, ls_agency, ls_srf
decimal ld_local
datetime ldt_app
datastore lds_apps
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ii_round = 100

//Retrieve awarded
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_redi2019'

ll_count = lds_apps.ImportFile(Text!, 'G:\GIGP Application\REDI\REDILoad.txt')

If MessageBox('Applications Found', String(ll_count) + ' applications found. Continue with load?', Question!, YesNo!, 2) = 2 Then
	Return
End If

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
	ls_applicant = lds_apps.GetItemString(ll_row, 'applicant')
	ls_projname = lds_apps.GetItemString(ll_row, 'project_name')
	ls_county = lds_apps.GetItemString(ll_row, 'county')
	ls_decregion = lds_apps.GetItemString(ll_row, 'dec_region')
	ld_grant = lds_apps.GetItemDecimal(ll_row, 'grant_amount')
	ld_local = lds_apps.GetItemDecimal(ll_row, 'local_match')
	ls_projdesc = lds_apps.GetItemString(ll_row, 'project_desc')
	ls_fname = lds_apps.GetItemString(ll_row, 'fname')
	ls_lname = lds_apps.GetItemString(ll_row, 'lname')
	ls_title = lds_apps.GetItemString(ll_row, 'title')
	ls_addr = lds_apps.GetItemString(ll_row, 'address')
	ls_city = lds_apps.GetItemString(ll_row, 'city')
	ls_state = 'NY'
	ls_zip = lds_apps.GetItemString(ll_row, 'zip')
	ls_email = lds_apps.GetItemString(ll_row, 'email')
	ls_phone1 = lds_apps.GetItemString(ll_row, 'phone1')
	ls_phone2 = lds_apps.GetItemString(ll_row, 'phone2')
	ldt_app = lds_apps.GetItemDateTime(ll_row, 'rec_date')
	ls_agency = lds_apps.GetItemString(ll_row, 'agency')
	
	If ls_agency = 'DOH' Then
		ls_srf = 'DW'
	Else
		ls_srf = 'CW'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	ls_projstatus = 'projectActive'
	
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	
	//County
	select ref_code
	into :ls_fips
	from gigp_reference
	where category = 'County'
	and ref_value = :ls_county;
	
	//Create application record
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete, redc_region)
	values (:ll_gigpID, :ii_round, 'REDI', :ls_projname, :ls_projstatus, :ls_srf, 'Construction', null, :ls_decregion, null, null, null, null, null, null, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, :ls_fips, null, null, null, 0, getdate(), 'SYSTEM', null, 0, null, 0, null);
	
	of_add_log('Application added for ' + ls_applicant)
	
	//EFC proj desc
	insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
	values (:ll_gigpId, :ldt_app, 'appNote', 'projDescription', 'SYSTEM', :ls_projdesc);
	
	
	//Insert Project Location Record (then link political districts to it)
	ls_phone1 = ln_string.of_globalreplace(ls_phone1, '-', '')
	ls_phone1 = ln_string.of_globalreplace(ls_phone1, '(', '')
	ls_phone1 = ln_string.of_globalreplace(ls_phone1, ')', '')
	ls_phone1 = ln_string.of_globalreplace(ls_phone1, ' ', '')
	
	ls_phone2 = ln_string.of_globalreplace(ls_phone2, '-', '')
	ls_phone2 = ln_string.of_globalreplace(ls_phone2, '(', '')
	ls_phone2 = ln_string.of_globalreplace(ls_phone2, ')', '')
	ls_phone2 = ln_string.of_globalreplace(ls_phone2, ' ', '')
	

	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_location = 'Project location record for GIGP ' + String(ll_gigpID)
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_location, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone1, 'Active', 'SYSTEM', getdate(), null, null);
		
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant);
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, phone_2, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone1, :ls_phone2, 'Active', 'SYSTEM', getdate(), null, null);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Primary" Contact
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where  upper(last_name) = upper(:ls_lname)
		and upper(email) = upper(:ls_email);
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
			
			insert into gigp_contacts (contact_id, organization, first_name, last_name, title, full_name, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, phone_2, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
			values (:ll_other, :ls_applicant, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone1, :ls_phone2, 'Active', 'SYSTEM', getdate(), null, null);
	
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If
	
	//AMOUNTS
	//Grant Amt
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_grant, :ld_grant, 'SYSTEM', getdate());
	
	//Local Match
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigpID, 'FUNDLOCAL', 'local', null, 0, :ld_local, 'SYSTEM', getdate());
	
	

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_97 from commandbutton within w_util
integer x = 128
integer y = 516
integer width = 361
integer height = 100
integer taborder = 230
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2019 Upd"
end type

event clicked;long ll_gigpId, ll_row, ll_count, ll_cfa, ll_appcount, ll_applicant, ll_index
string ls_busname, ls_muniname, ls_munitype, ls_redc, ls_municode, ls_agency
string ls_syntax, error_syntaxfromSQL, errorCreate
integer ll_eng, ll_legal, ll_coordinator
n_ds lds_data

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, space(50) as "Muni", space(10) as "MuniType", redc_region, 9999 as "Engineer", 9999 as "Legal", 9999 as "Coordinator" from gigp_application where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)

ll_count = lds_data.ImportFile(Text!, 'G:\GIGP Application\EPG (Engineering Planning Grant)\Round 2019\2019updates.txt')

If MessageBox('Applications Found', String(ll_count) + ' applications found. Continue with load?', Question!, YesNo!, 2) = 2 Then
	Return
End If

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ls_muniname = Trim(lds_data.GetItemString(ll_row, 'Muni'))
	ls_munitype =  Trim(lds_data.GetItemString(ll_row, 'MuniType'))
	ls_redc =  lds_data.GetItemString(ll_row, 'redc_region')
	ll_eng = lds_data.GetItemNumber(ll_row, 'Engineer')
	ll_legal = lds_data.GetItemNumber(ll_row, 'Legal')
	ll_coordinator = lds_data.GetItemNumber(ll_row, 'Coordinator')
	
	//Check for gigpid
	select count(*)
	into :ll_appcount
	from gigp_application
	where cfa_no = :ll_cfa;
	
	If ll_appcount <= 0 Then
		CONTINUE
	End If
	
	//Get gigpid
	select gigp_id, reviewing_agency
	into :ll_gigpid, :ls_agency
	from gigp_application
	where cfa_no = :ll_cfa;
	
	//Get Municode
	If IsNull(ls_munitype) Then
		select max(muni_code)
		into :ls_municode
		from fin_muni_codes
		where muni_name = :ls_muniname;
		
	Else
		select max(muni_code)
		into :ls_municode
		from fin_muni_codes
		where muni_name = :ls_muniname
		and community_type = :ls_munitype;
		
	End If
	of_add_log('Municode for ' + string(ll_cfa) + ': ' + ls_municode)
	
	//update redc and municode
	update 	gigp_application
	set 		muni_code = :ls_municode,
				redc_region = :ls_redc,
				applicant_type = 'MUNI'
	where 	gigp_id = :ll_gigpid;
	
	//insert EFC contacts
	insert into gigp_contact_links (contact_id, gigp_id, contact_type) values (:ll_eng, :ll_gigpid, 'EFCENG');
	insert into gigp_contact_links (contact_id, gigp_id, contact_type) values (:ll_legal, :ll_gigpid, 'EFCLGL');
	insert into gigp_contact_links (contact_id, gigp_id, contact_type) values (:ll_coordinator, :ll_gigpid, 'EPGASSIGN');
	
	If ls_agency = 'EFC' Then
		insert into gigp_contact_links (contact_id, gigp_id, contact_type) values (:ll_eng, :ll_gigpid, 'EFCLEADREV');
	End If
	
	
Next

of_add_log('Total contacts updated: ' + String(ll_index))

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_data) Then DESTROY lds_data

end event

type cb_96 from commandbutton within w_util
integer x = 2322
integer y = 420
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2019 Load"
end type

type cb_95 from commandbutton within w_util
integer x = 1883
integer y = 420
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2019 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP Application\EPG (Engineering Planning Grant)\Round 2019\Round2019.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
Next

of_add_log('Done')
end event

type cb_94 from commandbutton within w_util
integer x = 1445
integer y = 420
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R11 Upds"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_dec, ls_redc, ls_name
long ll_cfa, ll_gigp, ll_row, ll_ret, ll_amt_id
decimal ld_grant
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select gigp_id, cfa_no, dec_region, redc_region, project_name, 0.00 "grant_award" from gigp_application where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)

ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP Application\GIGP\Round 11\R11Updates.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	ls_dec = lds_data.GetItemString(ll_row, 'dec_region')
	ls_redc =lds_data.GetItemString(ll_row, 'redc_region') 
	ls_name = lds_data.GetItemString(ll_row, 'project_name') 
	ld_grant = lds_data.GetItemDecimal(ll_row, 'grant_award')
	
	If ll_gigp > 0 Then
		update gigp_application
		set project_name = :ls_name,
			dec_region = :ls_dec,
			redc_region = :ls_redc
		where gigp_id = :ll_gigp;
		
		of_add_log('Project upated for gigp ' + string(ll_gigp))
		
		ll_amt_id = f_gettokenvalue('amountID', 1)
	
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_amt_id, :ll_gigp, 'GIGPFR', 'Requested', null, 0, :ld_grant, 'SYSTEM', getdate());
		
		of_add_log('amount_id = ' + string(ll_amt_id) + ';  grant award = $' + string(ld_grant))
		
	End If
	
Next
end event

type cb_93 from commandbutton within w_util
integer x = 1006
integer y = 420
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R11"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist, li_pop, li_programId
decimal ld_metric, ld_amt
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop

//////////////////////////////////////////////////////
string ls_awarded = '*90762*93061*91347*92738*90111*93240*93906*93137*85207*92761*93809*94442*90206*'
//////////////////////////////////////////////////////

decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 11
li_programId = 446

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

ldt_app = DateTime(Date('7/26/2019'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_roundxxx_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve(ii_round)

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If


For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ls_busname =  Trim(of_get_answer(546, ll_cfa))
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	
	If IsNumber(ls_pop) then
		li_pop = Integer(ls_pop)
	End If
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	
	If pos(ls_awarded, '*' + String(ll_cfa) + '*') > 0 Then
		ls_funding_rec = 'RECC-H'
		of_add_log(ls_busname + 'AWARDED')
	Else
		ls_funding_rec = 'DONOTREC'
		of_add_log(ls_busname + 'NOT AWARDED')
	End If
	
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete)
	values (:ll_gigpID, :ii_round, 'GIGP', :ls_busname, 'projectActive', 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, :li_pop, 'CFA Answer', 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, 0);
	
	of_add_log('Application added for ' + ls_busname)
	

	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
	
	//Create Metrics  
	of_insertMetric(1282, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OSAVE')	
	of_insertMetric(1285, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OREUSE')
	
	of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
	of_insertSummary(1296, ll_gigpId, ll_cfa, 'additWaterQualBen')
//	of_insertSummary(1268, ll_gigpId, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_add_log('Summaries added for ' + ls_busname)

	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_addr = Left(of_get_answer(928, ll_cfa), 49)
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_busname = 'Project location record for GIGP ' + String(ll_gigpID)
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = Left(of_get_answer(546, ll_cfa), 64)
	ls_city = of_get_answer(552, ll_cfa)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and upper(mail_city) = upper(:ls_city);
	
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(last_name) = upper(:ls_lname)
		and upper(email) = upper(:ls_email);
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	ls_email = of_get_answer(3692, ll_cfa) //as per Brian Hahn
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(last_name) = upper(:ls_lname)
		and upper(email) = upper(:ls_email);
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  :ls_email, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If

	of_add_log('Done adding Contacts')

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_92 from commandbutton within w_util
integer x = 567
integer y = 420
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R11 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP Application\GIGP\Round 11\Round11.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
Next

of_add_log('Done')
end event

type cb_91 from commandbutton within w_util
integer x = 128
integer y = 420
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load EC"
end type

event clicked;integer li_district, li_checklist, li_pop, li_programId
long ll_eng, ll_coordinator, ll_assist, ll_id
decimal ld_requested, ld_grant
datetime ldt_responseletterdate, ldt_targetdateforga, ldt_anticipatedcompletion, ldt_accepted
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret, ll_awarded_count
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible, ls_eng
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop, ls_projname, ls_projstatus, ls_desc, ls_location
string ls_muni_name, ls_muni_type, ls_municode, ls_proj_stat_comment
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ii_round = 2018
idt_app = DateTime(Date('12/14/2018'))

//Retrieve 
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_ppg_ec'
lds_apps.SetTransObject(SQLCA)

//ll_count = lds_apps.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 2018\EPG2018UpdatesLoad.txt')
ll_count = lds_apps.Retrieve()

If MessageBox('Applications Found', String(ll_count) + ' applications found. Continue with load?', Question!, YesNo!, 2) = 2 Then
	Return
End If

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count

	ls_projname = lds_apps.GetItemString(ll_row, 'projectname')
	ls_county = lds_apps.GetItemString(ll_row, 'county')
	ls_appStatus = lds_apps.GetItemString(ll_row, 'appstatus')
	ls_funding_rec = lds_apps.GetItemString(ll_row, 'fundingrec')
	ls_projstatus = lds_apps.GetItemString(ll_row, 'projectstatus')
	
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	
	//County
	select ref_code
	into :ls_fips
	from gigp_reference
	where category = 'County'
	and ref_value = :ls_county;
	
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete)
	values (:ll_gigpID, :ii_round, 'PPG-EC', :ls_projname, :ls_projstatus, 'DW', 'Design', null, null, null, null, null, null, null, 'MUNI', :idt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, :ls_fips, null, null, null, 0, getdate(), 'SYSTEM', NULL, 0, NULL, 0);
	
		
	
	//Insert Project Location Record (then link political districts to it)
	ls_applicant = lds_apps.GetItemString(ll_row, 'applicant')
	ls_lon = lds_apps.GetItemString(ll_row, 'longitude')
	ls_lat = lds_apps.GetItemString(ll_row, 'latitude')


	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_location = 'Project location record for GIGP ' + String(ll_gigpID)
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_location, null, null, null, null, null, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant);
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  null, null, null, null, null, null, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	
	//AMOUNTS
	ld_grant = lds_apps.GetItemDecimal(ll_row, 'grantamount')
	
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_grant, :ld_grant, 'SYSTEM', getdate());

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_90 from commandbutton within w_util
integer x = 2322
integer y = 324
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2018 Legal"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant, ls_staff, ls_reviewer
string ls_proj, ls_decregion, ls_scoping, ls_scoping_comment, ls_efc_comments, ls_review_agency, ls_consent, ls_consent_order, ls_redc, ls_project_name
string ls_project_types[], ls_type, ls_projtypeitem, ls_note, ls_null[]
datetime ldt_scoping
integer li_create, li_round, li_upperbound, li_index
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app, ll_staff, ll_amtcount, ll_reviewer, ll_count, ll_legal
decimal ld_grant, ld_award_letter, ld_award_amt
boolean lb_update = False
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, 5555 as legal from gigp_application where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 2018\EPG2018LoadLegal.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ll_legal = lds_data.GetItemNumber(ll_row, 'legal')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	If ll_cfa > 0 and ll_legal > 0 Then
		insert into gigp_contact_links (gigp_id, contact_id, contact_type)
		values (:ll_gigp, :ll_legal, 'EFCLGL');
		
	End If
	
Next

of_add_log('Done at ' + String(Today(), "m/d/yy hh:mm"))
end event

type cb_89 from commandbutton within w_util
integer x = 1883
integer y = 324
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2018 Load"
end type

event clicked;integer li_district, li_checklist, li_pop, li_programId
long ll_eng, ll_coordinator, ll_assist, ll_id
decimal ld_requested, ld_grant
datetime ldt_responseletterdate, ldt_targetdateforga, ldt_anticipatedcompletion, ldt_accepted
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret, ll_awarded_count
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible, ls_eng
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop, ls_projname, ls_projstatus, ls_desc, ls_location
string ls_muni_name, ls_muni_type, ls_municode, ls_proj_stat_comment
//string ls_awarded = '*71098*71972*72884*73034*73301*73362*73644*73768*74322*75019*75279*76261*76422*77270*'
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 2018
li_programId = 414
idt_app = DateTime(Date('7/27/2018'))
ldt_responseletterdate = DateTime(Date('12/21/2018'))
ldt_targetdateforga = DateTime(Date('12/31/2018'))
ldt_anticipatedcompletion = DateTime(Date('12/31/2018'))
ls_proj_stat_comment = 'The grant award letter has been sent out and documents to develop the grant agreement are being collected.'

//Retrieve awarded
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_round2018'

ll_count = lds_apps.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 2018\EPG2018UpdatesLoad.txt')

If MessageBox('Applications Found', String(ll_count) + ' applications found. Continue with load?', Question!, YesNo!, 2) = 2 Then
	Return
End If

of_add_log(String(ll_count) + ' awarded records found.')

For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'cfa_no')
	ls_busname =  Trim(of_get_answer(546, ll_cfa))
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	ls_region = String(lds_apps.GetItemNumber(ll_row, 'dec_region'))
	ls_projname = lds_apps.GetItemString(ll_row, 'project_name')
	ls_county = lds_apps.GetItemString(ll_row, 'county')
	ls_muni_name = lds_apps.GetItemString(ll_row, 'municipality')
	ls_muni_type = lds_apps.GetItemString(ll_row, 'muni_type')
	ldt_accepted = DateTime(lds_apps.GetItemDate(ll_row, 'award_accepted'))
	ls_region = lds_apps.GetItemString(ll_row, 'redc_region')
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	ls_projstatus = 'projectActive'
	
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, question, answer)
	values (:ii_round, 548, :ll_cfa, 'Select your region. If your project spans multiple regions; select all regions that apply.', :ls_region);
	
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	

	//Muni Type
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	//County
	select ref_code
	into :ls_fips
	from gigp_reference
	where category = 'County'
	and ref_value = :ls_county;
	
	//Muni
	select max(muni_code)
	into :ls_municode
	from fin_muni_codes
	where muni_name = :ls_muni_name
	and community_type = :ls_muni_type;
		
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete)
	values (:ll_gigpID, :ii_round, 'EPG', :ls_projname, :ls_projstatus, 'CW', 'Design', null, :ls_region, :ls_municode, null, null, null, :ls_CFAtype, :ls_type, :idt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, :ls_fips, null, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, 0);
	
	of_add_log('Application added for ' + ls_busname)
	
	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, project_status_comment, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', :ls_proj_stat_comment, getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
		
		
	/****************************************************
	Response Letter Date (contracts tab) for all: 12/21/2018
	Target Date for GA for all: 12/31/2019
	Anticipated Completion Date for all: 12/31/2019
	*****************************************************/
	//Insert dates
	insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
	values (:ll_gigpID, 'agreeCOMLTRSEN', :ldt_responseletterdate, 'SYSTEM', getdate());
	
	insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
	values (:ll_gigpID, 'epgTARGETDATE', :ldt_targetdateforga, 'SYSTEM', getdate());
	
	insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
	values (:ll_gigpID, 'epgANTICIPATEDCOMPL', :ldt_anticipatedcompletion, 'SYSTEM', getdate());
	
	insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
	values (:ll_gigpID, 'epgAWARDACCEPT', :ldt_accepted, 'SYSTEM', getdate());
	
	
	
	//Create Summaries
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	

	//Insert checklist item for Project Required by MS 4...
	insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
	values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
	
	insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
	values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
	
	insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
	values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
	
	insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
	values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
	
	insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
	values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	
	//Insert Project Location Record (then link political districts to it)
	ls_applicant = lds_apps.GetItemString(ll_row, 'applicant')

	ls_addr = Left(of_get_answer(928, ll_cfa), 50)
	ls_city = Left(of_get_answer(565, ll_cfa), 30)
	ls_state = Left(of_get_answer(568, ll_cfa), 2)
	ls_zip = Left(of_get_answer(1034, ll_cfa), 10)
	
	ls_lon = Left(of_get_answer(573, ll_cfa), 40)
	ls_lat = Left(of_get_answer(572, ll_cfa), 40)

	ls_phone = Left(of_get_answer(651, ll_cfa), 25)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	

	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_location = 'Project location record for GIGP ' + String(ll_gigpID)
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_location, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant);
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		
		ls_addr = Left(of_get_answer(551, ll_cfa), 50)
		ls_city = Left(of_get_answer(565, ll_cfa), 30)
		ls_state = Left(of_get_answer(553, ll_cfa), 2)
		ls_zip = Left(of_get_answer(554, ll_cfa), 10)
		ls_email = Left(of_get_answer(555, ll_cfa), 75)

		ls_phone = Left(of_get_answer(651, ll_cfa), 25)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If
	
	
	//Add EFC Contacts
	ll_eng = lds_apps.GetItemNumber(ll_row, 'engineer')
	ll_coordinator = lds_apps.GetItemNumber(ll_row, 'project_coordinator')
	ll_assist = lds_apps.GetItemNumber(ll_row, 'community_assistant')
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	values (:ll_eng, :ll_gigpID, 'EFCENG');
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	values (:ll_coordinator, :ll_gigpID, 'EFCPROJCOORD');
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	values (:ll_assist, :ll_gigpID, 'EFCCOMASST');

	of_add_log('Done adding Contacts')
	
	
	//AMOUNTS
	ld_requested = lds_apps.GetItemDecimal(ll_row, 'requested_amt')
	ld_grant = lds_apps.GetItemDecimal(ll_row, 'grant_amt')
	
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_requested, :ld_grant, 'SYSTEM', getdate());

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_88 from commandbutton within w_util
integer x = 1445
integer y = 324
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2018 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 2018\Round2018.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_email = lds_data.GetItemString(ll_row, 'email')
	ls_question = lds_data.GetItemString(ll_row, 'question')
	ls_answer = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_answer)
	
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
	values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
	
	of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
Next

of_add_log('Done')
end event

type cb_87 from commandbutton within w_util
integer x = 1006
integer y = 324
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R10 Updates"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_zip, ls_name, ls_desc, ls_applicant, ls_region, ls_county, ls_fips
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app
decimal ld_requested, ld_grant, ld_fundsrequsted,	ld_grantamount, ld_totalproject, ld_totalprojectcost
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, space(100) as region, space(100) as funds_requested, space(100) as total_project_cost, space(100) as grant_amount,  space(500) as project_name, space(500) as applicant_name, space(100) as county from gigp_application where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 10\GIGP10 Updates.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	ls_name = Trim(lds_data.GetItemString(ll_row, 'project_name'))
	ls_applicant = Trim(lds_data.GetItemString(ll_row, 'applicant_name'))
	ls_county = Trim(lds_data.GetItemString(ll_row, 'county'))
	ls_region = Trim(lds_data.GetItemString(ll_row, 'region'))
	
	
	//Get County FIPS
	select ref_code
	into :ls_fips
	from gigp_reference
	where ref_value = :ls_county;
		
	//Project Name
	update gigp_application
	set project_name = :ls_name,
		county_fips_code = :ls_fips
	where gigp_id = :ll_gigp;
	
	of_add_log('updated project name for gigp ' + string(ll_gigp) + ' to ' + ls_name)
	
	//Insert REDC region (question 548 from the CFA)
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, question, answer)
	values (10, 548, :ll_cfa, 'REDC Region', :ls_region);
	
	select max(contact_id)
	into :ll_app
	from gigp_contact_links
	where gigp_id = :ll_gigp
	and contact_type = 'APP';
	
	If ll_app > 0 Then
		update gigp_contacts
		set organization = :ls_applicant
		where contact_id = :ll_app;
		
		of_add_log('updated applicant for ' + string(ll_gigp) + ' to ' + ls_applicant)
		
	End If
	
	//Amounts
	ld_fundsrequsted = Dec(Trim(lds_data.GetItemString(ll_row, 'funds_requested')))
	If IsNull(ld_fundsrequsted) Then ld_fundsrequsted = 0
	
	ld_grantamount = Dec(Trim(lds_data.GetItemString(ll_row, 'grant_amount')))
	If IsNull(ld_grantamount) Then ld_grantamount = 0
	
	ld_totalprojectcost = (Dec(Trim(lds_data.GetItemString(ll_row, 'total_project_cost')))) - (ld_grantamount)
	If IsNull(ld_totalprojectcost) Then ld_totalprojectcost = 0
	
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'GIGPFR', 'Requested', null, :ld_fundsrequsted, :ld_grantamount, 'SYSTEM', getdate());
	
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'FUNDLOCAL', 'Local', null, :ld_totalprojectcost, :ld_totalprojectcost, 'SYSTEM', getdate());
	
	
	of_add_log('Done with ' + String(ll_gigp))
	
Next

end event

type cb_86 from commandbutton within w_util
integer x = 567
integer y = 324
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R10"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist, li_pop, li_programId
decimal ld_metric, ld_amt
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop

//////////////////////////////////////////////////////
//string ls_awarded = '*71098*71972*72884*73034*73301*73362*73644*73768*74322*75019*75279*76261*76422*77270*'
string ls_awarded = '*81218*81840*82375*81784*84054*82859*80499*82179*83097*79886*81602*80265*81667*82195*82186*'
//////////////////////////////////////////////////////

decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 10
li_programId = 399

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

ldt_app = DateTime(Date('7/27/2018'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_roundxxx_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve(ii_round)

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If


For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ls_busname =  Trim(of_get_answer(546, ll_cfa))
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	
	If IsNumber(ls_pop) then
		li_pop = Integer(ls_pop)
	End If
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	
	If pos(ls_awarded, '*' + String(ll_cfa) + '*') > 0 Then
		ls_funding_rec = 'RECC-H'
	Else
		ls_funding_rec = 'DONOTREC'
	End If
	
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete)
	values (:ll_gigpID, :ii_round, 'GIGP', :ls_busname, 'projectActive', 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, :li_pop, 'CFA Answer', 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, 0);
	
	of_add_log('Application added for ' + ls_busname)
	

	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
	
	//Create Metrics  
	of_insertMetric(1282, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OSAVE')	
	of_insertMetric(1285, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OREUSE')
	
	of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
	of_insertSummary(1296, ll_gigpId, ll_cfa, 'additWaterQualBen')
	of_insertSummary(1268, ll_gigpId, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_add_log('Summaries added for ' + ls_busname)

	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_addr = of_get_answer(928, ll_cfa)
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_busname = 'Project location record for GIGP ' + String(ll_gigpID)
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_city = of_get_answer(552, ll_cfa)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and upper(mail_city) = upper(:ls_city);
	
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If

	of_add_log('Done adding Contacts')

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_85 from commandbutton within w_util
integer x = 128
integer y = 324
integer width = 361
integer height = 100
integer taborder = 320
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R10 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
//ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 103\Round103.txt')
ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 10\Round10.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	
//	If pos(ls_approved, '*' + String(ll_app) + '*') > 0 Then
	
		ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
		ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
		ls_email = lds_data.GetItemString(ll_row, 'email')
		ls_question = lds_data.GetItemString(ll_row, 'question')
		ls_answer = lds_data.GetItemString(ll_row, 'answer')
		of_cleanse_text(ls_answer)
		
		insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
		values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
		
		of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
//	End If

Next

of_add_log('Done')
end event

type cb_84 from commandbutton within w_util
integer x = 2322
integer y = 228
integer width = 361
integer height = 100
integer taborder = 270
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
end type

type cb_83 from commandbutton within w_util
integer x = 1883
integer y = 228
integer width = 361
integer height = 100
integer taborder = 310
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load Scores"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_proj, ls_program
integer li_score
long ll_ret, ll_row, ll_count
n_ds lds_data

//columns in the select used only for their datatype since data is actually imported instead of retrieved
ls_syntax = sqlca.SyntaxFromSQL('select project_no, project_name "applicant", pop_count "score", program from gigp_application where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'C:\Users\weingold\Desktop\Score\ScoreUpload.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ls_proj = lds_data.GetItemString(ll_row, 'project_no')
	ls_program = lds_data.GetItemString(ll_row, 'program')
	li_score = lds_data.GetItemNumber(ll_row, 'score')
	
//	update grant_xxxxxx_application
//	set calculated_score = :li_score
//	where project_no = :ls_proj
//	and grant_program = :ls_program
//	and grant_year = 2018;
	
	of_add_log(string(ll_row) + ', ' + ls_proj + ', ' + ls_program + ',  ' + string(li_score) + ', Update SQL Code = ' + String(sqlca.sqlcode))
	
	
Next

end event

type cb_82 from commandbutton within w_util
integer x = 1445
integer y = 228
integer width = 361
integer height = 100
integer taborder = 300
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2017 Amts"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant, ls_staff, ls_reviewer
string ls_proj, ls_decregion, ls_scoping, ls_scoping_comment, ls_efc_comments, ls_review_agency, ls_consent, ls_consent_order, ls_redc, ls_project_name
string ls_project_types[], ls_type, ls_projtypeitem, ls_note, ls_null[]
datetime ldt_scoping
integer li_create, li_round, li_upperbound, li_index
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app, ll_staff, ll_amtcount, ll_reviewer, ll_count
decimal ld_grant, ld_award_letter, ld_award_amt
boolean lb_update = False
n_ds lds_data
n_cst_string ln_string

/////////////////////////// update ability - set to true ///////////////////////////
lb_update = False
/////////////////////////// update ability /////////////////////////////////////////

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no,space(50) as project_no,space(100) as applicant_name,space(25) as County,dec_region,round_no,space(12) as award_letter_amount,space(75) as scoping_call,space(25) as grant_committee_approval,space(12) as award_amount,space(25) as grant_agreement_executed,space(25) as engineering_report_received,space(25) as engineering_report_accepted,space(15) as final_grant_amount_disbursed,space(25) as available_funds_not_used,space(1500) as efc_staff_comments,space(25) as efc_dec_coordinator,space(25) as efc_community_assistance_staff,space(25) as efc_legal_staff,space(25) as efc_engineer_for_base_program,space(5) as efc_or_dec_to_review,space(30) as lead_reviewer,space(25) as consent_order,space(25) as redc_district,space(25) as cwsrf_st_closed_date,space(12) as cwsrf_closed_st_amount,space(12) as cwsrf_closed_lt_amount,space(5) as federal_grant_or_water_grant,space(125) project_name,space(100) as project_type,space(2000) as project_description,space(1000) asfollow_up_for_listing from gigp_application where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\MasterLoad.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

If MessageBox('UPDATE', 'Perform updates???', Exclamation!, YesNo!, 2) = 1 Then
	lb_update = True
End If

ii_round = 2017

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')

	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	//****If no valid GIGP Id then go on to the next
	If IsNull(ll_gigp) or ll_gigp <= 0 Then CONTINUE
	
	ld_award_letter = lds_data.GetItemDecimal(ll_row, 'award_letter_amount') //All there
	
	If ld_award_letter > 0 Then
		update gigp_amounts
		set ref_amt = :ld_award_letter
		where gigp_id = :ll_gigp
		and ref_code = 'GIGPFR';
		
	End If
	

	ld_award_amt = lds_data.GetItemDecimal(ll_row, 'award_amount')	//May be null
	
	If ld_award_amt > 0 then
		update gigp_amounts
		set approved_amt = :ld_award_amt
		where gigp_id = :ll_gigp
		and ref_code = 'GIGPFR';
		
	End If
	
	
		
	of_add_log('Done with ' + String(ll_gigp))
	
Next

end event

type cb_81 from commandbutton within w_util
integer x = 1006
integer y = 228
integer width = 361
integer height = 100
integer taborder = 290
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2017 Upds"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant, ls_staff
string ls_proj, ls_decregion, ls_scoping, ls_scoping_comment, ls_efc_comments, ls_review_agency, ls_consent, ls_consent_order, ls_redc, ls_project_name
string ls_project_types[], ls_type, ls_projtypeitem, ls_note, ls_null[]
datetime ldt_scoping
integer li_create, li_round, li_upperbound, li_index
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app, ll_staff, ll_amtcount
decimal ld_grant
boolean lb_update = False
n_ds lds_data
n_cst_string ln_string

/////////////////////////// update ability - set to true ///////////////////////////
lb_update = False
/////////////////////////// update ability /////////////////////////////////////////


//ls_syntax = sqlca.SyntaxFromSQL('select gigp_id, cfa_no from gigp_application where round_no = 9', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL('select cfa_no,space(50) as project_no,space(100) as applicant_name,space(25) as County,dec_region,round_no,space(12) as award_letter_amount,space(75) as scoping_call,space(25) as grant_committee_approval,space(12) as award_amount,space(25) as grant_agreement_executed,space(25) as engineering_report_received,space(25) as engineering_report_accepted,space(15) as final_grant_amount_disbursed,space(25) as available_funds_not_used,space(1500) as efc_staff_comments,space(25) as efc_dec_coordinator,space(25) as efc_community_assistance_staff,space(25) as efc_legal_staff,space(25) as efc_engineer_for_base_program,space(5) as efc_or_dec_to_review,space(30) as lead_reviewer,space(25) as consent_order,space(25) as redc_district,space(25) as cwsrf_st_closed_date,space(12) as cwsrf_closed_st_amount,space(12) as cwsrf_closed_lt_amount,space(5) as federal_grant_or_water_grant,space(125) project_name,space(100) as project_type,space(2000) as project_description,space(1000) asfollow_up_for_listing from gigp_application where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\MasterLoad.txt')
//ll_ret = lds_data.Retrieve()

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

If MessageBox('UPDATE', 'Perform updates???', Exclamation!, YesNo!, 2) = 1 Then
	lb_update = True
End If

ii_round = 2017

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
//	ls_applicant = Trim(lds_data.GetItemString(ll_row, 'applicant_name'))
//	ld_grant = lds_data.GetItemDecimal(ll_row, 'grant_amt')
//	ls_staff = Trim(lds_data.GetItemString(ll_row, 'epgstaff'))
	
	select gigp_id, round_no
	into :ll_gigp, :li_round
	from gigp_application
	where cfa_no = :ll_cfa;
	
	//****If no valid GIGP Id then go on to the next
	If IsNull(ll_gigp) or ll_gigp <= 0 Then CONTINUE
	
		
	//Project Number / DEC region
	ls_proj = Trim(lds_data.GetItemString(ll_row, 'project_no'))
	ls_decregion = Trim(lds_data.GetItemString(ll_row, 'dec_region'))
	ls_review_agency = Trim(lds_data.GetItemString(ll_row, 'efc_or_dec_to_review'))
	ls_project_name = Left(Trim(lds_data.GetItemString(ll_row, 'project_name')), 100)
	
	If lb_update Then
		update gigp_application
		set project_no = :ls_proj,
			dec_region = :ls_decregion,
			reviewing_agency = :ls_review_agency,
			project_name = :ls_project_name
		where gigp_id = :ll_gigp;
	End If
	
	//Scoping Call - Load date if there is, if not, load contents into comments
	ls_scoping = Trim(lds_data.GetItemString(ll_row, 'scoping_call'))
	
	If IsDate(ls_scoping) Then
		ldt_scoping = DateTime(Date(ls_scoping))
		SetNull(ls_scoping_comment)
	Else
		SetNull(ldt_scoping)
		ls_scoping_comment = ls_scoping
	End If
	
	If lb_update Then
		delete gigp_key_dates
		where gigp_id = :ll_gigp
		and ref_code = 'epgSCOPINGCALL';
		
		insert into gigp_key_dates ( gigp_id, ref_code, keydate_value, keydate_comments, last_updated_by, last_updated_dt )
		values (:ll_gigp, 'epgSCOPINGCALL', :ldt_scoping, :ls_scoping_comment, 'SYSTEM', getdate());
	End If
	
	//EFC Comments
	ls_efc_comments = lds_data.GetItemString(ll_row, 'efc_staff_comments')
	
	If lb_update Then
		If ls_efc_comments > '' Then
			insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
			values (:ll_gigp, getdate(), 'NOTE', 'General', 'SYSTEM', :ls_efc_comments);
		End If
	End If


	//Insert Community Assistant Staff Member
	ll_staff = of_get_staff(Trim(lds_data.GetItemString(ll_row, 'efc_community_assistance_staff')))
	
	If lb_update Then
		If ll_staff > 0 Then
			delete gigp_contact_links
			where gigp_id = :ll_gigp
			and contact_type = 'EFCCOMASST';
			
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			values (:ll_staff, :ll_gigp, 'EFCCOMASST');
			
			of_add_log('community assistant staff member set to ' + ls_staff + ' (contact_id = ' + String(ll_staff) + ') for GIGP ' + String(ll_gigp))
			
		End If
	End If
	
	//Insert Legal Staff Member
	ll_staff = of_get_staff(Trim(lds_data.GetItemString(ll_row, 'efc_legal_staff')))
	
	If lb_update Then
		If ll_staff > 0 Then
			delete gigp_contact_links
			where gigp_id = :ll_gigp
			and contact_type = 'EFCLGL';
			
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			values (:ll_staff, :ll_gigp, 'EFCLGL');
			
			of_add_log('Legal staff member set to ' + ls_staff + ' (contact_id = ' + String(ll_staff) + ') for GIGP ' + String(ll_gigp))
			
		End If
	End If
	
	//Insert Engineer Staff Member
	ll_staff = of_get_staff(Trim(lds_data.GetItemString(ll_row, 'efc_engineer_for_base_program')))
	
	If lb_update Then
		If ll_staff > 0 Then
			delete gigp_contact_links
			where gigp_id = :ll_gigp
			and contact_type = 'EFCENG';
			
			insert into gigp_contact_links (contact_id, gigp_id, contact_type)
			values (:ll_staff, :ll_gigp, 'EFCENG');
			
			of_add_log('Engineering staff member set to ' + ls_staff + ' (contact_id = ' + String(ll_staff) + ') for GIGP ' + String(ll_gigp))
			
		End If
	End If
	
	//('Abigail Johnson','Andrea Dzierwa','Benjamin Groth','Bonnie Starr','Bradly Chaffee','Carrie Buetow','Carrie Smith','Chad Sievers','Daniel Hayes','Daniel Judd','David Rarick','Denine Jackson','Donald Cardinal','Elizabeth Ricci','Erica Cruden','Gary Kerzic','Harry Nelson','James Geiger','James Malcolm','James Stearns','Jennifer Zunino-Smith','Jimmy Ng','Josh Hawley','Karen Rusin','Karis Manning',"Kevin O'Connor",'Kirk Bassarab','Kristopher LaPan','Lydia Krembs','Mallory Wright','Manju Cherian','Mary Elprince','Matthew Jackson','Matthew Kazmierski','Meena George','Melanie Stein','Michael Bocchi',"Michael O'Neil",'Molly Detine','Monica Moss','Paula Jacobs','Rebecca Lanahan','Rebecca Mitchell','Rey Caban','Richard Coriale','Richard Rink','Robert Smythe','Ronald Magee','Sandra Lizlovs','Sevon Thompson','Tamara Venne','Tara Blum','Tatsuhiko Murakami','Valarie Ellis','Vijay Gandhi','William Murray','William Smythe')
	
	//Consent Order
	ls_consent = Trim(lds_data.GetItemString(ll_row, 'consent_order'))
	
	Choose Case ls_consent
		Case 'Yes'
			ls_consent_order = 'COOrder'
			
		Case 'Yes (SPDES Sched.)'
			ls_consent_order = 'COComp'
		
		Case 'Yes (Pending)'
			ls_consent_order = 'COOrder'

		Case 'No'
			ls_consent_order = 'CONone'
			
		Case 'No - SPDES'
			ls_consent_order = 'COComp'

		Case else
			ls_consent_order = ''
			
	End Choose
	
	If lb_update Then
		If ls_consent_order > '' Then
			Update gigp_application
			set consent_order = :ls_consent_order
			where gigp_id = :ll_gigp;
		End If
	End If
	
	//REDC Region
	ls_redc = Trim(lds_data.GetItemString(ll_row, 'redc_district'))
	
	If lb_update Then
		If ls_redc > '' Then
			delete gigp_cfa_raw_data
			where app_id = :ll_cfa and
					round_no = :li_round and
					question_id = 548;
						
			insert into gigp_cfa_raw_data (round_no, question_id, app_id, question, answer)
			values (:li_round, 548, :ll_cfa, 'REDC Region from data load', :ls_redc);
			
		End If
	End If
	
	
	//Project Type(s)
	ls_type = Trim(lds_data.GetItemString(ll_row, 'project_type'))
	
//	If lb_update Then
		delete gigp_project_types
		where gigp_id = :ll_gigp;
//	End If
	
	If ls_type > '' Then
		ls_project_types = ls_null
		ln_string.of_parsetoarray(ls_type, ",", ls_project_types)
		
		li_upperbound = UpperBound(ls_project_types)
		
		If li_upperbound > 0 Then
			For li_index = 1 to li_upperbound
				ls_projtypeitem = Trim(ls_project_types[li_index])
				
				If ls_projtypeitem > '' Then
					Choose Case ls_projtypeitem
						Case 'New WWTP', 'Decentralized Treatment', 'New'
							ls_projtypeitem = 'PTNewWWTP'
						Case 'WWTP Improvements', 'WWTP', 'WWTP Split', 'WWTP TMDL', 'WWTP Collection'
							ls_projtypeitem = 'PTWWTPImprov'
						Case 'Consolidation'
							ls_projtypeitem = 'PTConsolidation'
						Case 'Extension'
							ls_projtypeitem = 'PTExtension'
						Case 'Disinfection'
							ls_projtypeitem = 'PTDisinfection'
						Case 'Collection', 'Collection Improvements', 'New Collection'
							ls_projtypeitem = 'PTCollection'
						Case 'CSO'
							ls_projtypeitem = 'PTCSO'
						Case 'I/I'
							ls_projtypeitem = 'PTII'
						Case 'SSO'
							ls_projtypeitem = 'PTSSO'
						Case 'TMDL'
							ls_projtypeitem = 'PTTMDL'
						Case 'Storm Sewer'
							ls_projtypeitem = 'PTStormSewer'
						Case Else
							ls_projtypeitem = ''
					End Choose
					
//					If lb_update Then
						If ls_projtypeitem > '' Then
							insert into gigp_project_types (gigp_id, project_type)
							values (:ll_gigp, :ls_projtypeitem);
						End If
//					End If
					
				End If
			Next
		End If
	End If
	
	
	//Last note item
	ls_note = Trim(lds_data.GetItemString(ll_row, 'asfollow_up_for_listing'))
	
	If lb_update Then
		If ls_note > '' Then
			insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
			values (:ll_gigp, getdate(), 'NOTE', 'General', 'SYSTEM', :ls_note);
			
		End If
	End If


	//	//Update Applicant
//	If ls_applicant > '' Then
//		update gigp_contacts
//		set organization = :ls_applicant
//		where contact_id = (select contact_id
//									from gigp_contact_links
//									where gigp_id = :ll_gigp
//									and contact_type = 'APP');
//									
//		of_add_log('Applicant set to ' + ls_applicant + ' for GIGP ' + String(ll_gigp))
//	End If
//		
//	//Insert Grant Amount
//	If ld_grant > 0 Then
//		ll_amtcount = 0
//		
//		select count(*)
//		into :ll_amtcount
//		from gigp_amounts
//		where gigp_id = :ll_gigp
//		and ref_code = 'GIGPFR'
//		and sub_category = 'Requested';
//		
//		If ll_amtcount <= 0 Then
//			ll_id = f_gettokenvalue('amountID', 1)
//			
//			insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
//			values (:ll_id, :ll_gigp, 'GIGPFR', 'Requested', null, 0, :ld_grant, 'SYSTEM', getdate());
//			
//			of_add_log('Grant amount set to ' + String(ld_grant) + ' for GIGP ' + String(ll_gigp))
//		End If
//		
//	End If

	
	of_add_log('Done with ' + String(ll_gigp))
	
Next

end event

type cb_80 from commandbutton within w_util
integer x = 567
integer y = 228
integer width = 361
integer height = 100
integer taborder = 280
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2017 Load"
end type

event clicked;integer li_district, li_checklist, li_pop, li_programId
decimal ld_metric, ld_amt
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret, ll_awarded_count, ll_award_row, ll_eng
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible, ls_eng
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop, ls_projname, ls_projstatus, ls_desc, ls_location
//string ls_awarded = '*71098*71972*72884*73034*73301*73362*73644*73768*74322*75019*75279*76261*76422*77270*'
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps, lds_awarded
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 2017
li_programId = 366

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

idt_app = DateTime(Date('7/29/2016'))

//Retrieve awarded
lds_awarded = CREATE Datastore
lds_awarded.DataObject = 'd_round2017'
lds_awarded.SetTransObject(SQLCA)

ll_awarded_count = lds_awarded.Retrieve()

of_add_log(String(ll_awarded_count) + ' awarded records found.')


//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_roundxxx_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve(ii_round)

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If


For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ls_busname =  Trim(of_get_answer(546, ll_cfa))
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
//	ls_pop =  Trim(of_get_answer(2622, ll_cfa))	//********NOT IN CURRENT LIST OF QUESTIONS

	//Get awarded row if exists
	ll_award_row = lds_awarded.Find('cfa_no = ' + string(ll_cfa), 1, ll_awarded_count)
	
	If IsNumber(ls_pop) then
		li_pop = Integer(ls_pop)
	End If
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	
//	If pos(ls_awarded, '*' + String(ll_cfa) + '*') > 0 Then
	If ll_award_row > 0 Then
		ls_funding_rec = 'RECC-H'
		ls_region = String(lds_awarded.GetItemNumber(ll_award_row, 'dec_region'))
		ls_projname = lds_awarded.GetItemString(ll_award_row, 'project_name')
		ls_county = lds_awarded.GetItemString(ll_award_row, 'county')
		ls_projstatus = 'projectActive'
		
		select ref_code
		into :ls_fips
		from gigp_reference
		where category = 'County'
		and ref_value = :ls_county;
		
	Else
		ls_funding_rec = 'DONOTREC'
		SetNull(ls_region)
		ls_projname = ls_busname
		ls_projstatus = 'projectNonfunded'
		SetNull(ls_fips)
		
	End If
	
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete)
	values (:ll_gigpID, :ii_round, 'EPG', :ls_projname, :ls_projstatus, 'CW', 'Design', 90, :ls_region, null, null, null, null, :ls_CFAtype, :ls_type, :idt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, :ls_fips, null, :li_pop, 'CFA Answer', 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, 0);
	
	of_add_log('Application added for ' + ls_busname)
	

	//Crearte CFA Items
	If ls_funding_rec = 'RECC-H' Then
		insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
		values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
		
		of_add_log('CFA Items added for ' + ls_busname)
	End If
	
	
	//Create Summaries
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	If ll_award_row > 0 Then
		ls_desc = lds_awarded.GetItemString(ll_award_row, 'project_description')
		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
		values (:ll_gigpId, :idt_app, 'appNote', 'projDescription', 'SYSTEM', :ls_desc);
	End If
	
	of_add_log('Summaries added for ' + ls_busname)

	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_addr = of_get_answer(928, ll_cfa)
	
//	If IsNull(ls_addr) or ls_addr = '' Then
//		ls_addr = of_get_answer(971, ll_cfa)
//	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	

	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_location = 'Project location record for GIGP ' + String(ll_gigpID)
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_location, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	If (ll_cfa = 74313 or ll_cfa = 75521 or ll_cfa = 76851) Then
		string ls_nothing
		ls_nothing = 'nothing'
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)
	
	If ll_award_row > 0 Then
		ls_applicant = lds_awarded.GetItemString(ll_award_row, 'applicant_name')
	End If
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant);
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	//Add EFC Engineer
	If ll_award_row > 0 Then
		ls_eng = lds_awarded.GetItemString(ll_award_row, 'efc_engineer')
		Choose Case ls_eng
			Case 'Caban'
				ll_eng = 8037
			Case 'Geiger'
				ll_eng = 1136
			Case 'Hawley'
				ll_eng = 7781
			Case 'Krembs'
				ll_eng = 7530
			Case 'Lanahan'
				ll_eng = 7861
			Case 'Nelson'
				ll_eng = 1233
			Case "O'Neil"
				ll_eng = 2885
			Case 'Ricci'
				ll_eng = 6705
			Case 'Rusin'
				ll_eng = 4616
			Case 'Wright'
				ll_eng = 6091
		End Choose
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		values (:ll_eng, :ll_gigpID, 'EFCENG');
		
	End If

	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If

	of_add_log('Done adding Contacts')

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_79 from commandbutton within w_util
integer x = 128
integer y = 228
integer width = 361
integer height = 100
integer taborder = 270
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "2017 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 2017\Round2017.txt')
//ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 9\Round9.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	
//	If pos(ls_approved, '*' + String(ll_app) + '*') > 0 Then
	
		ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
		ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
		ls_email = lds_data.GetItemString(ll_row, 'email')
		ls_question = lds_data.GetItemString(ll_row, 'question')
		ls_answer = lds_data.GetItemString(ll_row, 'answer')
		of_cleanse_text(ls_answer)
		
		insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
		values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
		
		of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
//	End If

Next

of_add_log('Done')
end event

type cb_78 from commandbutton within w_util
integer x = 2322
integer y = 132
integer width = 361
integer height = 100
integer taborder = 270
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R9 SCs"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant, ls_staff, ls_code
string ls_proj, ls_decregion, ls_scoping, ls_scoping_comment, ls_efc_comments, ls_review_agency, ls_consent, ls_consent_order, ls_redc, ls_project_name
string ls_project_types[], ls_type, ls_projtypeitem, ls_note, ls_null[]
datetime ldt_scoping
integer li_create, li_round, li_upperbound, li_index
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app, ll_staff, ll_amtcount
decimal ld_grant
boolean lb_update = False
n_ds lds_data
n_cst_string ln_string

/////////////////////////// update ability - set to true ///////////////////////////
lb_update = False
/////////////////////////// update ability /////////////////////////////////////////


//ls_syntax = sqlca.SyntaxFromSQL('select gigp_id, cfa_no from gigp_application where round_no = 9', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL('select ref_code, description from gigp_reference where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 9\Round9SpecialConditions.txt')
//ll_ret = lds_data.Retrieve()

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

delete gigp_reference
where category = 'specialCondition'
and sub_category = '9'
and ref_code <> 'CUSTOM09';

For ll_row = 1 to ll_ret
	ls_code = lds_data.GetItemString(ll_row, 'ref_code')
	ls_desc = lds_data.GetItemString(ll_row, 'description')
	
	insert into gigp_reference (category, sub_category, ref_code, ref_value, description, cat_default, system_only, sort_order)
	values ('specialCondition', '9', :ls_code, :ls_code, :ls_desc, 0, 0, 10);
	
	of_add_log('Done with ' + ls_code)
	
Next

end event

type cb_77 from commandbutton within w_util
integer x = 2327
integer y = 568
integer width = 361
integer height = 100
integer taborder = 250
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R8 Updates"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id
decimal ld_federal, ld_local, ld_private, ld_state, ld_award, ld_fr
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select 9999 as cfa_no,ref_value as regions, ref_value as federal,ref_value as local,ref_value as private,ref_value as state,ref_value as fr,ref_value as tpc,ref_value as award,ref_value as ProjectName,description as efc_desc from gigp_reference where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 8\Datacorrections_020617.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	ls_regions = lds_data.GetItemString(ll_row, 'regions')
	ld_federal = Dec(lds_data.GetItemString(ll_row, 'federal'))
	ld_local =  Dec(lds_data.GetItemString(ll_row, 'local'))
	ld_private =  Dec(lds_data.GetItemString(ll_row, 'private'))
	ld_state =  Dec(lds_data.GetItemString(ll_row, 'state'))
	ld_fr =  Dec(lds_data.GetItemString(ll_row, 'fr'))
	ld_award =  Dec(lds_data.GetItemString(ll_row, 'award'))
	ls_name = lds_data.GetItemString(ll_row, 'ProjectName')
	ls_desc = lds_data.GetItemString(ll_row, 'efc_desc')
	
	//Regions
	insert into gigp_cfa_raw_data (round_no, question_id, app_id, question, answer)
	values (8, 548, :ll_cfa, 'Regions (EFC loaded)', :ls_regions);
	
	//Project Name
	update gigp_application
	set project_name = :ls_name
	where gigp_id = :ll_gigp;
	
	//EFC Project Desc
	insert into gigp_notes(gigp_id, note_dt, note_category, note_type, user_id, comments)
	values (:ll_gigp, getdate(), 'appNote', 'projDescription', 'SYSTEM', :ls_desc);
	
	//Amounts
	ll_id = f_gettokenvalue('amountID', 1)
	If IsNull(ld_fr) Then ld_fr = 0
	If IsNull(ld_award) Then ld_award = 0
	
	delete gigp_amounts
	where gigp_id = :ll_gigp;
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'GIGPFR', 'Requested', '', :ld_fr, :ld_award, 'SYSTEM', getdate());
	
	
	If ld_federal > 0 Then
		ll_id = f_gettokenvalue('amountID', 1)
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values(:ll_id, :ll_gigp, 'FUNDFEDERAL', 'Federal', '', :ld_federal, 0, 'SYSTEM', getdate());
	End If
	
	If ld_local > 0 Then
		ll_id = f_gettokenvalue('amountID', 1)
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_id, :ll_gigp, 'FUNDLOCAL', 'Local', '', :ld_local, 0, 'SYSTEM', getdate());
	End If
	
	If ld_private > 0 Then
		ll_id = f_gettokenvalue('amountID', 1)
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_id, :ll_gigp, 'FUNDPRIVATE', 'Private', '', :ld_private, 0, 'SYSTEM', getdate());
	End If
	
	If ld_state > 0 Then
		ll_id = f_gettokenvalue('amountID', 1)
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_id, :ll_gigp, 'FUNDSTATE', 'State', '', :ld_state, 0, 'SYSTEM', getdate());
	End If
	
	
	of_add_log('Done with ' + String(ll_gigp))
	
Next

end event

type cb_76 from commandbutton within w_util
integer x = 1883
integer y = 132
integer width = 361
integer height = 100
integer taborder = 260
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R9 Amts"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant
decimal ld_fundsrequsted, ld_grantamount, ld_totalproject, ld_totalprojectcost
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app
decimal ld_federal, ld_local, ld_private, ld_state, ld_award, ld_fr
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_round9amts', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.Retrieve()

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	ld_fundsrequsted = lds_data.GetItemDecimal(ll_row, 'fundsrequested')
	If IsNull(ld_fundsrequsted) Then ld_fundsrequsted = 0
	
	ld_grantamount = lds_data.GetItemDecimal(ll_row, 'grantamount')
	If IsNull(ld_grantamount) Then ld_grantamount = 0
	
	ld_totalproject = lds_data.GetItemDecimal(ll_row, 'totalproject') - ld_grantamount
	If IsNull(ld_totalproject) Then ld_totalproject = 0
	
	ld_totalprojectcost = lds_data.GetItemDecimal(ll_row, 'totalprojectcost')
	If IsNull(ld_totalprojectcost) Then ld_totalprojectcost = 0
	
	
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'GIGPFR', 'Requested', null, :ld_fundsrequsted, :ld_grantamount, 'SYSTEM', getdate());
	
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'FUNDLOCAL', 'Local', null, :ld_totalprojectcost, :ld_totalproject, 'SYSTEM', getdate());
	
	
	of_add_log('Done with amounts for ' + String(ll_gigp))
	
Next

end event

type cb_75 from commandbutton within w_util
integer x = 1888
integer y = 568
integer width = 361
integer height = 100
integer taborder = 250
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R104 Eng"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep
decimal ld_amt
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select 9999 as cfa_no, 8888 as representative from gigp_reference where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 104\R104LoadEng.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ll_rep = lds_data.GetItemNumber(ll_row, 'representative')

	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	values (:ll_rep, :ll_gigp, 'EPGASSIGN');
	
	of_add_log('Rep added for ' + String(ll_gigp))
	
Next

end event

type cb_74 from commandbutton within w_util
integer x = 1445
integer y = 132
integer width = 361
integer height = 100
integer taborder = 260
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R9 Updates"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc, ls_applicant
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id, ll_app
decimal ld_federal, ld_local, ld_private, ld_state, ld_award, ld_fr
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select 9999 as cfa_no, project_name, space(500) as applicant_name from gigp_application where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 9\UpdateAppNameProjName.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	ls_name = lds_data.GetItemString(ll_row, 'project_name')
	ls_applicant = lds_data.GetItemString(ll_row, 'applicant_name')
	
	//Project Name
	update gigp_application
	set project_name = :ls_name
	where gigp_id = :ll_gigp;
	
	of_add_log('updated project name for gigp ' + string(ll_gigp) + ' to ' + ls_name)
	
	select max(contact_id)
	into :ll_app
	from gigp_contact_links
	where gigp_id = :ll_gigp
	and contact_type = 'APP';
	
	If ll_app > 0 Then
		update gigp_contacts
		set organization = :ls_applicant
		where contact_id = :ll_app;
		
		of_add_log('updated applicant for ' + string(ll_gigp) + ' to ' + ls_applicant)
		
	End If
	
	of_add_log('Done with ' + String(ll_gigp))
	
Next

end event

type cb_73 from commandbutton within w_util
integer x = 1449
integer y = 568
integer width = 361
integer height = 100
integer taborder = 250
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = " R104 Update"
end type

event clicked;long ll_ret, ll_row, ll_gigp, ll_cfa, ll_amt_id, ll_count, ll_plc
string ls_press, ls_comment, ls_regions, ls_busname, ls_addr, ls_city, ls_county, ls_zip, ls_longitude, ls_latitude, ls_phone, ls_fips
integer li_senate, li_assembly
decimal ld_contract_amt, ld_local_amt
datetime ldt_compl, ldt_sent
n_cst_string ln_string
datastore lds_data

If NOT IsValid(lds_data) Then lds_data = CREATE datastore
lds_data.DataObject = 'd_cfa_tracking_rpt'
ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 104\R104Updates.txt')

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

ldt_sent = DateTime(Date('12/9/2016'))
ldt_compl = DateTime(Date('12/9/2017'))

For ll_row = 1 to ll_ret
	ll_cfa = Long(Trim(lds_data.GetItemString(ll_row, 'CFA_System_Application_Number')))
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	of_add_log('CFA Id: ' + String(ll_cfa) + ';  GIGP = ' +  String(ll_gigp))
	
	//Press Ready
	ls_press = lds_data.GetItemString(ll_row, 'Press_Ready_Description_2')
	
	of_add_log(ls_press)
	
	delete gigp_notes where gigp_id = :ll_gigp and note_type = 'pressreadyDesc';
	
	insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
	values (:ll_gigp, getdate(), 'appNote', 'pressreadyDesc', 'SYSTEM', :ls_press);
	
	//Amounts
	delete gigp_amounts where gigp_id = :ll_gigp;
	
	ld_contract_amt = Dec(lds_data.GetItemString(ll_row, 'CFA_Award_Amount_3'))
	ld_local_amt = Dec(lds_data.GetItemString(ll_row, 'Local_Sources_15'))
	
	of_add_log(string(ld_contract_amt))
	of_add_log(string(ld_local_amt))
	
	ll_amt_id = f_gettokenvalue('amountID', 1)
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_amt_id, :ll_gigp, 'GIGPFR', 'Requested', 'From Spreadsheet', :ld_contract_amt, :ld_contract_amt, 'SYSTEM', getdate());
	
	ll_amt_id = f_gettokenvalue('amountID', 1)
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_amt_id, :ll_gigp, 'FUNDLOCAL', 'Local', 'From Spreadsheet', :ld_local_amt, :ld_local_amt, 'SYSTEM', getdate());
	
	//CFA Items (update)
	delete gigp_cfa_items where gigp_id = :ll_gigp;
	
	ls_comment = lds_data.GetItemString(ll_row, 'Project_Status_Comment_31')
	
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by, contract_award_amt, percent_complete, project_status_comment)
	values (:ll_gigp, 'statusPending', 'statusOrange', getdate(), 'SYSTEM', :ld_contract_amt, 0, :ls_comment);

	of_add_log(ls_comment)
	
	
	//Regions
	ls_regions = lds_data.GetItemString(ll_row, 'Regions')
	
//	insert into gigp_cfa_raw_data(round_no, question_id, app_id, question, answer)
//	values(104, 548, :ll_cfa, 'Region', :ls_regions);
	
	of_add_log(ls_regions)
	
	//Key Dates
	delete gigp_key_dates where gigp_id = :ll_gigp;
	
	insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
	values (:ll_gigp, 'agreeCOMLTRSEN', :ldt_sent, 'SYSTEM', getdate());
	
	insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
	values (:ll_gigp, 'epgANTICIPATEDCOMPL', :ldt_compl, 'SYSTEM', getdate());
	
	
	//Location data - replace
	delete gigp_contacts
	where contact_id = (select contact_id from gigp_contact_links where gigp_id = :ll_gigp and contact_type = 'PLC');
	
	select contact_id
	into :ll_plc
	from gigp_contact_links
	where contact_type = 'PLC'
	and gigp_id = :ll_gigp;
	
	ls_busname = ' (Project location record for GIGP ' + String(ll_gigp) + ')'
	ls_addr = lds_data.GetItemString(ll_row, 'Street_Address_4')
	ls_city = lds_data.GetItemString(ll_row, 'City_5')
	ls_zip = lds_data.GetItemString(ll_row, 'Zip_7')
	ls_latitude = lds_data.GetItemString(ll_row, 'Latitude_49')
	ls_longitude = lds_data.GetItemString(ll_row, 'Longtitude_50')
	
	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_busname, :ls_addr, :ls_city, 'NY', :ls_zip, 'Active', 'SYSTEM', getdate(), :ls_longitude, :ls_latitude);
	
	//County
	ls_county = lds_data.GetItemString(ll_row, 'County_6')
	
	of_add_log(ls_county)
	
	select ref_code
	into :ls_fips
	from gigp_reference 
	where category = 'County'
	and ref_value = :ls_county;
	
	update gigp_application
	set county_fips_code = :ls_fips
	where gigp_id = :ll_gigp;
	
	//Political Districts (update)
	delete gigp_political_districts
	where contact_id = :ll_plc;
	
	li_senate = Integer(lds_data.GetItemString(ll_row, 'Senate_District_8'))
	li_assembly = Integer(lds_data.GetItemString(ll_row, 'Assembly_District_9'))
	
	insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
	values(:ll_plc, 'nysSenate', :li_senate, 2010);
				
	insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
	values(:ll_plc, 'nysAssembly', :li_assembly, 2010);

	of_add_log('Senate: ' + string(li_senate))
	of_add_log('Assembly: ' + string(li_assembly))


Next

If IsValid(lds_data) then DESTROY lds_data
end event

type cb_72 from commandbutton within w_util
integer x = 1006
integer y = 132
integer width = 361
integer height = 100
integer taborder = 260
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R9"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist, li_pop, li_programId
decimal ld_metric, ld_amt
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop
string ls_awarded = '*71098*71972*72884*73034*73301*73362*73644*73768*74322*75019*75279*76261*76422*77270*'
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 9
li_programId = 355

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

ldt_app = DateTime(Date('7/29/2016'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_roundxxx_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve(ii_round)

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If


For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ls_busname =  Trim(of_get_answer(546, ll_cfa))
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
//	ls_pop =  Trim(of_get_answer(2622, ll_cfa))	//********NOT IN CURRENT LIST OF QUESTIONS
	
	If IsNumber(ls_pop) then
		li_pop = Integer(ls_pop)
	End If
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	
	If pos(ls_awarded, '*' + String(ll_cfa) + '*') > 0 Then
		ls_funding_rec = 'RECC-H'
	Else
		ls_funding_rec = 'DONOTREC'
	End If
	
	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id, project_pct_complete)
	values (:ll_gigpID, :ii_round, 'GIGP', :ls_busname, 'projectActive', 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, :li_pop, 'CFA Answer', 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId, 0);
	
	of_add_log('Application added for ' + ls_busname)
	

	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
	
	//Create Metrics  
	of_insertMetric(1282, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OSAVE')	
	of_insertMetric(1285, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OREUSE')
	
//	of_insertMetric(6701, ll_gigpID, ll_cfa, 'Green Infrastructure', 'RUNOFFREDUCTION')
//	of_insertMetric(6639, ll_gigpID, ll_cfa, 'Green Infrastructure', 'TONSYEARSEDIMENT')
//	of_insertMetric(6638, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADSALT')
//	of_insertMetric(6635, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADPHOS')
//	of_insertMetric(6634, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADNITR')
//	of_insertMetric(1524, ll_gigpID, ll_cfa, 'Green Infrastructure', 'GREENROOFAREA')

	of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
//	of_insertSummary(1297, ll_gigpId, ll_cfa, 'waterBodies')	//********NOT IN CURRENT LIST OF QUESTIONS
	of_insertSummary(1296, ll_gigpId, ll_cfa, 'additWaterQualBen')
//	of_insertSummary(1295, ll_gigpId, ll_cfa, 'spurGreenInnov')	//********NOT IN CURRENT LIST OF QUESTIONS
//	of_insertSummary(1294, ll_gigpId, ll_cfa, 'buildGreenCapacty')
//	of_insertSummary(1270, ll_gigpId, ll_cfa, 'projMonitoring')	//********NOT IN CURRENT LIST OF QUESTIONS
	of_insertSummary(1268, ll_gigpId, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_add_log('Summaries added for ' + ls_busname)

	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_addr = of_get_answer(928, ll_cfa)
	
//	If IsNull(ls_addr) or ls_addr = '' Then
//		ls_addr = of_get_answer(971, ll_cfa)
//	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	If ll_cfa = 71098 or ll_cfa = 73768 or ll_cfa = 76261 Then
		SetNull(ll_plc)
	End If
	
	
	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_busname = 'Project location record for GIGP ' + String(ll_gigpID)
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_city = of_get_answer(552, ll_cfa)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and upper(mail_city) = upper(:ls_city);
	
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If

	of_add_log('Done adding Contacts')

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_71 from commandbutton within w_util
integer x = 1010
integer y = 568
integer width = 361
integer height = 100
integer taborder = 250
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R104  Load"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist, li_pop, li_programId
decimal ld_metric, ld_amt
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 104
li_programId = 314

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

ldt_app = DateTime(Date('7/29/2016'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_roundxxx_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve(ii_round)

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If


For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ls_busname =  Trim(of_get_answer(546, ll_cfa))
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
//	ls_pop =  Trim(of_get_answer(2622, ll_cfa))	//********NOT IN CURRENT LIST OF QUESTIONS
	
	If IsNumber(ls_pop) then
		li_pop = Integer(ls_pop)
	End If
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'

	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id)
	values (:ll_gigpID, :ii_round, 'EPG', :ls_busname, 'projectActive', 'CW', 'Design', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, :li_pop, 'CFA Answer', 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId);
	
	of_add_log('Application added for ' + ls_busname)
	

	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
	
	
	//Create Summaries
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_add_log('Summaries added for ' + ls_busname)

	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_addr = of_get_answer(928, ll_cfa)
	
	If IsNull(ls_addr) or ls_addr = '' Then
		ls_addr = of_get_answer(971, ll_cfa)
	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_busname = ' (Project location record for GIGP ' + String(ll_gigpID) + ')'
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_city = of_get_answer(552, ll_cfa)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and upper(mail_city) = upper(:ls_city);
	
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If

	of_add_log('Done adding Contacts')

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_70 from commandbutton within w_util
integer x = 567
integer y = 132
integer width = 361
integer height = 100
integer taborder = 260
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R9 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
//ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 103\Round103.txt')
ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 9\Round9.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	
//	If pos(ls_approved, '*' + String(ll_app) + '*') > 0 Then
	
		ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
		ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
		ls_email = lds_data.GetItemString(ll_row, 'email')
		ls_question = lds_data.GetItemString(ll_row, 'question')
		ls_answer = lds_data.GetItemString(ll_row, 'answer')
		of_cleanse_text(ls_answer)
		
		insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
		values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
		
		of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
//	End If

Next

of_add_log('Done')
end event

type cb_69 from commandbutton within w_util
integer x = 571
integer y = 568
integer width = 361
integer height = 100
integer taborder = 250
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R104 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
//string ls_approved = '*50989*51503*51603*51720*52055*52554*53054*53204*53713*53965*54085*54254*54295*54310*54659*55086*55098*55364*55537*55925*55996*56088*56140*56148*56336*56376*56740*56745*56843*57022*57419*'
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
//ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 103\Round103.txt')
ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 104\Round104.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	
//	If pos(ls_approved, '*' + String(ll_app) + '*') > 0 Then
	
		ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
		ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
		ls_email = lds_data.GetItemString(ll_row, 'email')
		ls_question = lds_data.GetItemString(ll_row, 'question')
		ls_answer = lds_data.GetItemString(ll_row, 'answer')
		of_cleanse_text(ls_answer)
		
		insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
		values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
		
		of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
//	End If

Next

of_add_log('Done')
end event

type cb_68 from commandbutton within w_util
integer x = 128
integer y = 132
integer width = 361
integer height = 100
integer taborder = 250
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Proj Ben~'s"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_regions, ls_name, ls_desc
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep, ll_id
decimal ld_federal, ld_local, ld_private, ld_state, ld_award, ld_fr
decimal ld_p, ld_wqv, ld_gallons, ld_linft, ld_acres
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('SELECT dbo.gigp_application.gigp_id, dbo.gigp_application.round_no, dbo.gigp_application.project_name, 0.00 as "p_inches", 0.00 as "wqv", 0.00 as "gallons", 0.00 as "linft", 0.00 as "acres" FROM dbo.gigp_application WHERE dbo.gigp_application.funding_recommendation = "RECC-H"', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.Retrieve()

If MessageBox('Import', String(ll_ret) + ' rows found. Continue?', Question!, YesNo!, 1) = 2 Then Return

For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	If f_get_project_benefit_totals(ll_gigp, ld_p, ld_wqv, ld_gallons, ld_linft, ld_acres) > 0 Then
		lds_data.SetItem(ll_row, 'p_inches', ld_p)
		lds_data.SetItem(ll_row, 'wqv', ld_wqv)
		lds_data.SetItem(ll_row, 'gallons', ld_gallons)
		lds_data.SetItem(ll_row, 'linft', ld_linft)
		lds_data.SetItem(ll_row, 'acres', ld_acres)
		
	End If
	
Next

lds_data.SaveAs("c:\GIGPProjectBenefits.xlsx", XLSX!, True)

MessageBox('Extract', 'Done')

Return ll_ret
end event

type cb_67 from commandbutton within w_util
integer x = 133
integer y = 568
integer width = 361
integer height = 100
integer taborder = 250
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R8 Updates"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id
decimal ld_fundreq, ld_recfund, ld_tpc, ld_eligible, ld_req, ld_app
n_ds lds_data

ii_round = 8

//ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_application where round_no = 102', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_round8', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows retrieved. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	
	ld_fundreq = lds_data.GetItemNumber(ll_row, 'fundreq')
	ld_recfund = lds_data.GetItemNumber(ll_row, 'recfund')
	ld_tpc = lds_data.GetItemNumber(ll_row, 'tpc')
	ld_eligible = lds_data.GetItemNumber(ll_row, 'eligible')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	ll_id = f_gettokenvalue('amountID', 1)
	ld_req = ld_fundreq
	ld_app = ld_recfund
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'GIGPFR', 'Requested', 'From Spreadsheet', :ld_req, :ld_app, 'SYSTEM', getdate());
	
	of_add_log('Amounts added for ' + string(ll_gigp) + ' for GIGPFR as ' + string(ld_req) + ' and ' + string(ld_app))
	
	
	ll_id = f_gettokenvalue('amountID', 1)
	ld_req = ld_tpc - ld_fundreq
	ld_app = ld_eligible - ld_recfund
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'FUNDLOCAL', 'Local', 'From Spreadsheet', :ld_req, :ld_app, 'SYSTEM', getdate());
	
	of_add_log('Amounts added for ' + string(ll_gigp) + ' for FUNDLOCAL as ' + string(ld_req) + ' and ' + string(ld_app))
	

Next

of_add_log('Done loading amounts')
end event

type cb_66 from commandbutton within w_util
integer x = 1888
integer y = 472
integer width = 361
integer height = 100
integer taborder = 240
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R8 Raw"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
//string ls_approved = '*50989*51503*51603*51720*52055*52554*53054*53204*53713*53965*54085*54254*54295*54310*54659*55086*55098*55364*55537*55925*55996*56088*56140*56148*56336*56376*56740*56745*56843*57022*57419*'
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
//ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 103\Round103.txt')
ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 8\Round8.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	
//	If pos(ls_approved, '*' + String(ll_app) + '*') > 0 Then
	
		ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
		ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
		ls_email = lds_data.GetItemString(ll_row, 'email')
		ls_question = lds_data.GetItemString(ll_row, 'question')
		ls_answer = lds_data.GetItemString(ll_row, 'answer')
		of_cleanse_text(ls_answer)
		
		insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
		values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
		
		of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
//	End If

Next

of_add_log('Done')
end event

type cb_65 from commandbutton within w_util
integer x = 2327
integer y = 472
integer width = 361
integer height = 100
integer taborder = 230
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R8"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist, li_pop, li_programId
decimal ld_metric, ld_amt
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 8
li_programId = 336

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

ldt_app = DateTime(Date('7/29/2016'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_roundxxx_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve(ii_round)

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If


For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ls_busname =  Trim(of_get_answer(546, ll_cfa))
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	ls_pop =  Trim(of_get_answer(2622, ll_cfa))	//********NOT IN CURRENT LIST OF QUESTIONS
	
	If IsNumber(ls_pop) then
		li_pop = Integer(ls_pop)
	End If
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'

	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id)
	values (:ll_gigpID, :ii_round, 'GIGP', :ls_busname, 'projectActive', 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, :li_pop, 'CFA Answer', 0, getdate(), 'SYSTEM', :ll_cfa, 0, :li_programId);
	
	of_add_log('Application added for ' + ls_busname)
	

	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
	
	//Create Metrics  
	of_insertMetric(1282, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OSAVE')	
	of_insertMetric(1285, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OREUSE')	
	of_insertMetric(1288, ll_gigpID, ll_cfa, 'Green Infrastructure', 'RUNOFFREDUCTION')
	of_insertMetric(1291, ll_gigpID, ll_cfa, 'Green Infrastructure', 'TONSYEARSEDIMENT')
	of_insertMetric(1314, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADSALT')
	of_insertMetric(1312, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADPHOS')
	of_insertMetric(1310, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADNITR')
	of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
//	of_insertSummary(1297, ll_gigpId, ll_cfa, 'waterBodies')	//********NOT IN CURRENT LIST OF QUESTIONS
	of_insertSummary(1296, ll_gigpId, ll_cfa, 'additWaterQualBen')
//	of_insertSummary(1295, ll_gigpId, ll_cfa, 'spurGreenInnov')	//********NOT IN CURRENT LIST OF QUESTIONS
	of_insertSummary(1294, ll_gigpId, ll_cfa, 'buildGreenCapacty')
//	of_insertSummary(1270, ll_gigpId, ll_cfa, 'projMonitoring')	//********NOT IN CURRENT LIST OF QUESTIONS
	of_insertSummary(1268, ll_gigpId, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_add_log('Summaries added for ' + ls_busname)

	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_addr = of_get_answer(928, ll_cfa)
	
	If IsNull(ls_addr) or ls_addr = '' Then
		ls_addr = of_get_answer(971, ll_cfa)
	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	//GOING TO ADD NEW PROJECT LOCATION RECORDS FOR GIS 
	of_add_log('New Project Location record added for ' + String(ll_gigpId))
	
	ll_plc = f_gettokenvalue('contactID', 1)
	
	ls_busname += ' (Project location record for GIGP ' + String(ll_gigpID) + ')'
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_city = of_get_answer(552, ll_cfa)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and upper(mail_city) = upper(:ls_city);
	
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If

	of_add_log('Done adding Contacts')

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps

end event

type cb_64 from commandbutton within w_util
integer x = 1449
integer y = 472
integer width = 361
integer height = 100
integer taborder = 230
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "P && WQv"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_desc, ls_file, ls_grant, ls_color, ls_fips
long ll_ret, ll_row, ll_find, ll_question, ll_save, ll_cfa, ll_gigp, ll_count
decimal ld_lat, ld_long, ld_p, ld_wqv
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_application where funding_recommendation = "RECC-H"', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.Retrieve()

If MessageBox('Data Import', String(ll_ret) + ' data rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

delete gigp_project_metrics
where ref_code = 'WQVTOTAL';

delete gigp_project_metrics
where ref_code = 'PINCHES';

For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	ls_fips = lds_data.GetItemString(ll_row, 'county_fips_code')
	
	//Determine P value based on County
	Choose Case ls_fips
			
		Case '059','103','005','061','085','047','081'
			ld_p = 1.5
			
		Case '105','111','039','021','027','079','071','119','087'
			ld_p = 1.3
			
		Case '001','083','093','057','043','065','049','041','113','035','091','115'
			ld_p = 1.1
			
		Case Else
			ld_p = 1.0
			
	End Choose
	
	//Insert P value metric
	insert into gigp_project_metrics (gigp_id, category, sub_category, ref_code, metric_value, last_updated_by, last_updated_dt, comments, design_calc_id, metric_source)
	values (:ll_gigp, 'projectMetric', '1. Green Infrastructure', 'PINCHES', :ld_p, 'SYSTEM', getdate(), null, null, null);
	
	ld_wqv = f_calculate_total_wqv(ll_gigp, ld_p)
	
	If NOT IsNull(ld_wqv) Then
		insert into gigp_project_metrics (gigp_id, category, sub_category, ref_code, metric_value, last_updated_by, last_updated_dt, comments, design_calc_id, metric_source)
		values (:ll_gigp, 'projectMetric', '1. Green Infrastructure', 'WQVTOTAL', :ld_wqv, 'SYSTEM', getdate(), null, null, null);
	End If
	
	of_add_log('P value added for GIGP ' + string(ll_gigp) + ' = ' + string(ld_p) + ' and WQv added as ' + String(ld_wqv))

Next

of_add_log("Done.")

end event

type cb_63 from commandbutton within w_util
integer x = 1010
integer y = 472
integer width = 361
integer height = 100
integer taborder = 230
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Pop new col"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_desc, ls_file, ls_grant, ls_color
long ll_ret, ll_row, ll_find, ll_question, ll_save, ll_cfa, ll_gigp, ll_count
decimal ld_lat, ld_long, ld_amt
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select gigp_id from gigp_cfa_items', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.Retrieve()

If MessageBox('Data Import', String(ll_ret) + ' data rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	select grant_status
	into :ls_grant
	from gigp_cfa_items
	where gigp_id = :ll_gigp;
	
	If ls_grant = 'statusClosed' Then
		select sum(release_amt)
		into :ld_amt
		from gigp_disbursement_request
		where gigp_id = :ll_gigp;
		
		of_add_log('Disbursed amount added for gigp ' + string(ll_gigp) + ' for $' + string(ld_amt))
		
	Else
		select approved_amt
		into :ld_amt
		from gigp_amounts
		where gigp_id = :ll_gigp
		and ref_code = 'GIGPFR';
		
		of_add_log('Approved amount added for gigp ' + string(ll_gigp) + ' for $' + string(ld_amt))
		
	End If
		
	update gigp_cfa_items
	set contract_award_amt = :ld_amt
	where gigp_id = :ll_gigp;
	
Next

of_add_log("Done.")


end event

type cb_62 from commandbutton within w_util
integer x = 571
integer y = 472
integer width = 361
integer height = 100
integer taborder = 220
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "CFA Data"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_desc, ls_file, ls_grant, ls_color
long ll_ret, ll_row, ll_find, ll_question, ll_save, ll_cfa, ll_gigp, ll_count
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select gigp_id from gigp_application where program = "EPG"', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.Retrieve()

If MessageBox('Data Import', String(ll_ret) + ' data rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	select grant_status, project_status
	into :ls_grant, :ls_color
	from gigp_cfa_items
	where gigp_id = :ll_gigp;
	
	If ls_grant = 'statusPending' and ls_color = 'statusOrange' Then
		update gigp_cfa_items
		set project_status_comment = 'The grant award letter has been sent out and documents to develop the grant agreement are being collected.',
			percent_complete = 0
		where gigp_id = :ll_gigp;	
		
		of_add_log('Updated CFA Items for GIGP ' + string(ll_gigp))
		
	End If

Next

of_add_log("Done.")


end event

type cb_61 from commandbutton within w_util
integer x = 133
integer y = 472
integer width = 361
integer height = 100
integer taborder = 220
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R7 Regions"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_desc, ls_county, ls_region, ls_fips, ls_file
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id, ll_count
integer li_round, li_awarded
decimal ld_fund_req, ld_tpc, ld_elig, ld_rec_fund, ld_req, ld_app
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, project_name from gigp_application where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)

ls_file = 'G:\GIGP\Round 7\Round7Regions.txt'

ll_ret = lds_data.ImportFile(Text!, ls_file)


If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	
	select count(*)
	into :ll_count
	from gigp_application
	where cfa_no = :ll_cfa;
	
	If ll_count > 0 Then
		ls_region = 	lds_data.GetItemString(ll_row, 'project_name')		//Just using project name as a place holder
	
		select gigp_id, round_no
		into :ll_gigp, :li_round
		from gigp_application
		where cfa_no = :ll_cfa;
		
		of_add_log('Begin GIGP ' + String(ll_gigp) + ' *******************************')
		
		insert into gigp_cfa_raw_data (round_no, question_id, app_id, question, answer)
		values (:li_round, 548, :ll_cfa, 'Select your region. If your project spans multiple regions; select all regions that apply.', :ls_region);
		
		of_add_log('Region: ' + ls_region + ' added.')
		
		of_add_log('Done with GIGP ' + String(ll_gigp) + ' *******************************')

	End If

Next

of_add_log('Done')
end event

type cb_60 from commandbutton within w_util
integer x = 2327
integer y = 376
integer width = 361
integer height = 100
integer taborder = 210
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R103 Addr~'s"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_street1, ls_street2, ls_city, ls_state, ls_zip
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id, ll_count, ll_plc
integer li_round, li_awarded
decimal ld_fund_req, ld_tpc, ld_elig, ld_rec_fund, ld_req, ld_app
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_addresses', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	
	select count(*)
	into :ll_count
	from gigp_application
	where cfa_no = :ll_cfa;
	
	If ll_count > 0 Then
		ls_street1 = ''
		ls_street2 = ''
		ls_city = ''
		ls_state = ''
		ls_zip = ''
		
		ls_street1 = lds_data.GetItemString(ll_row, 'street1')
		ls_street2 = lds_data.GetItemString(ll_row, 'street2')
		ls_city = lds_data.GetItemString(ll_row, 'city')
		ls_state = lds_data.GetItemString(ll_row, 'state')
		ls_zip = lds_data.GetItemString(ll_row, 'zip')

		select gigp_id, round_no
		into :ll_gigp, :li_round
		from gigp_application
		where cfa_no = :ll_cfa;
		
		select contact_id
		into:ll_plc
		from gigp_contact_links
		where gigp_id = :ll_gigp
		and contact_type = 'PLC';
		
		update gigp_contacts
		set mail_address1 = :ls_street1,
		mail_address2 = :ls_street2,
		mail_city = :ls_city,
		mail_state = :ls_state,
		mail_zip = :ls_zip
		where contact_id = :ll_plc;
		
		of_add_log('Done with GIGP ' + String(ll_gigp) + ' *******************************')

	End If

Next

of_add_log('Done')
end event

type cb_59 from commandbutton within w_util
integer x = 1888
integer y = 376
integer width = 361
integer height = 100
integer taborder = 210
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R103 Addl"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_desc, ls_county, ls_region, ls_fips
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id, ll_count
integer li_round, li_awarded
decimal ld_fund_req, ld_tpc, ld_elig, ld_rec_fund, ld_req, ld_app
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_data', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	
	select count(*)
	into :ll_count
	from gigp_application
	where cfa_no = :ll_cfa;
	
	If ll_count > 0 Then
		ls_desc = lds_data.GetItemString(ll_row, 'summary')
		ls_county = lds_data.GetItemString(ll_row, 'county')
		ls_region = 	lds_data.GetItemString(ll_row, 'region')
	
		select gigp_id, round_no
		into :ll_gigp, :li_round
		from gigp_application
		where cfa_no = :ll_cfa;
		
		of_add_log('Begin GIGP ' + String(ll_gigp) + ' *******************************')
		
		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
		values (:ll_gigp, getdate(), 'appNote', 'pressreadyDesc', 'SYSTEM', :ls_desc);
		
		of_add_log('Press Ready Description added: ' + ls_desc)
		
		ls_fips = ''
		
		select ref_code
		into :ls_fips
		from gigp_reference
		where category = 'County'
		and upper(ref_value) = :ls_county;
		
		of_add_log('FIPS County found: ' + ls_fips)
		
		If ls_fips > '' Then
			update gigp_application
			set county_fips_code = :ls_fips
			where gigp_id = :ll_gigp;
		End If
		
		update gigp_cfa_items
		set percent_complete = 0
		where gigp_id = :ll_gigp;
		
		insert into gigp_cfa_raw_data (round_no, question_id, app_id, question, answer)
		values (:li_round, 548, :ll_cfa, 'Select your region. If your project spans multiple regions; select all regions that apply.', :ls_region);
		
		of_add_log('Region:o ' + ls_region + ' added.')
		
		of_add_log('Done with GIGP ' + String(ll_gigp) + ' *******************************')

	End If

Next

of_add_log('Done')
end event

type cb_58 from commandbutton within w_util
integer x = 1449
integer y = 376
integer width = 361
integer height = 100
integer taborder = 210
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load Data"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_sum, ls_name, ls_app_status, ls_regions, ls_project_status, ls_fundrec
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id
integer li_round, li_awarded
decimal ld_fund_req, ld_tpc, ld_elig, ld_rec_fund, ld_req, ld_app
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_new_round_data', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
//	li_round = lds_data.GetItemNumber(ll_row, 'round_no')
//	ls_name =  lds_data.GetItemString(ll_row, 'project_name')
//	ld_fund_req = lds_data.GetItemDecimal(ll_row, 'funding_requested')
//	ld_tpc = lds_data.GetItemDecimal(ll_row, 'total_project_cost')
//	ld_elig = lds_data.GetItemDecimal(ll_row, 'eligible_total_cost')
//	ld_rec_fund = lds_data.GetItemDecimal(ll_row, 'recommended_funding')
//	ls_app_status =  Upper(lds_data.GetItemString(ll_row, 'program_status'))
//	li_awarded = lds_data.GetItemNumber(ll_row, 'awarded')
//	ls_regions =  lds_data.GetItemString(ll_row, 'regions')
	
	ls_desc = lds_data.GetItemString(ll_row, 'project_description')
	ls_sum = lds_data.GetItemString(ll_row, 'agency_summary')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
//	insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
//	values (:ll_gigp, getdate(), 'appNote', 'projDescription', 'SYSTEM', :ls_desc)	;
	
	insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
	values (:ll_gigp, getdate(), 'appNote', 'projDescription', 'SYSTEM', :ls_sum)	;
	

//	If li_awarded = 1 Then
//		ls_fundrec = 'RECC-H'
//		ls_project_status = 'projectActive'
//	Else
//		ls_fundrec = 'DONOTREC'
//		ls_project_status = 'projectNonfunded'
//	End If
//	
//	update gigp_application
//	set project_name = :ls_name,
//		app_status = :ls_app_status,
//		project_status_cd = :ls_project_status,
//		funding_recommendation = :ls_fundrec
//	where gigp_id = :ll_gigp;
//	
//	//*****************AMOUNTS***************
//	If li_awarded = 1 Then
//		ll_id = f_gettokenvalue('amountID', 1)
//		
//		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
//		values (:ll_id, :ll_gigp, 'GIGPFR', 'Requested', 'From DEC Spreadsheet', :ld_fund_req, :ld_rec_fund, 'SYSTEM', getdate());
//		
//		ll_id = f_gettokenvalue('amountID', 1)
//		ld_req = ld_tpc - ld_fund_req
//		ld_app = ld_elig - ld_rec_fund
//		
//		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
//		values (:ll_id, :ll_gigp, 'FUNDLOCAL', 'Local', 'From Spreadsheet', :ld_req, :ld_app, 'SYSTEM', getdate());
//		
//	End If
	
Next

of_add_log('Done')
end event

type cb_57 from commandbutton within w_util
integer x = 1010
integer y = 376
integer width = 361
integer height = 100
integer taborder = 210
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R103"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist, li_pop
decimal ld_metric, ld_amt
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 103
//ii_round = 7

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

ldt_app = DateTime(Date('7/31/2015'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_roundxxx_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve(ii_round)

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If


For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ls_busname =  Trim(of_get_answer(546, ll_cfa))
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	ls_pop =  Trim(of_get_answer(2622, ll_cfa))
	
	If IsNumber(ls_pop) then
		li_pop = Integer(ls_pop)
	End If
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'

	insert into gigp_application (gigp_id, round_no, program, project_name, project_status_cd, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id)
	values (:ll_gigpID, :ii_round, 'GIGP', :ls_busname, 'projectActive', 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, :li_pop, 'CFA Answer', 0, getdate(), 'SYSTEM', :ll_cfa, 0, 246);
	
	of_add_log('Application added for ' + ls_busname)
	

	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
	
	//Create Metrics  
	of_insertMetric(1282, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OSAVE')	
	of_insertMetric(1285, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OREUSE')	
	of_insertMetric(1288, ll_gigpID, ll_cfa, 'Green Infrastructure', 'RUNOFFREDUCTION')
	of_insertMetric(1291, ll_gigpID, ll_cfa, 'Green Infrastructure', 'TONSYEARSEDIMENT')
	of_insertMetric(1314, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADSALT')
	of_insertMetric(1312, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADPHOS')
	of_insertMetric(1310, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADNITR')
	of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
	of_insertSummary(1297, ll_gigpId, ll_cfa, 'waterBodies')
	of_insertSummary(1296, ll_gigpId, ll_cfa, 'additWaterQualBen')
	of_insertSummary(1295, ll_gigpId, ll_cfa, 'spurGreenInnov')
	of_insertSummary(1294, ll_gigpId, ll_cfa, 'buildGreenCapacty')
	of_insertSummary(1270, ll_gigpId, ll_cfa, 'projMonitoring')
	of_insertSummary(1268, ll_gigpId, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_add_log('Summaries added for ' + ls_busname)

	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_addr = of_get_answer(928, ll_cfa)
	
	If IsNull(ls_addr) or ls_addr = '' Then
		ls_addr = of_get_answer(971, ll_cfa)
	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	select max(contact_id)
	into :ll_plc
	from gigp_contacts
	where upper(organization) = upper(:ls_busname)
	and upper(mail_city) = upper(:ls_city)
	and first_name is null
	and last_name is null;
	
	If IsNull(ll_plc) or ll_plc <= 0 Then
		of_add_log('New Project Location record added for ' + String(ll_gigpId))
		
		ll_plc = f_gettokenvalue('contactID', 1)
		
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	Else
		of_add_log('Project Location record MATCHED for ' + String(ll_gigpId))
		
	End If
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_city = of_get_answer(552, ll_cfa)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and upper(mail_city) = upper(:ls_city);
	
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If

	of_add_log('Done adding Contacts')

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps


//of_add_log('*******BEGIN DATA PROCESS***********')
//
////loop through round 102 DATA records from Monica and load
//ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, cwsrf_no, muni, county, region, redc, project_name, award_amt, engineer from gigp_round102_data', 'Style(Type=Form)', error_syntaxfromSQL)
//
//lds_data = CREATE n_ds
//lds_data.CREATE(ls_syntax, errorCreate)
//lds_data.SetTransObject(SQLCA)
//ll_ret = lds_data.Retrieve()
//
//If MessageBox('Data import', String(ll_ret) + ' rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
//	Return
//End If
//
//
//For ll_row = 1 to ll_ret
//	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
//	
//	select gigp_id
//	into :ll_gigpId
//	from gigp_application
//	where cfa_no = :ll_cfa;
//	
//	ls_name = lds_data.GetItemString(ll_row, 'project_name')
//	ls_redc = lds_data.GetItemString(ll_row, 'redc')
//	ls_region = String(lds_data.GetItemNumber(ll_row, 'region'))
//	ls_county = upper(lds_data.GetItemString(ll_row, 'county'))
//	
//	select ref_code
//	into :ls_fips
//	from gigp_reference
//	where category = 'County'
//	and upper(ref_value) = :ls_county;
//	
//	update gigp_application
//	set 	project_name = :ls_name,
//			dec_region = :ls_region,
//			county_fips_code = :ls_fips
//	where gigp_id = :ll_gigpId;
//	
//	of_add_log('Updated gigp_id ' + string(ll_gigpId))
//		
//Next
//
//of_add_log('*******END DATA PROCESS***********')
end event

type cb_56 from commandbutton within w_util
integer x = 571
integer y = 376
integer width = 361
integer height = 100
integer taborder = 210
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R103 Q/A"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_save
long ll_round, ll_question, ll_app
string ls_email, ls_question, ls_answer
decimal ld_lat, ld_long
//string ls_approved = '*50989*51503*51603*51720*52055*52554*53054*53204*53713*53965*54085*54254*54295*54310*54659*55086*55098*55364*55537*55925*55996*56088*56140*56148*56336*56376*56740*56745*56843*57022*57419*'
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_raw_data where 1 = 2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
//ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 103\Round103.txt')
ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 7\Round7.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_app = lds_data.GetItemNumber(ll_row, 'app_id')
	
//	If pos(ls_approved, '*' + String(ll_app) + '*') > 0 Then
	
		ll_round = lds_data.GetItemNumber(ll_row, 'round_no')
		ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
		ls_email = lds_data.GetItemString(ll_row, 'email')
		ls_question = lds_data.GetItemString(ll_row, 'question')
		ls_answer = lds_data.GetItemString(ll_row, 'answer')
		of_cleanse_text(ls_answer)
		
		insert into gigp_cfa_raw_data (round_no, question_id, app_id, business_name, email, question, answer)
		values (:ll_round, :ll_question, :ll_app, '', :ls_email, :ls_question, :ls_answer);
		
		of_add_log('Added App Id ' + String(ll_app) + ', Question # ' + String(ll_question))
		
//	End If

Next

of_add_log('Done')
end event

type cb_55 from commandbutton within w_util
integer x = 133
integer y = 376
integer width = 361
integer height = 100
integer taborder = 210
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Mapping"
end type

event clicked;string ls_proj, ls_add1, ls_add2, ls_phone, ls_website, ls_vhf, ls_latitude, ls_county, ls_dates, ls_hours, ls_days, ls_operation, ls_fee, ls_longitude, ls_city, ls_state, ls_zip, ls_html, ls_kml, ls_name
integer li_return, li_file
decimal ld_latp, ld_longp
long ll_row, ll_count, ll_projectId
datastore lds_proj
n_cst_string ln_string

/*********Original KML:
<Placemark><name><![CDATA[Coeymans Landing Marina]]></name>
<Snippet maxLines='0'></Snippet><styleUrl>#Sheet1Map1</styleUrl><ExtendedData></ExtendedData>
<LookAt><longitude>-73.789222</longitude><latitude>42.475011</latitude><range>1000</range><altitudeMode>relativeToGround</altitudeMode><tilt>0</tilt><heading>0</heading></LookAt>
<Point><altitudeMode>clampToGround</altitudeMode><extrude>0</extrude><coordinates>-73.789222,42.475011,0</coordinates></Point>
<description><![CDATA[...generated html...]]></description></Placemark>
**************************/

/**********Modified Minimum:
<Placemark>
<name><![CDATA[Coeymans Landing Marina]]></name>
<Point><altitudeMode>clampToGround</altitudeMode><extrude>0</extrude><coordinates>-73.789222,42.475011,0</coordinates></Point>
<description><![CDATA[...HTML...]]></description>
</Placemark>
*********************/


If NOT IsValid(lds_proj) Then
	lds_proj = CREATE datastore
End If

SetPointer(Hourglass!)

//li_file = FileOpen("C:\CVAP_Pumpout.KML",LineMode!, Write!, LockReadWrite!, Replace!)
li_file = FileOpen("C:\Users\weingold\Desktop\CVAP_Pumpout.KML",LineMode!, Write!, LockReadWrite!, Replace!)

FileWrite(li_file, '<?xml version="1.0" encoding="UTF-8"?> <kml xmlns="http://www.opengis.net/kml/2.2"      xmlns:gx="http://www.google.com/kml/ext/2.2"> <Document>')

lds_proj.DataObject = 'd_po_mapping'
//lds_proj.DataObject = 'd_po_mapping_2013inspections'
lds_proj.SetTransObject(SQLCA)

ll_count = lds_proj.Retrieve()

If ll_count > 0 Then
	For ll_row = 1 to ll_count
		
		ll_projectId = lds_proj.GetItemNumber(ll_row, 'project_id')
		ls_name = lds_proj.GetItemString(ll_row, 'name')
		lds_proj.SetItem(ll_row, 'description', '')
		
		//Retrieve the information for the bookmarks
		select p.project_name, p.address_line_1, p.address_line_2, p.city, p.state, p.zip, f.website_address, p.gps_latitude, p.gps_longitude
		into :ls_proj, :ls_add1, :ls_add2, :ls_city, :ls_state, :ls_zip, :ls_website, :ld_latp, :ld_longp
		from cv_project p, cv_facility f
		where f.facility_id = p.facility_id
		and p.project_id = :ll_projectId;
		
		select vhf_channel_monitored, convert(char, pumpout_fee_amt), county, pumpout_phone_number
		into :ls_vhf, :ls_fee, :ls_county, :ls_phone
		from cv_project_pumpout
		where project_id = :ll_projectId;
		
		select restriction_desc
		into :ls_dates
		from cv_project_restriction
		where restriction_type_cd = 'DATES OP'
		and project_id = :ll_projectId;
		
		select restriction_desc
		into :ls_hours
		from cv_project_restriction
		where restriction_type_cd = 'TIME OP'
		and project_id = :ll_projectId;
		
		select restriction_desc
		into :ls_days
		from cv_project_restriction
		where restriction_type_cd = 'DAYS OP'
		and project_id = :ll_projectId;
		
		//Format the address
		If NOT IsNull(ls_add2) Then ls_add1 += ', ' + ls_add2
		ls_add2 = ls_city + ', ' + ls_state + '  ' + ls_zip
		
		//Verify lat and  lon - use project if it exists, else use the facility
		ls_latitude = String(Round(ld_latp, 6))
		ls_longitude = String(Round(ld_longp, 6))
		
		If IsNull(ls_latitude) or IsNull(ls_longitude) or ls_latitude = '' or ls_longitude = '' Then
			ls_latitude = ''
			ls_longitude = ''
		End If
		
		//Format the phone number if it exists
		If IsNull(ls_phone) Then
			ls_phone = ''
		Else
			ls_phone = String(ls_phone,  '(@@@) @@@-@@@@')
		End If
		
		//Format the pumpout fee if it exists
		If IsNull(ls_fee) Then
			ls_fee = ''
		Else
			ls_fee = '$' + ls_fee
		End If
		
		//Get the operation list (potentially more than 1)
//		ls_operation = gf_getlist('operation', ll_projectId)
		
		//Handle nulls
		If IsNull(ls_proj) Then ls_proj = ''
		If IsNull(ls_add1) Then ls_add1 = ''
		If IsNull(ls_add2) Then ls_add2 = ''
		If IsNull(ls_website) Then ls_website = ''
		If IsNull(ls_county) Then ls_county = ''
		If IsNull(ls_latitude) Then ls_latitude = ''
		If IsNull(ls_longitude) Then ls_longitude = ''
		If IsNull(ls_dates) Then ls_dates = ''
		If IsNull(ls_hours) Then ls_hours = ''
		If IsNull(ls_days) Then ls_days = ''
		If IsNull(ls_vhf) Then ls_vhf = ''
		If IsNull(ls_operation) Then ls_operation = ''
		
		//Build the html
		ls_html = '<table border=1 cellspacing=0 cellpadding=0>'
		ls_html += '<tr><td valign=top> ' + ls_proj + '</p></td> <td valign=top> County: ' + ls_county + '</p></td></tr>'
		ls_html += '<tr><td valign=top> ' + ls_add1 + '<br>' + ls_add2 + '</p> </td> <td valign=top> ' + ls_dates + '<br> ' + ls_hours + '</p></td></tr>'
		ls_html += '<tr><td valign=top> Phone: ' + ls_phone + '</p> </td> <td valign=top> ' + ls_days + '</p></td></tr>'
		ls_html += '<tr><td valign=top><a href="' + ls_website + '">' + ls_website + '</a></p> </td> <td valign=top> ' + ls_operation + '</p></td></tr>'
		ls_html += '<tr><td valign=top> VHF: ' + ls_vhf + '</p> </td> <td valign=top> Fee: ' + ls_fee + '</p></td></tr>'
		ls_html += '<tr><td valign=top> Lat: ' + ls_latitude + '</p> </td> <td valign=top> Long: ' + ls_longitude + '</p></td></tr>'
		ls_html += '</table>'
		
		lds_proj.SetItem(ll_row, 'description', ls_html)
		
		//buildt KML
		ls_kml = '<Placemark><name><![CDATA[' + ls_name + ']]></name><Point><altitudeMode>clampToGround</altitudeMode><extrude>0</extrude><coordinates>' + ls_longitude + ',' + ls_latitude + ',0</coordinates></Point><description><![CDATA[' + ls_html + ']]></description></Placemark>'
		
		//Strip out &
		ls_kml = ln_string.of_globalreplace(ls_kml, '&', 'and')
		
		//Write to file
		FileWrite(li_file, ls_kml)
		
	Next
End If

//lds_proj.SaveAs("c:\cvap_mapping.csv", CSV!, true)

FileWrite(li_file, '</Document></kml>')
FileClose(li_file)

SetPointer(Arrow!)

MessageBox('Done', 'Mapping file created as C:\Users\weingold.NYSEFC\Desktop\CVAP_Pumpout.KML')

Return 1
end event

type cb_54 from commandbutton within w_util
integer x = 2327
integer y = 280
integer width = 361
integer height = 100
integer taborder = 210
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Doc Open"
end type

event clicked;integer li_rc, li_count
string ls_docPath
OLEObject iou_main


//*******************************************************
// Connect to MS Word:
//*******************************************************
If IsValid(iou_main) Then Destroy(iou_main)

iou_main = CREATE OLEObject
li_rc = iou_main.ConnectToObject('', 'Word.Application')
If (li_rc <> 0)  Then 	
	li_rc = iou_main.ConnectToNewObject('Word.Application')

	If (li_rc <> 0)  Then
		MessageBox("ERROR!", "Error opening Microsoft Word.")
	End If	
End If

//*******************************************************
// Open  Factsheet Template:
//*******************************************************
ls_docPath = 'F:\Powerbuilder Apps (EFC)\exe\production\CVAP\Contracts\CvapOmReimbursementForm.dot'

iou_main.Documents.Add(ls_docPath)
iou_main.Visible = True

iou_main.Selection.GoTo(True,0,0,'EntireDocument')
iou_main.Selection.Copy

iou_main.Selection.GoTo(True,0,0,'OwnerName')
iou_main.Selection.TypeText('Owner 1')

iou_main.Selection.GoTo(True,0,0,'Bottom')
iou_main.Selection.InsertNewPage
iou_main.Selection.Paste

iou_main.Selection.GoTo(True,0,0,'OwnerName')
iou_main.Selection.TypeText('Owner 2')

If IsValid(iou_main) Then iou_main.DisconnectObject()
If IsValid(iou_main) Then Destroy(iou_main)
end event

type cb_53 from commandbutton within w_util
integer x = 1888
integer y = 280
integer width = 361
integer height = 100
integer taborder = 200
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "FT Load"
end type

event clicked;string ls_cusip, ls_out, ls_list, ls_run, ls_cusip_check, ls_path, ls_price_pct, ls_inv_date, ls_today, ls_daytorun, as_error
long ll_ret, ll_row, ll_investmentId, ll_ids_ret, ll_ids_row
datetime ldt_inv_date
decimal {3} ld_price_pct
integer li_list, li_out
time lt_begin
datastore lds_data, lds_results, lds_ids



If NOT IsValid(lds_data) Then lds_data = CREATE datastore
If NOT IsValid(lds_results) Then lds_results = CREATE datastore
If NOT IsValid(lds_ids) Then lds_ids = CREATE datastore

ls_path = 'g:\rplus\ft\'

//Build file names
ls_list = ls_path + 'cusiplist.lst' 
ls_out = ls_path + 'rplus.dat'
ls_run = ls_path + 'rplus.bat'

//Retrieve investment records to get list of cusips for pricing
lds_data.DataObject = 'd_ls_cusip_list'
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If ll_ret <= 0 Then
	as_error = 'Error retrieving cusips to price.'
	Goto EOF
End If

//Open key file (list of cusips)
li_list = FileOpen(ls_list, LineMode!, Write!, LockReadWrite!, Replace!)

//Add CUSIPs to the key file
For ll_row = 1 to ll_ret
		ls_cusip = lds_data.GetItemString(ll_row, 'cusip')
		FileWrite(li_list, ls_cusip)
Next
FileClose(li_list)

//Run the FFG32 executable via a batch file - will rename the original data file and log file for backup
Run(ls_run)


//Once we know the datafile is back and complete, read it into the results datastore 
//(add a 60 second timer for all rows to be written since they are written in blocks of data)
Do While NOT FileExists(ls_out)
	//Just to make sure it exists
Loop


lt_begin = Now()

//Give 1 minute lag for results to come back
Do while SecondsAfter(lt_begin, Now()) < 60
	//
Loop

lds_results.DataObject = 'd_ls_ft_results'
ll_ret = lds_results.ImportFile(CSV!, ls_out)

If ll_ret <= 0 Then
	as_error = 'No results found.'
	Goto EOF
End If


lds_ids.DataObject = 'd_ls_cusip_ids'
lds_ids.SetTransObject(SQLCA)

//Loop through all the returned cusip prices and get Investement records (potentially more than 1) for each and insert new prices
For ll_row = 1 to ll_ret
	ls_cusip = lds_results.GetItemString(ll_row, 'cusip')
	ls_price_pct = lds_results.GetItemString(ll_row, 'price_pct')
	ls_inv_date = lds_results.GetItemString(ll_row, 'price_dt')
	
//	ld_price_pct = lds_results.GetItemDecimal(ll_row, 'price_pct')
//	ldt_inv_date = lds_results.GetItemDateTime(ll_row, 'price_dt')

	//Test for no public price found
	If NOT IsNumber(ls_price_pct) Then
		Continue
	End If
	
	ld_price_pct = Dec(Trim(ls_price_pct))
	ldt_inv_date = DateTime(Date(ls_inv_date))

		
	//Get investment records for that cusip
	ll_ids_ret = lds_ids.Retrieve(ls_cusip)
	
	If ll_ids_ret > 0 Then
		
		For ll_ids_row = 1 to ll_ids_ret
			
			ll_investmentid = lds_ids.GetItemNumber(ll_ids_row, 'investment_id')
			
			//Insert new price
			Insert into ls_investment_price(investment_id, price_dt, price_amt, price_pct, price_method, last_updated_dt, last_updated_by)
			Values (:ll_investmentId, :ldt_inv_date, 0, :ld_price_pct,  'FT', getdate(), 'SYSTEM');
	
			of_add_log('invest_id = ' + String(ll_investmentId) + ';  date = ' + String(ldt_inv_date) + ';  price = ' + String(ld_price_pct))		
			
		Next
		
	End If

Next


EOF:
If IsValid(lds_data) Then DESTROY lds_data
If IsValid(lds_results) Then DESTROY lds_results
If IsValid(lds_ids) Then DESTROY lds_ids
end event

type cb_52 from commandbutton within w_util
integer x = 1449
integer y = 280
integer width = 361
integer height = 100
integer taborder = 200
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Com"
end type

event clicked;string ls_return
OLEObject lole_connect
int li_ret, li_import
datastore lds_data

lole_connect = CREATE OLEObject
lds_data = CREATE datastore
lds_data.DataObject = 'd_test_xml_struct'

li_ret = lole_connect.ConnectToNewObject("TestCom.ComClass")

MessageBox('connection', li_ret)

If (li_ret) <> 0 Then
	DESTROY lole_connect
	MessageBox('Error', 'Could not connect')
	return
Else
	ls_return = lole_connect.GetErrorMessage()
	MessageBox('Run', ls_return)
	
	clipboard(ls_return)
	
	li_import = lds_data.ImportString(XML!,ls_return)
	
	MessageBox('import', li_import)
	
	MessageBox('return code', lds_data.GetItemNumber(1, 'ReturnCode'))
	MessageBox('Error Message', lds_data.GetItemString(1, 'ErrorMessage'))
	MessageBox('Error Date', String(lds_data.GetItemDateTime(1, 'ErrorDate')))
	MessageBox('Array', lds_data.GetItemString(1, 'SampleArray'))
	
End If

DESTROY lole_connect
end event

type cb_51 from commandbutton within w_util
integer x = 1010
integer y = 280
integer width = 361
integer height = 100
integer taborder = 200
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Project No"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_proj, ls_formattedproj
long ll_ret, ll_row, ll_gigp, ll_count
datetime ld_date, ld_antic
n_ds lds_data
n_cst_datetime ln_date

/////////////////////
//NOTE: these GIGP id's will not convert
// 55,64,93,108,116,119,123,153,161,246,268,272,1195
////////////////////

ls_syntax = sqlca.SyntaxFromSQL("select * from gigp_application where project_no is not null and project_no <> 'NONE'", 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows retrieved. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	SetNull(ls_formattedproj)
	
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	ls_proj = lds_data.GetItemString(ll_row, 'project_no')
	
	select c_formattedproj
	into :ls_formattedproj
	from cwsrf_main
	where c_proj_no = :ls_proj;
	
	If NOT IsNull(ls_formattedproj) And ls_formattedproj > '' Then
		update gigp_application
		set project_no = :ls_formattedproj
		where gigp_id = :ll_gigp;
		
		of_add_log('GIGP ' + String(ll_gigp) + ' Project# changed from ' + ls_proj + ' to ' + ls_formattedproj)
		
	End If
	
	
Next

of_add_log('Done.')

end event

type cb_50 from commandbutton within w_util
integer x = 571
integer y = 280
integer width = 361
integer height = 100
integer taborder = 190
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "cfa stuff"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate
long ll_ret, ll_row, ll_gigp, ll_count
datetime ld_date, ld_antic
n_ds lds_data
n_cst_datetime ln_date

ls_syntax = sqlca.SyntaxFromSQL("select * from gigp_application where program = 'EPG'", 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows retrieved. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	select count(*)
	into :ll_count
	from gigp_key_dates
	where gigp_id = :ll_gigp
	and ref_code = 'epgANTICIPATEDCOMPL';
	
	SetNull(ld_date)
	
	select grant_closed_dt
	into :ld_date
	from gigp_cfa_items
	where gigp_id = :ll_gigp;
	
	If IsNull(ld_date) Then
		//Contract Exected Dt + 1 yr
		select keydate_value
		into :ld_date
		from gigp_key_dates
		where gigp_id = :ll_gigp
		and ref_code = 'agreeAGRFULLEX';
		
		
		If IsNull(ld_date) Then
			//Award Letter Dt + 2 yrs
			select keydate_value
			into :ld_date
			from gigp_key_dates
			where gigp_id = :ll_gigp
			and ref_code = 'agreeCOMLTRSEN';

			If IsNull(ld_date) Then 
				of_add_log(String(ll_gigp) + ' did not find a date to use')
				Continue
			End If
			
			//add 2  years
			ld_date = DateTime(ln_date.of_relativeYear(Date(ld_date), 2))
			
			of_add_log(String(ll_gigp) + ' used Award Letter Date of ' + String(ld_date, "mm/dd/yyyy"))
			
		Else
			of_add_log(String(ll_gigp) + ' used Contract Executed Date of ' + String(ld_date, "mm/dd/yyyy"))
			
		End If
		
		//add 1 year
		ld_date = DateTime(ln_date.of_relativeYear(Date(ld_date), 1))
		
	Else
		of_add_log(String(ll_gigp) + ' used Grant Closure Date of ' + String(ld_date, "mm/dd/yyyy"))
		
	End If
	
	
	If ll_count = 0 Then
		//insert
		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
		values (:ll_gigp, 'epgANTICIPATEDCOMPL', :ld_date, 'SYSTEM', getdate());
		
	Else
		//update
		update gigp_key_dates
		set keydate_value = :ld_date
		where gigp_id = :ll_gigp
		and ref_code = 'epgANTICIPATEDCOMPL';
		
	End If
	
Next

of_add_log('Done.')

end event

type cb_49 from commandbutton within w_util
integer x = 133
integer y = 280
integer width = 361
integer height = 100
integer taborder = 190
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R102 Muni"
end type

event clicked;string ls_municode, ls_muniname, ls_munitype
string ls_syntax, error_syntaxfromSQL, errorCreate
integer li_counter
long ll_ret, ll_row, ll_cfa
n_ds lds_data

ii_round = 102
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_round102_muni', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows retrieved. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

li_counter = 0

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ls_muniname = lds_data.GetItemString(ll_row, 'muni')
	ls_munitype = lds_data.GetItemString(ll_row, 'type')
	
	SetNull(ls_municode)
	
	select muni_code
	into :ls_municode
	from fin_muni_codes
	where muni_name = :ls_muniname
	and community_type = :ls_munitype;
	
	If NOT IsNull(ls_municode) and ls_municode > '' and ll_cfa > 0 Then
		li_counter++
		of_add_log('Adding municode = ' + ls_municode + ' to cfa# = ' + String(ll_cfa))
		
		update gigp_application
		set muni_code = :ls_municode
		where cfa_no = :ll_cfa;
		
	End If
	
Next

of_add_log('Done loading munis. Total loaded = ' + String(li_counter))


end event

type cb_48 from commandbutton within w_util
integer x = 2327
integer y = 184
integer width = 361
integer height = 100
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R6 Desc"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_desc
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id
n_ds lds_data

ii_round = 6

//ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_application where round_no = 102', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_round6_desc', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows retrieved. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ls_desc = lds_data.GetItemString(ll_row, 'efc_project_description')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
	values (:ll_gigp, getdate(), 'appNote', 'projDescription', 'SYSTEM', :ls_desc)	;
	
Next

of_add_log('Done loading descriptions')
end event

type cb_47 from commandbutton within w_util
integer x = 1888
integer y = 184
integer width = 361
integer height = 100
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R6 Amts"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate
long ll_ret, ll_row, ll_cfa, ll_gigp, ll_id
decimal ld_fundreq, ld_recfund, ld_tpc, ld_eligible, ld_req, ld_app
n_ds lds_data

ii_round = 6

//ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_application where round_no = 102', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_round6_amounts', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows retrieved. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ld_fundreq = lds_data.GetItemNumber(ll_row, 'fundreq')
	ld_recfund = lds_data.GetItemNumber(ll_row, 'recfund')
	ld_tpc = lds_data.GetItemNumber(ll_row, 'tpc')
	ld_eligible = lds_data.GetItemNumber(ll_row, 'eligible')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	ll_id = f_gettokenvalue('amountID', 1)
	ld_req = ld_fundreq
	ld_app = ld_recfund
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'GIGPFR', 'Requested', 'From Spreadsheet', :ld_req, :ld_app, 'SYSTEM', getdate());
	
	of_add_log('Amounts added for ' + string(ll_gigp) + ' for GIGPFR as ' + string(ld_req) + ' and ' + string(ld_app))
	
	
	ll_id = f_gettokenvalue('amountID', 1)
	ld_req = ld_tpc - ld_fundreq
	ld_app = ld_eligible - ld_recfund
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigp, 'FUNDLOCAL', 'Local', 'From Spreadsheet', :ld_req, :ld_app, 'SYSTEM', getdate());
	
	of_add_log('Amounts added for ' + string(ll_gigp) + ' for FUNDLOCAL as ' + string(ld_req) + ' and ' + string(ld_app))
	

Next

of_add_log('Done loading amounts')
end event

type cb_46 from commandbutton within w_util
integer x = 1449
integer y = 184
integer width = 361
integer height = 100
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "EPG Reps"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_rep
decimal ld_amt
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_epg_reps', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()


For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ll_rep = lds_data.GetItemNumber(ll_row, 'representative')

	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	values (:ll_rep, :ll_gigp, 'EPGASSIGN');
	
	of_add_log('Rep added for ' + String(ll_gigp))
	
Next

end event

type cb_45 from commandbutton within w_util
integer x = 1010
integer y = 184
integer width = 361
integer height = 100
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "CV Grant Amt"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate
long ll_ret, ll_row, ll_id, ll_admin
datetime ldt_today
decimal ld_80, ld_20, ld_amt
n_ds lds_data

ldt_today = DateTime(today())

//loop through all Admin Fees that are not assigned to a Grant
ls_syntax = sqlca.SyntaxFromSQL('select * from cv_admin_fee where admin_fee_id not in (select admin_fee_id from cv_grant_amt where admin_fee_id > 0)', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' Admin Fees found. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

//Loop through each Unassigned Admin Fee and calculate grant amounts
For ll_row = 1 to ll_ret
	ll_admin = lds_data.GetItemNumber(ll_row, 'admin_fee_id')
	
	//Determine the Cost, take 75% of that amount and then split that by 80% / 20%
	ld_amt = lds_data.GetItemDecimal(ll_row, 'cost')
	
	If ld_amt > 0 Then
		ld_amt = Round(ld_amt * .75, 2)
		ld_80 = Round(ld_amt * .8, 2)
		ld_20 = ld_amt - ld_80
			
		//Insert 80% Grant Amount to Coastal (id = 326)
		ll_id = of_get_cvap_token('grant_amt_id', 1)
		insert into cv_grant_amt (grant_amt_id, disbursement_id, admin_fee_id, grant_id, grant_amt, last_updated_dt, last_updated_by)
		values (:ll_id, null, :ll_admin, 326, :ld_80, :ldt_today, 'SYSTEM');
		
		//Insert 20% Grant Amount to Inland (id = 329)
		ll_id = of_get_cvap_token('grant_amt_id', 1)
		insert into cv_grant_amt (grant_amt_id, disbursement_id, admin_fee_id, grant_id, grant_amt, last_updated_dt, last_updated_by)
		values (:ll_id, null, :ll_admin, 329, :ld_20, :ldt_today, 'SYSTEM');
		
		of_add_log('Grant amount for Admin Fee id ' + String(ll_admin) + ' added for total = ' + String(ld_amt) + ' (' + String(ld_80) + ' / ' + String(ld_20) + ')')
		
	End If
		
Next

of_add_log('Done')
end event

type cb_44 from commandbutton within w_util
integer x = 571
integer y = 184
integer width = 361
integer height = 100
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R102 Updates"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_lat, ls_long, ls_pop, ls_desc
long ll_ret, ll_row, ll_find, ll_contact, ll_cfa, ll_gigp, ll_id, ll_gigpId
decimal ld_lat, ld_long, ld_req, ld_app
integer li_pop
n_ds lds_data

ii_round = 102
//ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_application where round_no = 102', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_round102_efcdesc', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows retrieved. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ls_desc =  lds_data.GetItemString(ll_row, 'efc_desc')
	
	select gigp_id
	into :ll_gigpId
	from gigp_application
	where cfa_no = :ll_cfa;
	
	insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
	values (:ll_gigpId, getdate(), 'appNote', 'projDescription', 'SYSTEM', :ls_desc);
	
Next

//For ll_row = 1 to ll_ret
//	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
//	ll_gigpId = lds_data.GetItemNumber(ll_row, 'gigp_id')
//	
//	ls_pop =  Trim(of_get_answer(2622, ll_cfa))
//	
//	If IsNumber(ls_pop) then
//		li_pop = Integer(ls_pop)
//		
//		If li_pop > 0 Then
//			update gigp_application
//			set pop_count = :li_pop, pop_source = '2014 CFA'
//			where gigp_id = :ll_gigpId;
//			
//			of_add_log('Population for ' + String(ll_gigpId) + ' set to ' + String(li_pop))
//			
//		End If
//		
//	End If
//		
//Next


of_add_log('Done loading populations')


end event

type cb_43 from commandbutton within w_util
integer x = 133
integer y = 184
integer width = 361
integer height = 100
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R102 Amts"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_lat, ls_long
long ll_ret, ll_row, ll_find, ll_contact, ll_cfa, ll_gigp, ll_id, ll_gigpId
decimal ld_lat, ld_long, ld_req, ld_app
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_round102_amounts', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	//GIS Update
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ls_lat = String(lds_data.GetItemDecimal(ll_row, 'latitude'))
	ls_long = String(lds_data.GetItemDecimal(ll_row, 'longitude'))
	
	select gigp_id
	into :ll_gigpId
	from gigp_application
	where cfa_no = :ll_cfa;
	
	select contact_id
	into :ll_contact
	from gigp_contact_links
	where contact_type = 'PLC'
	and gigp_id =:ll_gigpId;
						
	If ll_contact > 0 Then
		update gigp_contacts
		set gis_latitude = :ls_lat,
			gis_longitude = :ls_long
		where contact_id = :ll_contact;
		
		of_add_log('CFA# ' + String(ll_cfa) + ' updated coorrdinates to ' + ls_lat + ' / ' + ls_long)
		
	End If
		
	
	//AMOUNTS
	ld_req = lds_data.GetItemDecimal(ll_row, 'fr_req')
	ld_app = lds_data.GetItemDecimal(ll_row, 'fr_rec')
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigpId, 'GIGPFR', 'Requested', 'From DEC Spreadsheet', :ld_req, :ld_app, 'SYSTEM', getdate());
	
	of_add_log('Amounts added for ' + string(ll_gigpId) + ' for GIGPFR as ' + string(ld_req) + ' and ' + string(ld_app))
	
	
	ld_req = lds_data.GetItemDecimal(ll_row, 'match_req')
	ld_app = lds_data.GetItemDecimal(ll_row, 'match_rec')
	ll_id = f_gettokenvalue('amountID', 1)
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_id, :ll_gigpId, 'FUNDLOCAL', 'Local', 'From DEC Spreadsheet', :ld_req, :ld_app, 'SYSTEM', getdate());
	
	of_add_log('Amounts added for ' + string(ll_gigpId) + ' for FUNDLOCAL as ' + string(ld_req) + ' and ' + string(ld_app))
	
		
Next
end event

type cb_42 from commandbutton within w_util
integer x = 2327
integer y = 88
integer width = 361
integer height = 100
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R102 "
end type

event clicked;datetime ldt_app
integer li_district, li_checklist, li_pop
decimal ld_metric, ld_amt
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid, ll_ret
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible
string ls_syntax, error_syntaxfromSQL, errorCreate, ls_redc, ls_fips, ls_county, ls_region, ls_pop
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_ds lds_data
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 102

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

ldt_app = DateTime(Date('6/16/2014'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_round102_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve()

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If


For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ls_busname =  Trim(of_get_answer(546, ll_cfa))
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	ls_pop =  Trim(of_get_answer(2622, ll_cfa))
	
	If IsNumber(ls_pop) then
		li_pop = Integer(ls_pop)
	End If
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'

	insert into gigp_application (gigp_id, round_no, program, project_name, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id)
	values (:ll_gigpID, :ii_round, 'GIGP', :ls_busname, 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, :li_pop, 'CFA Answer', 0, getdate(), 'SYSTEM', :ll_cfa, 0, 246);
	
	of_add_log('Application added for ' + ls_busname)
	

	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
	
	//Create Metrics  
	of_insertMetric(1282, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OSAVE')	
	of_insertMetric(1285, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OREUSE')	
	of_insertMetric(1288, ll_gigpID, ll_cfa, 'Green Infrastructure', 'RUNOFFREDUCTION')
	of_insertMetric(1291, ll_gigpID, ll_cfa, 'Green Infrastructure', 'TONSYEARSEDIMENT')
	of_insertMetric(1314, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADSALT')
	of_insertMetric(1312, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADPHOS')
	of_insertMetric(1310, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADNITR')
	of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
	of_insertSummary(1297, ll_gigpId, ll_cfa, 'waterBodies')
	of_insertSummary(1296, ll_gigpId, ll_cfa, 'additWaterQualBen')
	of_insertSummary(1295, ll_gigpId, ll_cfa, 'spurGreenInnov')
	of_insertSummary(1294, ll_gigpId, ll_cfa, 'buildGreenCapacty')
	of_insertSummary(1270, ll_gigpId, ll_cfa, 'projMonitoring')
	of_insertSummary(1268, ll_gigpId, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_add_log('Summaries added for ' + ls_busname)

	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_addr = of_get_answer(928, ll_cfa)
	
	If IsNull(ls_addr) or ls_addr = '' Then
		ls_addr = of_get_answer(971, ll_cfa)
	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	select max(contact_id)
	into :ll_plc
	from gigp_contacts
	where upper(organization) = upper(:ls_busname)
	and upper(mail_city) = upper(:ls_city)
	and first_name is null
	and last_name is null;
	
	If IsNull(ll_plc) or ll_plc <= 0 Then
		of_add_log('New Project Location record added for ' + String(ll_gigpId))
		
		ll_plc = f_gettokenvalue('contactID', 1)
		
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	Else
		of_add_log('Project Location record MATCHED for ' + String(ll_gigpId))
		
	End If
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_city = of_get_answer(552, ll_cfa)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and upper(mail_city) = upper(:ls_city);
	
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If

	of_add_log('Done adding Contacts')

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps


of_add_log('*******BEGIN DATA PROCESS***********')

//loop through round 102 DATA records from Monica and load
ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, cwsrf_no, muni, county, region, redc, project_name, award_amt, engineer from gigp_round102_data', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('Data import', String(ll_ret) + ' rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If


For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	
	select gigp_id
	into :ll_gigpId
	from gigp_application
	where cfa_no = :ll_cfa;
	
	ls_name = lds_data.GetItemString(ll_row, 'project_name')
	ls_redc = lds_data.GetItemString(ll_row, 'redc')
	ls_region = String(lds_data.GetItemNumber(ll_row, 'region'))
	ls_county = upper(lds_data.GetItemString(ll_row, 'county'))
	
	select ref_code
	into :ls_fips
	from gigp_reference
	where category = 'County'
	and upper(ref_value) = :ls_county;
	
	update gigp_application
	set 	project_name = :ls_name,
			dec_region = :ls_region,
			county_fips_code = :ls_fips
	where gigp_id = :ll_gigpId;
	
	of_add_log('Updated gigp_id ' + string(ll_gigpId))
		
Next

of_add_log('*******END DATA PROCESS***********')
end event

type cb_41 from commandbutton within w_util
integer x = 1888
integer y = 88
integer width = 361
integer height = 100
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R102 Q/A"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_question, ll_save
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select question_id, question from gigp_round102_questions', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 102\Round102Questions.txt')

If MessageBox('Question Import', String(ll_ret) + ' question rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
	ls_desc = lds_data.GetItemString(ll_row, 'question')
	of_cleanse_text(ls_desc)
	lds_data.SetItem(ll_row, 'question_id', ll_question)
	lds_data.SetItem(ll_row, 'question', ls_desc)
	lds_data.SetItemStatus(ll_row, 0, Primary!, NewModified!)
Next
lds_data.SaveAs('G:\EPG (Engineering Planning Grant)\Round 102\R102QuestionsLoad.txt', Text!, False)
MessageBox('done', 'done with questions')

If IsValid(lds_data) Then DESTROY lds_data

ls_syntax = sqlca.SyntaxFromSQL('select application_number, application_email, program_id, question_id, answer from gigp_round102_answers', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 102\Round102Answers.txt')

If MessageBox('Question Import', String(ll_ret) + ' answer rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ls_desc = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_desc)
	lds_data.SetItem(ll_row, 'answer', ls_desc)
Next
lds_data.SaveAs('G:\EPG (Engineering Planning Grant)\Round 102\R102AnswersLoad.txt', Text!, False)
MessageBox('done', 'done with answers')

If IsValid(lds_data) Then DESTROY lds_data

ls_syntax = sqlca.SyntaxFromSQL('select cfa_no, cwsrf_no, muni, county, region, redc, project_name, project_description, award_amt, engineer from gigp_round102_data', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\EPG (Engineering Planning Grant)\Round 102\Round102TrackedData.txt')

If MessageBox('Question Import', String(ll_ret) + ' DATA rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ls_desc = lds_data.GetItemString(ll_row, 'project_name')
	of_cleanse_text(ls_desc)
	lds_data.SetItem(ll_row, 'project_name', ls_desc)
	
	ls_desc = lds_data.GetItemString(ll_row, 'project_description')
	of_cleanse_text(ls_desc)
	lds_data.SetItem(ll_row, 'project_description', ls_desc)
	
Next
lds_data.SaveAs('G:\EPG (Engineering Planning Grant)\Round 102\R102DataLoad.txt', Text!, False)
MessageBox('done', 'done with DATA')

end event

type cb_40 from commandbutton within w_util
integer x = 1449
integer y = 88
integer width = 361
integer height = 100
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R6 Updates"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate
long ll_ret, ll_row, ll_cfa
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_round6_update', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

of_add_log('Begin')

If MessageBox('Update', String(ll_ret) + ' rows imported to update. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')


Next

of_add_log('End')
end event

type cb_39 from commandbutton within w_util
integer x = 1010
integer y = 88
integer width = 361
integer height = 100
integer taborder = 230
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R6 Apps"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist
decimal ld_metric
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh, ls_ineligible
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 102

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

ldt_app = DateTime(Date('6/16/2014'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_round102_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve()

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If


For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ls_busname =  Trim(of_get_answer(546, ll_cfa))
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'

	insert into gigp_application (gigp_id, round_no, program, project_name, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag)
	values (:ll_gigpID, :ii_round, 'GIGP', :ls_busname, 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0);
	
	of_add_log('Application added for ' + ls_busname)
	

	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
	
	//Create Metrics  
	of_insertMetric(1282, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OSAVE')	
	of_insertMetric(1285, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OREUSE')	
	of_insertMetric(1288, ll_gigpID, ll_cfa, 'Green Infrastructure', 'RUNOFFREDUCTION')
	of_insertMetric(1291, ll_gigpID, ll_cfa, 'Green Infrastructure', 'TONSYEARSEDIMENT')
	of_insertMetric(1314, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADSALT')
	of_insertMetric(1312, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADPHOS')
	of_insertMetric(1310, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADNITR')
	of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
	of_insertSummary(1297, ll_gigpId, ll_cfa, 'waterBodies')
	of_insertSummary(1296, ll_gigpId, ll_cfa, 'additWaterQualBen')
	of_insertSummary(1295, ll_gigpId, ll_cfa, 'spurGreenInnov')
	of_insertSummary(1294, ll_gigpId, ll_cfa, 'buildGreenCapacty')
	of_insertSummary(1270, ll_gigpId, ll_cfa, 'projMonitoring')
	of_insertSummary(1268, ll_gigpId, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_add_log('Summaries added for ' + ls_busname)

	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_addr = of_get_answer(928, ll_cfa)
	
	If IsNull(ls_addr) or ls_addr = '' Then
		ls_addr = of_get_answer(971, ll_cfa)
	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	select max(contact_id)
	into :ll_plc
	from gigp_contacts
	where upper(organization) = upper(:ls_busname)
	and upper(mail_city) = upper(:ls_city)
	and first_name is null
	and last_name is null;
	
	If IsNull(ll_plc) or ll_plc <= 0 Then
		of_add_log('New Project Location record added for ' + String(ll_gigpId))
		
		ll_plc = f_gettokenvalue('contactID', 1)
		
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	Else
		of_add_log('Project Location record MATCHED for ' + String(ll_gigpId))
		
	End If
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_city = of_get_answer(552, ll_cfa)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and upper(mail_city) = upper(:ls_city);
	
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If

	of_add_log('Done adding Contacts')

Next

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps
end event

type cb_38 from commandbutton within w_util
integer x = 571
integer y = 88
integer width = 361
integer height = 100
integer taborder = 230
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R6 Questions"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_question, ll_save
decimal ld_lat, ld_long
n_ds lds_data

//ls_syntax = sqlca.SyntaxFromSQL('select question_id, question from gigp_round6_questions', 'Style(Type=Form)', error_syntaxfromSQL)
//lds_data = CREATE n_ds
//lds_data.CREATE(ls_syntax, errorCreate)
//lds_data.SetTransObject(SQLCA)
//ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 6\CFA4 GIGP Questions.txt')
//
//If MessageBox('Question Import', String(ll_ret) + ' rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
//	Return
//End If
//
//For ll_row = 1 to ll_ret
//	ll_question = lds_data.GetItemNumber(ll_row, 'question_id')
//	ls_desc = lds_data.GetItemString(ll_row, 'question')
//	of_cleanse_text(ls_desc)
//	lds_data.SetItem(ll_row, 'question_id', ll_question)
//	lds_data.SetItem(ll_row, 'question', ls_desc)
//	lds_data.SetItemStatus(ll_row, 0, Primary!, NewModified!)
//Next
//lds_data.SaveAs('G:\GIGP\Round 6\CFA4 GIGP Questions Load.txt', Text!, False)
//MessageBox('done', 'done')

ls_syntax = sqlca.SyntaxFromSQL('select applicaiton_number, applicaiton_email, program_id, question_id, answer from gigp_round6_answers', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'G:\GIGP\Round 6\gigp_round6_answers.txt')

If MessageBox('Question Import', String(ll_ret) + ' rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ls_desc = lds_data.GetItemString(ll_row, 'answer')
	of_cleanse_text(ls_desc)
	lds_data.SetItem(ll_row, 'answer', ls_desc)
Next
lds_data.SaveAs('G:\GIGP\Round 6\gigp_round6_answers_load.txt', Text!, False)
MessageBox('done', 'done')
end event

type cb_37 from commandbutton within w_util
integer x = 133
integer y = 88
integer width = 361
integer height = 100
integer taborder = 170
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "EPG Rpts"
end type

event clicked;string ls_ref, ls_rounds[]
integer li_rounds[]
integer li_count, li_index
long ll_ret
n_cst_gwsend lnvo_gwsend
n_cst_string n_string
datastore lds_data


//Retrieve and save Milestone Staff Report
If NOT IsValid(lds_data) Then lds_data = CREATE datastore


//Email reports
select convert(varchar(1000), description)
into :ls_ref
from gigp_reference
where category = 'epg_rpt_rounds';

of_add_log('Rounds from ref table: ' + ls_ref)

n_string.of_ParseToArray(ls_ref, ',', ls_rounds)
li_count = UpperBound(ls_rounds)

of_add_log('Rounds after ParseToArray: ' + String(ls_rounds))
of_add_log('Number in array: ' + String(li_count))

If li_count > 0 Then
	For li_index = 1 to li_count
		li_rounds[li_index] = Integer(ls_rounds[li_index])
	Next
End If

lds_data.DataObject = 'd_epg_milestone_tracking_list_staff'
//WHERE a.round_no in (:ai_roundno)

lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve(li_rounds, ls_ref, 'EPG')

of_add_log('Retrieve = ' + String(ll_ret))
of_add_log('Error = ' + SQLCA.SQLErrText)

Choose Case ll_ret
	Case -1

	Case  0 
		
End Choose

If IsValid(lds_data) Then DESTROY lds_data

end event

type cb_36 from commandbutton within w_util
boolean visible = false
integer x = 2327
integer y = 532
integer width = 361
integer height = 100
integer taborder = 220
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "CVAP Insp"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_lat, ls_long
long ll_ret, ll_row, ll_find, ll_contact, ll_cfa, ll_projid, ll_count
decimal ld_lat, ld_long
datetime ldt_date, ldt_today
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL("select * from cv_inspection_data", 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

ldt_today = DateTime(Today())

of_add_log('Total retrieved: ' + String(ll_ret))

For ll_row = 1 to ll_ret
	ll_projid = lds_data.GetItemNumber(ll_row, 'project_id')
	
	
		
Next

end event

type cb_35 from commandbutton within w_util
boolean visible = false
integer x = 1888
integer y = 532
integer width = 361
integer height = 100
integer taborder = 210
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Upd Agr Dts"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_lat, ls_long
long ll_ret, ll_row, ll_find, ll_contact, ll_cfa, ll_gigp, ll_count
decimal ld_lat, ld_long
datetime ldt_date, ldt_twoyears, ldt_today
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL("select * from gigp_key_dates where ref_code = 'agreeAGRFULLEX' and gigp_id in (select gigp_id from gigp_application where round_no in (2,3,4,5) )", 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

ldt_today = DateTime(Today())

of_add_log('Total retrieved: ' + String(ll_ret))

For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	ldt_date = lds_data.GetItemDateTime(ll_row, 'keydate_value')
	ldt_twoyears = DateTime(RelativeDate(Date(ldt_date), 731))
	
	select count(*)
	into :ll_count
	from gigp_key_dates
	where gigp_id = :ll_gigp
	and ref_code = 'agreeAGREXP';
	
	If ll_count = 0 Then
		insert into gigp_key_dates (gigp_id, ref_code, keydate_value, last_updated_by, last_updated_dt)
		values (:ll_gigp, 'agreeAGREXP', :ldt_twoyears, 'SYSTEM', :ldt_today);
		
		of_add_log('Inserting for GIGP ' + String(ll_gigp))
		
	Else
		update gigp_key_dates
		set keydate_value = :ldt_twoyears
		where gigp_id = :ll_gigp
		and ref_code = 'agreeAGREXP';
		
		of_add_log('Updating for GIGP ' + String(ll_gigp))
		
	End If
	
	

		
Next

end event

type cb_34 from commandbutton within w_util
boolean visible = false
integer x = 1449
integer y = 532
integer width = 361
integer height = 100
integer taborder = 200
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Upl CFA Items"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_status, ls_notes
long ll_ret, ll_row, ll_find, ll_contact, ll_cfa, ll_gigp
datetime ldt_event_date
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_cfa_item_load', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

of_add_log('Total rows retrieved: ' + String(ll_ret))

For ll_row = 1 to ll_ret

	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	
	If ll_cfa > 0 then
		ls_status = lds_data.GetItemString(ll_row, 'project_status_comment')
		ldt_event_date = lds_data.GetItemDateTime(ll_row, 'event_date')
		ls_notes = lds_data.GetItemString(ll_row, 'event_notes')
		
		of_cleanse_text(ls_status)
		of_cleanse_text(ls_notes)
		
		select gigp_id
		into :ll_gigp
		from gigp_application
		where cfa_no = :ll_cfa;
		
		If ll_gigp > 0 Then

			update gigp_cfa_items
			set project_status_comment = :ls_status,
				event_date = :ldt_event_date,
				event_notes = :ls_notes
			where gigp_id = :ll_gigp;

		of_add_log('Processed CFA# ' + string(ll_cfa) + '.  SQLCode = ' + String(SQLCA.SQLCode))
			
		
		End If
		
	End If
	
		
Next

end event

type cb_33 from commandbutton within w_util
boolean visible = false
integer x = 1010
integer y = 532
integer width = 361
integer height = 100
integer taborder = 190
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = ".ini folder"
end type

event clicked;long ll_len, ll_pos
string ls_file, ls_dir

ls_file = gnv_app.of_getappinifile()

ll_len = Len(ls_file)

If ll_len > 0 Then
	For ll_pos = ll_len to 1 Step -1
		If Mid(ls_file, ll_pos, 1) = '\' Then
			ls_dir = Left(ls_file, ll_pos)
			Exit
		End If
	Next
End If

messagebox('file', ls_file)
messagebox('folder', ls_dir)
end event

type cb_32 from commandbutton within w_util
boolean visible = false
integer x = 571
integer y = 532
integer width = 361
integer height = 100
integer taborder = 180
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Upd CV GIS"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_lat, ls_long, ls_comment
long ll_ret, ll_row, ll_find, ll_contact, ll_cfa, ll_gigp, ll_proj, ll_total
decimal ld_lat, ld_long, ld_old_lat, ld_old_long
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select project_id, gps_latitude, gps_longitude from cv_project', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ll_ret = lds_data.ImportFile(Text!, "c:\cvapgis.txt")

of_add_log('Total rows imported = ' + String(ll_ret))

ll_total = 0

For ll_row = 1 to ll_ret
	ll_proj = lds_data.GetItemNumber(ll_row, 'project_id')
	ld_lat = lds_data.GetItemDecimal(ll_row, 'gps_latitude')
	ld_long = lds_data.GetItemDecimal(ll_row, 'gps_longitude')
	
	
	If NOT IsNull(ld_lat) and NOT IsNull(ld_long) and ld_lat <> 0 and ld_long <> 0 Then
	
		select gps_latitude, gps_longitude, comments
		into :ld_old_lat, :ld_old_long, :ls_comment
		from cv_project
		where project_id = :ll_proj;
		
		If IsNull(ld_old_lat) Then 
			ls_lat = '[none]'
		Else
			ls_lat = String(ld_old_lat)
		End If
		
		If IsNull(ld_old_long) Then
			ls_long = '[none]'
		Else
			ls_long = String(ld_old_long)
		End If
		
		ll_total++
		
		If ls_comment > '' Then
			ls_comment = ';  Coordinates updated from consultant inspection from old Lat = ' + ls_lat + ' to new Lat = ' + String(ld_lat) + ' and old Long = ' + ls_long + ' to new Long = ' + String(ld_long)
		else
			ls_comment = 'Coordinates updated from consultant inspection from old Lat = ' + ls_lat + ' to new Lat = ' + String(ld_lat) + ' and old Long = ' + ls_long + ' to new Long = ' + String(ld_long)
		End If
		
		Update cv_project
		set gps_latitude = :ld_lat,
			gps_longitude = :ld_long,
			comments = comments + :ls_comment
		where project_id = :ll_proj;
		
		of_add_log(ls_comment)
		
		
	End If
	
Next


of_add_log('Done. Total updated = ' + String(ll_total))
end event

type cb_31 from commandbutton within w_util
boolean visible = false
integer x = 133
integer y = 532
integer width = 361
integer height = 100
integer taborder = 170
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Try Catch"
end type

event clicked;try
	//Whatever you want to try...
	
catch (Throwable ll_Throw)
	Messagebox('Failure', 'Update Failed')
	
finally
	MessageBox('Success', 'Update Succeeded')
		
end try
end event

type cb_30 from commandbutton within w_util
boolean visible = false
integer x = 2327
integer y = 436
integer width = 361
integer height = 100
integer taborder = 160
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "LdR5Proj/Cou"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_county, ls_fips, ls_proj
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_amtid, ll_pos
decimal ld_amt
n_ds lds_data

//loop through apps and find county fips code based on the county name entered on the CFA
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_load_county', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()


For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	ls_county = Upper(Trim(lds_data.GetItemString(ll_row, 'county')))
	ls_proj = lds_data.GetItemString(ll_row, 'cwsrf_no')

	Select ref_code
	Into	 :ls_fips
	From 	 gigp_reference
	Where  category     = "County"
	And   upper(ref_value) = :ls_county;
	
	of_add_log(String(ll_gigp) + ':  ' + ls_county + ' matches to ' + ls_fips)
	of_add_log('Updating Project No to ' + ls_proj)
	
	update gigp_application
	set county_fips_code = :ls_fips,
		project_no = :ls_proj
	where gigp_id = :ll_gigp;

	
Next

end event

type cb_29 from commandbutton within w_util
boolean visible = false
integer x = 1888
integer y = 436
integer width = 361
integer height = 100
integer taborder = 160
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "LS Rpt"
end type

event clicked;// OLD STUFF - 4/14/2025 - Greg

//decimal ld_balance
//string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_county, ls_fips
//long ll_ret, ll_row, ll_find, ll_loan_id
//n_ds lds_data
//
////loop through apps and find county fips code based on the county name entered on the CFA
////ls_syntax = sqlca.SyntaxFromSQL('select gigp_id from gigp_application where round_no = 100', 'Style(Type=Form)', error_syntaxfromSQL)
//ls_syntax = sqlca.SyntaxFromSQL("select loan_id, fund_id, program, loan_type, closing_dt, 0.00 as loan_balance from ls_loan where community = 'Nassau'", 'Style(Type=Form)', error_syntaxfromSQL)
//lds_data = CREATE n_ds
//lds_data.CREATE(ls_syntax, errorCreate)
//lds_data.SetTransObject(SQLCA)
//ll_ret = lds_data.Retrieve()
//
//
//For ll_row = 1 to ll_ret
//	ll_loan_id = lds_data.GetItemNumber(ll_row, 'loan_id')
//	ld_balance = 0
////	ld_balance = f_gettotaldue(ll_loan_id)
//	
//	lds_data.SetItem(ll_row, 'loan_balance', ld_balance)
//	of_add_log(String(ll_loan_id) + ':  ' + String(ld_balance))
//
//Next
//
//lds_data.SetFilter('loan_balance > 0')
//lds_data.Filter()
//
//lds_data.SaveAs("c:\LS_NassauCurrentFinancings.xlsx", XLSX!, True)
end event

type cb_28 from commandbutton within w_util
boolean visible = false
integer x = 1449
integer y = 436
integer width = 361
integer height = 100
integer taborder = 160
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Test Email"
end type

event clicked;n_cst_gwsend lnvo_gwsend
string ls_subject, ls_sendto, ls_message

 //***************************************************************
// Send email ALERT notification :
//***************************************************************
ls_subject = 'This is a test'
ls_message = 'This is a test only. please disregard.'
//ls_sendto = 'BatchJob-Notify@efc.ny.gov'
ls_sendto = 'steve.weingold@efc.ny.gov'

lnvo_gwsend.of_Reset()
lnvo_gwsend.of_AddRecipient(ls_sendto)
lnvo_gwsend.of_SetSubject(ls_subject)
lnvo_gwsend.of_SetMessage(ls_Message)
lnvo_gwsend.of_SendMail()
end event

type cb_27 from commandbutton within w_util
boolean visible = false
integer x = 1010
integer y = 436
integer width = 361
integer height = 100
integer taborder = 160
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Date Form"
end type

event clicked;string ls_date, ls_day, ls_month, ls_year
integer li_day
datetime ldt_date


ldt_date = DateTime(sle_entry.Text)

li_day = Day(Date(ldt_date))
ls_month = String(ldt_date, "mmmm")
ls_year = String(ldt_date, "yyyy")

ls_day = gf_convert_num(li_day)

ls_date = ls_day + ' day of ' + ls_month + ' ' + ls_year

messagebox('date', ls_date)


end event

type cb_26 from commandbutton within w_util
boolean visible = false
integer x = 571
integer y = 436
integer width = 361
integer height = 100
integer taborder = 160
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "CVAP POs"
end type

event clicked;// OLD STUFF - 4/14/2025 - Greg

//long ll_ret, ll_row, ll_proj
//string ls_waterbody
//n_ds lds_data
//
//lds_data = CREATE n_ds
//lds_data.DataObject = 'd_cvap_inspection_forms'
//lds_data.SetTransObject(SQLCA)
//
//ll_ret = lds_data.Retrieve()
//
//of_add_log(String(ll_ret) + ' rows retrieved.')
//
//If ll_ret <= 0 Then
//	Return
//End If
//
//For ll_row = 1 to ll_ret
//	ll_proj = lds_data.GetItemNumber(ll_row, 'project_id')
//	
//	ls_waterbody = ''
//	ls_waterbody = of_getlist('waterbody', ll_proj)
//	
//	If ls_waterbody > '' Then
//		lds_data.SetItem(ll_row, 'waterbodies', ls_waterbody)
//	End If
//	
//Next
//
//of_add_log('Done.')
//
//lds_data.SaveAs("c:\CVAPInspectionList.xlsx", XLSX!, True)
end event

type cb_25 from commandbutton within w_util
boolean visible = false
integer x = 133
integer y = 436
integer width = 361
integer height = 100
integer taborder = 160
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "My Docs"
end type

event clicked;ContextKeyword lcxk_base
string ls_ini, ls_os
string ls_data[]

//Determine OS
ls_os = ''

//Get efc.ini based on OS
Choose Case ls_os
	Case 'Windows7' //????
		this.GetContextService("Keyword", lcxk_base)
		lcxk_base.GetContextKeywords("APPDATA", ls_data)
		
		IF Upperbound(ls_data) > 0 THEN
			ls_ini = ls_data[1] + '\efc.ini'
		ELSE
			//not found
		END IF
		
	Case Else
		ls_ini = 'c:\windows\efc.ini'
		
End Choose

of_add_log(ls_ini)

/*
ALLUSERSPROFILE      location of the All Users Profile.
APPDATA              location where applications store data by default.
CD                   current directory string.
CLIENTNAME           client's NETBIOS name when connected to terminal server session.
CMDCMDLINE           command line used to start the current cmd.exe.
CMDEXTVERSION        version number of the current Command Processor Extensions.
CommonProgramFiles   path to the Common Files folder.
COMPUTERNAME         name of the computer.
COMSPEC              path to the command shell executable.
DATE                 current date.
ERRORLEVEL           error code of the most recently used command.
HOMEDRIVE            drive letter is connected to the user's home directory.
HOMEPATH             full path of the user's home directory.
HOMESHARE            network path to the user's shared home directory.
LOGONSEVER           name of the domain controller that validated the current logon session.
NUMBER_OF_PROCESSORS   number of processors installed on the computer.
OS                   name of the operating system.
                     (Windows XP and Windows 2000 list the operating system as Windows_NT.)
Path                 search path for executable files.
PATHEXT              file extensions that the operating system considers to be executable.
PROCESSOR_ARCHITECTURE   processor's chip architecture.
PROCESSOR_IDENTFIER  description of the processor.
PROCESSOR_LEVEL      model number of the computer's processor.
PROCESSOR_REVISION   revision number of the processor.
ProgramFiles         path to the Program Files folder.
PROMPT               command-prompt settings for the current interpreter.
RANDOM               random decimal number between 0 and 32767.
SESSIONNAME          connection and session names when connected to terminal server session.
SYSTEMDRIVE          drive containing the Windows root directory.
SYSTEMROOT           location of the Windows root directory.
TEMP and TMP         default temporary directories for applications that are available to
                     users who are currently logged on.
TIME                 current time.
USERDOMAIN           name of the domain that contains the user's account.
USERNAME             name of the user currently logged on.
USERPROFILE          location of the profile for the current user.
WINDIR               location of the OS directory.
*/
end event

type cb_24 from commandbutton within w_util
boolean visible = false
integer x = 2327
integer y = 340
integer width = 366
integer height = 100
integer taborder = 160
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load EPG2"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist
decimal ld_metric, ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
long ll_amtid
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_project_name
datastore lds_apps
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 101

ldt_app = DateTime(Date('8/12/2013'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_round101_apps'

lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve()

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If

For ll_row = 1 to ll_count
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ls_busname =  lds_apps.GetItemString(ll_row, 'business_name')
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	
	select project_name
	into :ls_project_name
	from gigp_round101_funding
	where app_id = :ll_cfa;
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'RECC-H'
	
	insert into gigp_application (gigp_id, round_no, program, project_name, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag, cfa_program_id)
	values (:ll_gigpID, :ii_round, 'EPG', :ls_project_name, 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0, 138);
	
	
	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('Application added for ' + ls_busname)
	
	
	//Funding
	//Create Funding Amounts
	If ls_funding_rec = 'RECC-H' Then
		//Funds Requested
		select fr_app, fr_rec
		into :ld_app_amt, :ld_rec_amt
		from gigp_round101_funding
		where app_id = :ll_cfa;

		ll_amtid = f_gettokenvalue('amountID', 1)
		
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_amtid, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_app_amt, :ld_rec_amt, 'system', '12/12/2013');
			
		//Total Project Funding
		select tpf_app, tpf_rec
		into :ld_app_tpf, :ld_rec_tpf
		from gigp_round101_funding
		where app_id = :ll_cfa;
		
		ld_app_tpf -= ld_app_amt
		ld_rec_tpf -= ld_rec_amt
		
		ll_amtid = f_gettokenvalue('amountID', 1)
		
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_amtid, :ll_gigpID, 'CFATOTALPROJ', 'CFATotalProj', null, :ld_app_tpf, :ld_rec_tpf, 'system', '12/12/2013');
	
	End If
	
	
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	
	//Insert Project Location Record (then link political districts to it)
	ls_addr = of_get_answer(928, ll_cfa)
	
	If IsNull(ls_addr) or ls_addr = '' Then
		ls_addr = of_get_answer(971, ll_cfa)
	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	select max(contact_id)
	into :ll_plc
	from gigp_contacts
	where upper(organization) = upper(:ls_busname)
	and upper(mail_city) = upper(:ls_city)
	and first_name is null
	and last_name is null;
	
	If IsNull(ll_plc) or ll_plc <= 0 Then
		of_add_log('New Project Location record added for ' + String(ll_gigpId))
		
		ll_plc = f_gettokenvalue('contactID', 1)
		
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	Else
		of_add_log('Project Location record MATCHED for ' + String(ll_gigpId))
		
	End If
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
//	ls_senate = Trim(lds_apps.GetItemString(ll_row, 'senate'))
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	////////////////////////////////////////////////////////////////////////////////
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)

	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and last_name is null;
	
	
	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)
		ls_city = of_get_answer(552, ll_cfa)
		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	
	
	/////////////////////////////////////////////////////////////////////////////////
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If


Next
end event

type cb_23 from commandbutton within w_util
boolean visible = false
integer x = 2327
integer y = 244
integer width = 361
integer height = 100
integer taborder = 160
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R5 Apps"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist
decimal ld_metric
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other, ll_amtid
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni, ls_recchigh
decimal ld_app_amt, ld_rec_amt, ld_app_tpf, ld_rec_tpf
datastore lds_apps
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_eligible = ',27107,26857,26983,27472,27521,29540,29541,29677,29807,29963,30036,30080,30273,30799,31136,31632,32476,27655,23735,25988,26932,27193,27518,27810,27924,28026,28064,28085,28130,28135,28469,28754,28865,28997,29249,29443,29870,29881,29961,29993,30303,30511,30545,30630,30754,30808,30896,30962,31017,31094,31558,31565,31783,31785,31797,31961,32157,32235,32240,32632,'
ls_recchigh = ',29807,30273,29963,30080,27521,30799,30036,26983,31136,29677,32476,29540,29541,27472,31632,26857,27107,'
ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 5

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

ldt_app = DateTime(Date('8/12/2013'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_round5_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve()

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If


For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	
	select gigp_id
	into :ll_gigpID
	from dbo.gigp_cfa_project_ids
	where app_id = :ll_cfa;
	
	ls_busname =  lds_apps.GetItemString(ll_row, 'business_name')
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	If Pos(ls_eligible, ',' + String(ll_cfa) + ',') > 0  Then
		ls_appStatus = 'ELIGIBLE'
		
		If Pos(ls_recchigh, ',' + String(ll_cfa) + ',') > 0 Then
			ls_funding_rec = 'RECC-H'
		Else
			ls_funding_rec = 'DONOTREC'
		End If
		
	Else
		ls_appStatus = 'INELIGIBLE'
		ls_funding_rec = 'INELIGIBLE'
	End If
	
	insert into gigp_application (gigp_id, round_no, program, project_name, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag)
	values (:ll_gigpID, :ii_round, 'GIGP', :ls_busname, 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0);
	
	of_add_log('Application added for ' + ls_busname)
	
	//Funding
	//Create Funding Amounts
	If ls_funding_rec = 'RECC-H' Then
		//Funds Requested
		select fr_app, fr_rec
		into :ld_app_amt, :ld_rec_amt
		from gigp_cfa_funding_amounts
		where app_id = :ll_cfa;

		ll_amtid = f_gettokenvalue('amountID', 1)

		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_amtid, :ll_gigpID, 'GIGPFR', 'Requested', null, :ld_app_amt, :ld_rec_amt, 'system', '12/12/2013');
			
		//Total Project Funding
		select tpf_app, tpf_rec
		into :ld_app_tpf, :ld_rec_tpf
		from gigp_cfa_funding_amounts
		where app_id = :ll_cfa;
		
		ld_app_tpf -= ld_app_amt
		ld_rec_tpf -= ld_rec_amt
		
		ll_amtid = f_gettokenvalue('amountID', 1)
		
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_amtid, :ll_gigpID, 'CFATOTALPROJ', 'CFATotalProj', null, :ld_app_tpf, :ld_rec_tpf, 'system', '12/12/2013');
	
	End If
	
	
	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
	
	//Create Metrics  
	of_insertMetric(1282, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OSAVE')	
	of_insertMetric(1285, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OREUSE')	
	of_insertMetric(1288, ll_gigpID, ll_cfa, 'Green Infrastructure', 'RUNOFFREDUCTION')
	of_insertMetric(1291, ll_gigpID, ll_cfa, 'Green Infrastructure', 'TONSYEARSEDIMENT')
	of_insertMetric(1314, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADSALT')
	of_insertMetric(1312, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADPHOS')
	of_insertMetric(1310, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADNITR')
	of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
	of_insertSummary(1297, ll_gigpId, ll_cfa, 'waterBodies')
	of_insertSummary(1296, ll_gigpId, ll_cfa, 'additWaterQualBen')
	of_insertSummary(1295, ll_gigpId, ll_cfa, 'spurGreenInnov')
	of_insertSummary(1294, ll_gigpId, ll_cfa, 'buildGreenCapacty')
	of_insertSummary(1270, ll_gigpId, ll_cfa, 'projMonitoring')
	of_insertSummary(1268, ll_gigpId, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_add_log('Summaries added for ' + ls_busname)

	
	//Create Budget (Total Project Costs???)
//	of_insertAmount(670, ll_gigpId, ll_cfa, 'PLN', 'Engineering')
//	of_insertAmount(672, ll_gigpId, ll_cfa, 'DES', 'Engineering')
//	of_insertAmount(674, ll_gigpId, ll_cfa, 'TCC', 'Construction')
//	of_insertAmount(679, ll_gigpId, ll_cfa, 'MISC', 'Miscellaneous')
	
//	of_add_log('Budget added for ' + ls_busname)
//	of_insertAmount(658, ll_gigpId, ll_cfa, 'GIGPFR', 'Reqeusted') ?????????????????R4
//	of_insertAmount(659, ll_gigpId, ll_cfa, '10MMN', 'Matching')
	
//	Need to discuss further: **same numbers for R4
//	of_insertAmount(660, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(662, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(664, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(665, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(668, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
	
//	of_add_log('Funding added for ' + ls_busname)
	
	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
	
//		SetNull(ls_checklist)
//		
//		ls_checklist = of_get_answer(1278, ll_cfa)
//		
//		If NOT IsNull(ls_checklist) and ls_checklist > '' Then
//			
//			If Upper(Trim(ls_checklist)) = 'YES' Then
//				li_checklist = 1
//			Else
//				li_checklist = 0
//			End If
//			
//		End If
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		//Insert rest of checklist items
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it) (use applicant for round 5 since business name not given)
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_addr = of_get_answer(928, ll_cfa)
	
	If IsNull(ls_addr) or ls_addr = '' Then
		ls_addr = of_get_answer(971, ll_cfa)
	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	select max(contact_id)
	into :ll_plc
	from gigp_contacts
	where upper(organization) = upper(:ls_busname)
	and upper(mail_city) = upper(:ls_city)
	and first_name is null
	and last_name is null;
	
	If IsNull(ll_plc) or ll_plc <= 0 Then
		of_add_log('New Project Location record added for ' + String(ll_gigpId))
		
		ll_plc = f_gettokenvalue('contactID', 1)
		
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	Else
		of_add_log('Project Location record MATCHED for ' + String(ll_gigpId))
		
	End If
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysSenate', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysSenate', :li_district, 2010);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
				values(:ll_plc, 'nysAssembly', :li_district, 2010);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
			values(:ll_plc, 'nysAssembly', :li_district, 2010);
			
		End If
		
	End If
	
	
	/***************/

	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)
	ls_city = of_get_answer(552, ll_cfa)
	
	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and upper(mail_city) = upper(:ls_city);
	
	

	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)

		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

//		ls_addr =  lds_apps.GetItemString(ll_row, 'applicantstreet')
//		ls_city = lds_apps.GetItemString(ll_row, 'applicantcity')
//		ls_state = lds_apps.GetItemString(ll_row, 'applicantstate')
//		ls_zip = lds_apps.GetItemString(ll_row, 'applicantzip')
//		ls_email = lds_apps.GetItemString(ll_row, 'applicantemail')
		

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
//	ls_fname = lds_apps.GetItemString(ll_row, 'addlfname')
//	ls_lname = lds_apps.GetItemString(ll_row, 'addllname')
//	ls_title = lds_apps.GetItemString(ll_row, 'addltitle')
//	ls_email = lds_apps.GetItemString(ll_row, 'addlemail')
	
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If
	

Next

//of_add_log('Done adding Contacts')

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps
end event

type cb_22 from commandbutton within w_util
boolean visible = false
integer x = 2327
integer y = 148
integer width = 361
integer height = 100
integer taborder = 160
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Clean File"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_desc, ls_file
long ll_ret, ll_row, ll_find, ll_question, ll_save
decimal ld_lat, ld_long
n_ds lds_data

ls_syntax = sqlca.SyntaxFromSQL('select gigp_id, comments from gigp_notes where 1=2', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)

ls_file = 'G:\EPG (Engineering Planning Grant)\PressReadyDesc.txt'

ll_ret = lds_data.ImportFile(Text!, ls_file)

If MessageBox('Data Import', String(ll_ret) + ' data rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ls_desc = lds_data.GetItemString(ll_row, 'comments')
	of_cleanse_text(ls_desc)
	lds_data.SetItem(ll_row, 'comments', ls_desc)
Next

lds_data.SaveAs(ls_file, Text!, False)

of_add_log("Done.")
end event

type cb_21 from commandbutton within w_util
boolean visible = false
integer x = 2327
integer y = 52
integer width = 361
integer height = 100
integer taborder = 160
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Syb Dt Format"
end type

event clicked;integer li_count
string ls_date

For li_count = 1 to 400
	select convert(varchar(50), getdate(), :li_count)
	into :ls_date
	from gigp_tokens
	where token_type = 'budgetAmtID';
	
	of_add_log(String(li_count) + ':  ' + ls_date)
	
	
Next
end event

type cb_20 from commandbutton within w_util
boolean visible = false
integer x = 1888
integer y = 340
integer width = 361
integer height = 100
integer taborder = 150
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load RDAs"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_title, ls_desc, ls_retention
long ll_ret, ll_row, ll_find, ll_contact, ll_cfa
decimal ld_lat, ld_long
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select rda_no, title, description, retention from arms_rda', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.ImportFile(Text!, 'c:\rda.txt')

If MessageBox('RDA Import', String(ll_ret) + ' rows imported. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If


For ll_row = 1 to ll_ret

	ls_title = String(lds_data.GetItemString(ll_row, 'title'))
	ls_desc = String(lds_data.GetItemString(ll_row, 'description'))
	ls_retention = String(lds_data.GetItemString(ll_row, 'retention'))
	
	of_cleanse_text(ls_title)
	of_cleanse_text(ls_desc)
	of_cleanse_text(ls_retention)
	
	lds_data.SetItem(ll_row, 'title', ls_title)
	lds_data.SetItem(ll_row, 'description', ls_desc)
	lds_data.SetItem(ll_row, 'retention', ls_retention)
		
Next


lds_data.SaveAs('c:\rda_clean.txt', Text!, False)
end event

type cb_19 from commandbutton within w_util
boolean visible = false
integer x = 1449
integer y = 340
integer width = 361
integer height = 100
integer taborder = 150
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Add County"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_county, ls_fips
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_amtid, ll_pos
decimal ld_amt
n_ds lds_data

//loop through apps and find county fips code based on the county name entered on the CFA
//ls_syntax = sqlca.SyntaxFromSQL('select gigp_id from gigp_application where round_no = 100', 'Style(Type=Form)', error_syntaxfromSQL)
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_load_county', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()


For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	ii_round = lds_data.GetItemNumber(ll_row, 'round_no')
	
	select cfa_no
	into :ll_cfa
	from gigp_application
	where gigp_id = :ll_gigp;
	
	//Process...
	
	ls_county = of_get_answer(972, ll_cfa)
	
//	ll_pos = POS(ls_county, 'County')  //because some have "Albany County" instead of just "Albany"
//	
//	If ll_pos > 0 Then
//		ls_county = Left(ls_county, ll_pos - 1)
//	End If
	
	ls_county = upper(Trim(ls_county))
	
	Select ref_code
	Into	 :ls_fips
	From 	 gigp_reference
	Where  category     = "County"
	And   upper(ref_value) = :ls_county;
	
	of_add_log(String(ll_cfa) + ':  ' + ls_county + ' matches to ' + ls_fips)
	
	update gigp_application
	set county_fips_code = :ls_fips
	where gigp_id = :ll_gigp;

	
Next

end event

type cb_18 from commandbutton within w_util
boolean visible = false
integer x = 1010
integer y = 340
integer width = 361
integer height = 100
integer taborder = 150
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Upd GIS"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_lat, ls_long
long ll_ret, ll_row, ll_find, ll_contact, ll_cfa, ll_gigp
decimal ld_lat, ld_long
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_load_coordinates', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()


For ll_row = 1 to ll_ret

	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
//	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	ls_lat = String(lds_data.GetItemDecimal(ll_row, 'latitude'))
	ls_long = String(lds_data.GetItemDecimal(ll_row, 'longitude'))
	
	If ll_cfa > 0 Then
		select contact_id
		into :ll_contact
		from gigp_contact_links
		where contact_type = 'PLC'
//		and gigp_id = :ll_gigp;
		and gigp_id = (select gigp_id
							from gigp_application
							where cfa_no = :ll_cfa);
							
		If ll_contact > 0 Then
			update gigp_contacts
			set gis_latitude = :ls_lat,
				gis_longitude = :ls_long
			where contact_id = :ll_contact;
			
			of_add_log('CFA# ' + String(ll_cfa) + ' updated coorrdinates to ' + ls_lat + ' / ' + ls_long)
//			of_add_log('GIGP# ' + String(ll_gigp) + ' updated coorrdinates to ' + ls_lat + ' / ' + ls_long)
			
		End If
		
	End If
		
Next






end event

type cb_17 from commandbutton within w_util
boolean visible = false
integer x = 571
integer y = 340
integer width = 361
integer height = 100
integer taborder = 150
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Upd Pol Dist"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip, ls_contact, ls_con, ls_ass, ls_sen
integer li_create, li_con, li_ass, li_sen
long ll_ret, ll_row, ll_find, ll_contact, ll_cfa
string ls_lat, ls_lon, ls_orig_lat, ls_orig_lon
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select * from pol_dist_fix where application = "gigp"', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If MessageBox('District Retrieve', String(ll_ret) + ' returned. Continue?', Question!, YesNo!, 1) = 2 Then
	Return
End If

For ll_row = 1 to ll_ret
	ls_contact = lds_data.GetItemString(ll_row, 'c_proj_no')
	ll_contact = Long(Trim(ls_contact))
	
	ls_con = lds_data.GetItemString(ll_row, 'uscon')
	li_con = Integer(Trim(ls_con))
	
	ls_ass = lds_data.GetItemString(ll_row, 'nyass')
	li_ass = Integer(Trim(ls_ass))
	
	ls_sen = lds_data.GetItemString(ll_row, 'nysen')
	li_sen = Integer(Trim(ls_sen))
	
	parent.of_add_log(ls_contact + ' being processed with Congress = ' + ls_con + ', Assembly = ' + ls_ass + ', Senate = ' + ls_sen)
	
	delete gigp_political_districts
	where contact_id = :ll_contact
	and census_yr = 2010;
	
	If NOT IsNull(li_con) Then
		insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
		values (:ll_contact, 'usCongress', :li_con, 2010);
	End If
	
	If NOT IsNull(li_ass) Then
		insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
		values (:ll_contact, 'nysAssembly', :li_ass, 2010);
	End If
	
	If NOT IsNull(li_sen) Then
		insert into gigp_political_districts(contact_id, district_type, district_no, census_yr)
		values (:ll_contact, 'nysSenate', :li_sen, 2010);
	End If
	
Next

end event

type cb_16 from commandbutton within w_util
boolean visible = false
integer x = 133
integer y = 340
integer width = 361
integer height = 100
integer taborder = 150
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Convert GIS"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip
integer li_create
long ll_ret, ll_row, ll_find, ll_contact, ll_cfa
string ls_lat, ls_lon, ls_orig_lat, ls_orig_lon
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_contacts where (gis_longitude > "" and gis_longitude like "% %") or (gis_latitude > "" and gis_latitude like "% %")', 'Style(Type=Form)', error_syntaxfromSQL)

lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()


For ll_row = 1 to ll_ret
	ll_contact = lds_data.GetItemNumber(ll_row, 'contact_id')
	
	//Process... 
	ls_orig_lat = lds_data.GetItemString(ll_row, 'gis_latitude')
	ls_orig_lon = lds_data.GetItemString(ll_row, 'gis_longitude')
	
	ls_lat = parent.of_convert_decimal(ls_orig_lat)
	ls_lon = parent.of_convert_decimal(ls_orig_lon)
	
	parent.of_add_log(String(ll_contact) + ':  ' + ls_lat + '  /  ' + ls_lon)
	
	Update gigp_contacts
	set gis_latitude = :ls_lat,
		gis_longitude = :ls_lon,
		comments = convert(varchar(200), comments) + 'Original GIS: ' + :ls_orig_lat + ' / ' + :ls_orig_lon
	where contact_id = :ll_contact;
	
	
Next

end event

type cb_15 from commandbutton within w_util
boolean visible = false
integer x = 1888
integer y = 244
integer width = 361
integer height = 100
integer taborder = 150
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Add EPG Data"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_amtid
decimal ld_amt
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select gigp_id from gigp_application where round_no = 100', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()


For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	select cfa_no
	into :ll_cfa
	from gigp_application
	where gigp_id = :ll_gigp;
	
	//Process...
	
	//Update project names
	
	
	//Add Costs and award amounts
	
	
	
	
Next

end event

type cb_14 from commandbutton within w_util
boolean visible = false
integer x = 1888
integer y = 148
integer width = 361
integer height = 100
integer taborder = 100
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R4 Funds Rec"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_amtid
decimal ld_amt
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select gigp_id from gigp_application where round_no = 4', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()


For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	select cfa_no
	into :ll_cfa
	from gigp_application
	where gigp_id = :ll_gigp;
	
	SetNull(ld_amt)
	
	//Get amt
	select sum(amount)
	into :ld_amt
	from gigp_round4_funds_req
	where cfa_no = :ll_cfa;
	
	
	If ld_amt > 0 Then
		ll_amtid = f_gettokenvalue('amountID', 1)
		
		insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
		values (:ll_amtid, :ll_gigp, 'GIGPFR', 'Requested', null, :ld_amt, 0, 'SYSTEM', getdate());
		
		parent.of_add_log('GIGP Id ' + String(ll_gigp) + ' amount inserted:  ' + String(ld_amt))
		
		
		
	End If
	
Next

end event

type cb_13 from commandbutton within w_util
boolean visible = false
integer x = 1449
integer y = 148
integer width = 361
integer height = 100
integer taborder = 90
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "R4 Regions"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select gigp_id from gigp_application where round_no = 4', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()


For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	SetNull(ls_zip)
	
	//Get zip code of project location
	select max(c.mail_zip)
	into :ls_zip
	from gigp_contacts c, gigp_contact_links l
	where c.contact_id = l.contact_id
	and l.gigp_id = :ll_gigp
	and l.contact_type = 'PLC';
	
	//Search table for it and get region
	SetNull(ls_region)
	
	If ls_zip > '' Then
		ls_zip = Left(Trim(ls_zip), 5)
		
		select max(region)
		into :ls_region
		from gigp_dec_region_by_zip
		where zip = :ls_zip;
		
		If ls_region > '' Then
			Update gigp_application
			set dec_region = :ls_region
			where gigp_id = :ll_gigp;

			parent.of_add_log('Zipcode ' + ls_zip + ' = Region ' + ls_region)
			
		End If
		
	End If
	
Next
end event

type cb_12 from commandbutton within w_util
boolean visible = false
integer x = 133
integer y = 244
integer width = 361
integer height = 100
integer taborder = 110
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Reload Notes"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_amtid
decimal ld_amt
n_ds lds_data

ii_round = 4

delete gigp_notes
where gigp_id >= 700;

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select gigp_id from gigp_application where round_no = 4', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()


For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	select cfa_no
	into :ll_cfa
	from gigp_application
	where gigp_id = :ll_gigp;
	
	//Create Summaries
	of_insertSummary(1297, ll_gigp, ll_cfa, 'waterBodies')
	of_insertSummary(1296, ll_gigp, ll_cfa, 'additWaterQualBen')
	of_insertSummary(1295, ll_gigp, ll_cfa, 'spurGreenInnov')
	of_insertSummary(1294, ll_gigp, ll_cfa, 'buildGreenCapacty')
	of_insertSummary(1271, ll_gigp, ll_cfa, 'outrchEdOpportunty')
	of_insertSummary(1270, ll_gigp, ll_cfa, 'projMonitoring')
	of_insertSummary(1268, ll_gigp, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigp, ll_cfa, 'appProjDescription')
		
Next

end event

type cb_11 from commandbutton within w_util
boolean visible = false
integer x = 571
integer y = 244
integer width = 361
integer height = 100
integer taborder = 120
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load Tot Proj"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_region, ls_zip
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_amtid
decimal ld_amt, ld_total
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select gigp_id from gigp_application where round_no = 4', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

parent.of_add_log('Records returned: ' + String(ll_ret))

For ll_row = 1 to ll_ret
	ll_gigp = lds_data.GetItemNumber(ll_row, 'gigp_id')
	
	select cfa_no
	into :ll_cfa
	from gigp_application
	where gigp_id = :ll_gigp;
	
	SetNull(ld_total)
	SetNull(ld_amt)
	
	//Get amt
	select totalfunding
	into :ld_total
	from gigp_round4_funding
	where cfa_no = :ll_cfa;
	
	If IsNull(ld_total) Then ld_total = 0
	
	ll_amtid = f_gettokenvalue('amountID', 1)
	
	select ref_amt
	into :ld_amt
	from gigp_amounts
	where gigp_id = :ll_gigp
	and ref_code = 'GIGPFR';
	
	If IsNull(ld_amt) Then ld_amt = 0
	
	ld_amt = ld_total - ld_amt
	
	insert into gigp_amounts (amount_id, gigp_id, ref_code, sub_category, amt_description, ref_amt, approved_amt, last_updated_by, last_updated_dt)
	values (:ll_amtid, :ll_gigp, 'CFATOTALPROJ', 'CFATotalProj', null, :ld_amt, 0, 'SYSTEM', getdate());
	
	parent.of_add_log('GIGP Id ' + String(ll_gigp) + ' amount inserted:  ' + String(ld_amt))
		
	
Next


end event

type cb_10 from commandbutton within w_util
boolean visible = false
integer x = 1010
integer y = 244
integer width = 361
integer height = 100
integer taborder = 130
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Inelig Notes"
end type

event clicked;string ls_syntax, error_syntaxfromSQL, errorCreate, ls_reason
integer li_create
long ll_ret, ll_row, ll_find, ll_gigp, ll_cfa, ll_amtid
n_ds lds_data

//loop through round 4 apps and find region based on zipcode of PLC
ls_syntax = sqlca.SyntaxFromSQL('select * from gigp_inelig_reasons', 'Style(Type=Form)', error_syntaxfromSQL)
lds_data = CREATE n_ds
lds_data.CREATE(ls_syntax, errorCreate)
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

parent.of_add_log('Records returned: ' + String(ll_ret))

For ll_row = 1 to ll_ret
	ll_cfa = lds_data.GetItemNumber(ll_row, 'cfa_no')
	ls_reason = lds_data.GetItemString(ll_row, 'inelig_reason')
	
	select gigp_id
	into :ll_gigp
	from gigp_application
	where cfa_no = :ll_cfa;
	
	If ll_gigp > 0 Then
		insert into gigp_notes (gigp_id, note_dt, note_category, note_type, user_id, comments)
		values (:ll_gigp, '10/05/2012', 'NOTE', 'INELIGIBILITY', 'SYSTEM', :ls_reason);
		
		parent.of_add_log('Note added for gigp ' + String(ll_gigp))
		
	End If
	
Next


end event

type cb_7 from commandbutton within w_util
boolean visible = false
integer x = 1449
integer y = 244
integer width = 361
integer height = 100
integer taborder = 140
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load EPGs"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist
decimal ld_metric
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni
datastore lds_apps
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 100

ldt_app = DateTime(Date('12/01/2012'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_round100_apps'

lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve()

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If

For ll_row = 1 to ll_count
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ls_busname =  lds_apps.GetItemString(ll_row, 'business_name')
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	ls_appStatus = 'ELIGIBLE'
	ls_funding_rec = 'DONOTREC'
	
	insert into gigp_application (gigp_id, round_no, project_name, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag)
	values (:ll_gigpID, :ii_round, :ls_busname, 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0);
	
	
	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('Application added for ' + ls_busname)
	
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	
	//Insert Project Location Record (then link political districts to it)
	ls_addr = of_get_answer(928, ll_cfa)
	
	If IsNull(ls_addr) or ls_addr = '' Then
		ls_addr = of_get_answer(971, ll_cfa)
	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	select max(contact_id)
	into :ll_plc
	from gigp_contacts
	where upper(organization) = upper(:ls_busname)
	and upper(mail_city) = upper(:ls_city)
	and first_name is null
	and last_name is null;
	
	If IsNull(ll_plc) or ll_plc <= 0 Then
		of_add_log('New Project Location record added for ' + String(ll_gigpId))
		
		ll_plc = f_gettokenvalue('contactID', 1)
		
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	Else
		of_add_log('Project Location record MATCHED for ' + String(ll_gigpId))
		
	End If
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
//	ls_senate = Trim(lds_apps.GetItemString(ll_row, 'senate'))
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no)
				values(:ll_plc, 'nysSenate', :li_district);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysSenate', :li_district);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysSenate', :li_district);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no)
				values(:ll_plc, 'nysAssembly', :li_district);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysAssembly', :li_district);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysAssembly', :li_district);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)

	ll_applicant = f_gettokenvalue('contactID', 1)
	ls_addr = of_get_answer(551, ll_cfa)
	ls_city = of_get_answer(552, ll_cfa)
	ls_state = of_get_answer(553, ll_cfa)
	ls_zip = of_get_answer(554, ll_cfa)
	ls_email = of_get_answer(555, ll_cfa)

	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	////////////////////////////////////////////////////////////////////////////////
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)

	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant)
	and last_name is null;
	
	
	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
		ls_addr = of_get_answer(551, ll_cfa)
		ls_city = of_get_answer(552, ll_cfa)
		ls_state = of_get_answer(553, ll_cfa)
		ls_zip = of_get_answer(554, ll_cfa)
		ls_email = of_get_answer(555, ll_cfa)

		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	
	
	/////////////////////////////////////////////////////////////////////////////////
	
	
	//Add "Other" Contact???
	ls_fname = of_get_answer(1052, ll_cfa)
	ls_lname = of_get_answer(970, ll_cfa)
	ls_title = of_get_answer(1051, ll_cfa)
	ls_email = of_get_answer(561, ll_cfa)
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then
			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then
		SetNull(ll_other)
		
		select max(contact_id)
		into :ll_other
		from gigp_contacts
		where upper(first_name) = upper(:ls_fname)
		and upper(last_name) = upper(:ls_lname)
		and phone_1 = :ls_phone;
		
		If IsNull(ll_other) or ll_other <= 0 Then

			ll_other = f_gettokenvalue('contactID', 1)
	
			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
			
		End If
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If


Next
end event

type pb_1 from picturebutton within w_util
integer x = 2341
integer y = 3020
integer width = 110
integer height = 84
integer taborder = 200
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string picturename = "Sort!"
alignment htextalign = left!
end type

event clicked;string ls_null

SetNull(ls_null)

dw_log.SetSort(ls_null)
dw_log.Sort()
end event

type cb_9 from commandbutton within w_util
boolean visible = false
integer x = 133
integer y = 148
integer width = 361
integer height = 100
integer taborder = 60
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Marinas"
end type

event clicked;string ls_proj, ls_add1, ls_add2, ls_phone, ls_website, ls_vhf, ls_latitude, ls_county, ls_dates, ls_hours, ls_days, ls_operation, ls_fee, ls_longitude, ls_city, ls_state, ls_zip, ls_facility, ls_waterbody, ls_depth, ls_length, ls_capacity, ls_disposal, ls_restrooms, ls_type
long ll_projectId[] = {4,18,50,91,99,132,248,252,277,349,350,413,436,486,493,510,636,661,706,1120,1125,1171}
long ll_row
integer li_return, n
decimal ld_latp, ld_longp
n_ds lds_data

lds_data = CREATE n_ds
lds_data.DataObject = 'd_marina_sheets'

For n = 1 to 22

	//Retrieve the information for the bookmarks
	select p.project_name, p.address_line_1, p.address_line_2, p.city, p.state, p.zip, f.website_address, p.gps_latitude, p.gps_longitude, f.facility_name
	into :ls_proj, :ls_add1, :ls_add2, :ls_city, :ls_state, :ls_zip, :ls_website, :ld_latp, :ld_longp, :ls_facility
	from cv_project p, cv_facility f
	where f.facility_id = p.facility_id
	and p.project_id = :ll_projectId[n];

	select vhf_channel_monitored, convert(char, pumpout_fee_amt), county, pumpout_phone_number, disposal_method_cd
	into :ls_vhf, :ls_fee, :ls_county, :ls_phone, :ls_disposal
	from cv_project_pumpout
	where project_id = :ll_projectId[n];
	
	select restriction_desc
	into :ls_dates
	from cv_project_restriction
	where restriction_type_cd = 'DATES OP'
	and project_id = :ll_projectId[n];
	
	select restriction_desc
	into :ls_hours
	from cv_project_restriction
	where restriction_type_cd = 'TIME OP'
	and project_id = :ll_projectId[n];
	
	select restriction_desc
	into :ls_days
	from cv_project_restriction
	where restriction_type_cd = 'DAYS OP'
	and project_id = :ll_projectId[n];
	
	select restriction_desc
	into :ls_depth
	from cv_project_restriction
	where restriction_type_cd = 'DEPTH'
	and project_id = :ll_projectId[n];
	
	select restriction_desc
	into :ls_length
	from cv_project_restriction
	where restriction_type_cd = 'VESSEL SIZE'
	and project_id = :ll_projectId[n];
	
	select restriction_desc
	into :ls_capacity
	from cv_project_restriction
	where restriction_type_cd = 'CAPACITY'
	and project_id = :ll_projectId[n];
	
	select restriction_desc
	into :ls_restrooms
	from cv_project_restriction
	where restriction_type_cd = 'RESTROOMS'
	and project_id = :ll_projectId[n];
		
	
	//Format the address
	If NOT IsNull(ls_add2) Then ls_add1 += ', ' + ls_add2
	ls_add2 = ls_city + ', ' + ls_state + '  ' + ls_zip
	
	//Verify lat and  lon - use project if it exists, else use the facility
	ls_latitude = String(Round(ld_latp, 6))
	ls_longitude = String(Round(ld_longp, 6))
	
	If IsNull(ls_latitude) or IsNull(ls_longitude) or ls_latitude = '' or ls_longitude = '' Then
		ls_latitude = ''
		ls_longitude = ''
	End If
	
	//Format the phone number if it exists
	If IsNull(ls_phone) Then
		ls_phone = ''
	Else
		ls_phone = String(ls_phone,  '(@@@) @@@-@@@@')
	End If
	
	//Format the pumpout fee if it exists
	If IsNull(ls_fee) Then
		ls_fee = ''
	Else
		ls_fee = '$' + ls_fee
	End If
	
	//Get the operation list (potentially more than 1)
	ls_operation = of_getlist('operation', ll_projectId[n])
	
	//Get waterbodies
	ls_waterbody = of_getlist('waterbody', ll_projectId[n])
	
	ls_type = of_getlist('type', ll_projectId[n])
	
		
	//Handle nulls
	If IsNull(ls_proj) Then ls_proj = ''
	If IsNull(ls_add1) Then ls_add1 = ''
	If IsNull(ls_add2) Then ls_add2 = ''
	If IsNull(ls_website) Then ls_website = ''
	If IsNull(ls_county) Then ls_county = ''
	If IsNull(ls_latitude) Then ls_latitude = ''
	If IsNull(ls_longitude) Then ls_longitude = ''
	If IsNull(ls_dates) Then ls_dates = ''
	If IsNull(ls_hours) Then ls_hours = ''
	If IsNull(ls_days) Then ls_days = ''
	If IsNull(ls_vhf) Then ls_vhf = ''
	If IsNull(ls_operation) Then ls_operation = ''
	
	//Set values
	ll_row = lds_data.InsertRow(0)
	
	lds_data.SetItem(ll_row, 'marina_name', ls_facility + ' - ' + ls_proj)
	lds_data.SetItem(ll_row, 'waterbody', ls_waterbody)
	lds_data.SetItem(ll_row, 'latitude', ls_latitude)
	lds_data.SetItem(ll_row, 'longitude', ls_longitude)
	lds_data.SetItem(ll_row, 'phone', ls_phone)
	lds_data.SetItem(ll_row, 'vhf_channel', ls_vhf)
	lds_data.SetItem(ll_row, 'dates_of_op', ls_dates)
	lds_data.SetItem(ll_row, 'hours_of_op', ls_hours)
	lds_data.SetItem(ll_row, 'pumpout_services', ls_type)
	lds_data.SetItem(ll_row, 'facility_fee', ls_fee)
	lds_data.SetItem(ll_row, 'water_depth', ls_depth)
	lds_data.SetItem(ll_row, 'max_vessel_length', ls_length)
	lds_data.SetItem(ll_row, 'pumpout_capacity', ls_capacity)
	lds_data.SetItem(ll_row, 'disposal', ls_disposal)
	lds_data.SetItem(ll_row, 'restrooms', ls_restrooms)
	

Next

lds_data.SaveAs("c:\marina_data.xlsx", XLSX!, True)

end event

type cb_8 from commandbutton within w_util
boolean visible = false
integer x = 1010
integer y = 148
integer width = 361
integer height = 100
integer taborder = 80
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R4 Apps"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist
decimal ld_metric
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec, ls_eligible, ls_appStatus, ls_CFAtype, ls_muni
datastore lds_apps
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ls_eligible = ',14515,14734,14754,15162,15244,15325,15565,15645,15657,15685,15838,15994,16025,16027,16280,16346,16430,16490,16567,16608,16804,16867,16932,16955,17049,17080,17111,17172,17252,17307,17321,17346,17432,17576,17657,17691,17905,17911,17970,17973,18238,18299,18301,18374,18480,18503,18526,18628,18631,18652,18656,18686,18716,18752,18899,19074,19301,19368,19371,19436,19511,19633,19685,19721,19724,19751,19752,19797,19838,'
ls_muni = ',City,City,For-Profit,LLC,City,Town,Village,County,County or Town Improvement District,County,Not-For-Profit,School District,State,State,City,School District,Town,Village,'

ii_round = 4

If MessageBox('Raw Data', 'Add Raw Data?', Question!, YesNo!) = 1 Then
	
	of_add_log('Loading raw data')
	
	select count(*)
	into :ll_count
	from gigp_cfa_raw_data;
	
	of_add_log('gigp_cfa_raw_data initial count = ' + string(ll_count))
	
	If parent.of_load_rawdata() = -1 Then
		of_add_log('Error loading raw data.')
		Return
	End if
	
	of_add_log('Done loading raw data')
	
	MessageBox('Raw Data', 'Raw Data loaded.')
	
	select count(*)
	into :ll_count
	from gigp_cfa_raw_data;
	
	of_add_log('gigp_cfa_raw_data final count = ' + string(ll_count))
	
End If

If MessageBox('Application Data', 'Load Application Data?', Question!, YesNo!) = 2 Then
	Return
End If

ldt_app = DateTime(Date('7/16/2012'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_round4_apps'


lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve()

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If

For ll_row = 1 to ll_count
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ls_busname =  lds_apps.GetItemString(ll_row, 'business_name')
	ls_CFAtype = Trim(of_get_answer(549, ll_cfa))
	
	If Pos(ls_muni, ',' + ls_CFAtype + ',') > 0 Then
		ls_type = 'MUNI'
	Else
		ls_type = 'NMUN'
	End If
	
	If Pos(ls_eligible, ',' + String(ll_cfa) + ',') > 0  Then
		ls_appStatus = 'ELIGIBLE'
		ls_funding_rec = 'DONOTREC'
		
	Else
		ls_appStatus = 'INELIGIBLE'
		ls_funding_rec = 'INELIGIBLE'
	End If
	
	insert into gigp_application (gigp_id, round_no, project_name, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag)
	values (:ll_gigpID, :ii_round, :ls_busname, 'CW', 'Construction', 90, null, null, null, null, null, :ls_CFAtype, :ls_type, :ldt_app, :ls_appStatus, null, :ls_funding_rec, null, null, null, null, null, null, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0);
	
	of_add_log('Application added for ' + ls_busname)
	
	//Crearte CFA Items
	insert into gigp_cfa_items(gigp_id, grant_status, project_status, last_updated_dt, last_updated_by)
	values (:ll_gigpID, 'statusPending', 'statusGreen', getdate(), 'SYSTEM');
	
	of_add_log('CFA Items added for ' + ls_busname)
	
	//Create Metrics  
	of_insertMetric(1282, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OSAVE')	
	of_insertMetric(1285, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OREUSE')	
	of_insertMetric(1288, ll_gigpID, ll_cfa, 'Green Infrastructure', 'RUNOFFREDUCTION')
	of_insertMetric(1291, ll_gigpID, ll_cfa, 'Green Infrastructure', 'TONSYEARSEDIMENT')
	of_insertMetric(1314, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADSALT')
	of_insertMetric(1312, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADPHOS')
	of_insertMetric(1310, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADNITR')
	of_insertMetric(1306, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(1305, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(1300, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(1299, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
	of_insertSummary(1297, ll_gigpId, ll_cfa, 'waterBodies')
	of_insertSummary(1296, ll_gigpId, ll_cfa, 'additWaterQualBen')
	of_insertSummary(1295, ll_gigpId, ll_cfa, 'spurGreenInnov')
	of_insertSummary(1294, ll_gigpId, ll_cfa, 'buildGreenCapacty')
	of_insertSummary(1271, ll_gigpId, ll_cfa, 'outrchEdOpportunty')
	of_insertSummary(1270, ll_gigpId, ll_cfa, 'projMonitoring')
	of_insertSummary(1268, ll_gigpId, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
//	of_insertSummary(97, ll_gigpid, ll_cfa, 'ltOperationMaint') ????????????????????? R4?
	
	
	of_add_log('Summaries added for ' + ls_busname)

	
	//Create Budget (Total Project Costs???)
//	of_insertAmount(670, ll_gigpId, ll_cfa, 'PLN', 'Engineering')
//	of_insertAmount(672, ll_gigpId, ll_cfa, 'DES', 'Engineering')
//	of_insertAmount(674, ll_gigpId, ll_cfa, 'TCC', 'Construction')
//	of_insertAmount(679, ll_gigpId, ll_cfa, 'MISC', 'Miscellaneous')
	
//	of_add_log('Budget added for ' + ls_busname)
	
	//Create Funding
//	of_insertAmount(658, ll_gigpId, ll_cfa, 'GIGPFR', 'Reqeusted') ?????????????????R4
//	of_insertAmount(659, ll_gigpId, ll_cfa, '10MMN', 'Matching')
	
//	Need to discuss further: **same numbers for R4
//	of_insertAmount(660, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(662, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(664, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(665, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(668, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
	
//	of_add_log('Funding added for ' + ls_busname)
	
	//Insert checklist item for Project Required by MS 4...
	If ls_appStatus = 'ELIGIBLE' Then
	
		SetNull(ls_checklist)
		
		ls_checklist = of_get_answer(1278, ll_cfa)
		
		If NOT IsNull(ls_checklist) and ls_checklist > '' Then
			
			If Upper(Trim(ls_checklist)) = 'YES' Then
				li_checklist = 1
			Else
				li_checklist = 0
			End If
			
		End If
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
		
		//Insert rest of checklist items
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
		
		insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
		values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
		
	End If
	
	
	//Insert Project Location Record (then link political districts to it)
	ls_addr = of_get_answer(928, ll_cfa)
	
	If IsNull(ls_addr) or ls_addr = '' Then
		ls_addr = of_get_answer(971, ll_cfa)
	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
	ls_lon = of_get_answer(573, ll_cfa)
	ls_lat = of_get_answer(572, ll_cfa)

//	ls_lat = lds_apps.GetItemString(ll_row, 'lat')
//	ls_lon = lds_apps.GetItemString(ll_row, 'lon')
	
	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
	
	SetNull(ll_plc)
	
	select max(contact_id)
	into :ll_plc
	from gigp_contacts
	where upper(organization) = upper(:ls_busname)
	and upper(mail_city) = upper(:ls_city)
	and first_name is null
	and last_name is null;
	
	If IsNull(ll_plc) or ll_plc <= 0 Then
		of_add_log('New Project Location record added for ' + String(ll_gigpId))
		
		ll_plc = f_gettokenvalue('contactID', 1)
		
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	Else
		of_add_log('Project Location record MATCHED for ' + String(ll_gigpId))
		
	End If
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
//	ls_senate = Trim(lds_apps.GetItemString(ll_row, 'senate'))
	ls_senate = Trim(parent.of_get_answer(190, ll_cfa))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no)
				values(:ll_plc, 'nysSenate', :li_district);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysSenate', :li_district);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysSenate', :li_district);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
//	ls_assembly = Trim(lds_apps.GetItemString(ll_row, 'assembly'))
	ls_assembly = Trim(parent.of_get_answer(184, ll_cfa))

	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no)
				values(:ll_plc, 'nysAssembly', :li_district);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysAssembly', :li_district);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysAssembly', :li_district);
			
		End If
		
	End If
	
	
	/***************/

	
	
//	//Search for Applicant
//	SetNull(ll_applicant)
//	
//	ls_applicant = of_get_answer(546, ll_cfa)
//
//	select max(contact_id)
//	into :ll_applicant
//	from gigp_contacts
//	where Upper(organization) = Upper(:ls_applicant);
//	
//	
//	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
//	If IsNull(ll_applicant) or ll_applicant <= 0 Then
//		ll_applicant = f_gettokenvalue('contactID', 1)
//		ls_addr = of_get_answer(551, ll_cfa)
//		ls_city = of_get_answer(552, ll_cfa)
//		ls_state = of_get_answer(553, ll_cfa)
//		ls_zip = of_get_answer(554, ll_cfa)
//		ls_email = of_get_answer(555, ll_cfa)
//
////		ls_addr =  lds_apps.GetItemString(ll_row, 'applicantstreet')
////		ls_city = lds_apps.GetItemString(ll_row, 'applicantcity')
////		ls_state = lds_apps.GetItemString(ll_row, 'applicantstate')
////		ls_zip = lds_apps.GetItemString(ll_row, 'applicantzip')
////		ls_email = lds_apps.GetItemString(ll_row, 'applicantemail')
//		

//		ls_phone = of_get_answer(651, ll_cfa)
//		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
//		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
//		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
//		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
//		
//	
//		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
//		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
//		
//	End if
//	
//	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//	Values (:ll_applicant, :ll_gigpID, 'APP');
//	
//	
//	//Add "Other" Contact???
////	ls_fname = lds_apps.GetItemString(ll_row, 'addlfname')
////	ls_lname = lds_apps.GetItemString(ll_row, 'addllname')
////	ls_title = lds_apps.GetItemString(ll_row, 'addltitle')
////	ls_email = lds_apps.GetItemString(ll_row, 'addlemail')
//	
//	ls_fname = of_get_answer(1052, ll_cfa)
//	ls_lname = of_get_answer(970, ll_cfa)
//	ls_title = of_get_answer(1051, ll_cfa)
//	ls_email = of_get_answer(561, ll_cfa)
//	
//	ls_phone = of_get_answer(562, ll_cfa)
//	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
//	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
//	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
//	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
//
//	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
//		ls_fullname = ls_fname + ' ' + ls_lname
//	Else
//		ls_fullname = ''
//	End If
//
//	If ls_fullname > '' Then
//		SetNull(ll_other)
//		
//		select max(contact_id)
//		into :ll_other
//		from gigp_contacts
//		where upper(first_name) = upper(:ls_fname)
//		and upper(last_name) = upper(:ls_lname)
//		and phone_1 = :ls_phone;
//		
//		If IsNull(ll_other) or ll_other <= 0 Then
//			ll_other = f_gettokenvalue('contactID', 1)
//	
//			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
//			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
//			
//		End If
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		Values (:ll_other, :ll_gigpID, 'OTH');
//		
//	End If
//	
//	
//	//Add "Primary" Contact???
//	ls_fname = of_get_answer(547, ll_cfa)
//	ls_lname = of_get_answer(1049, ll_cfa)
//	ls_title = of_get_answer(1050, ll_cfa)
//	
//	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
//		ls_fullname = ls_fname + ' ' + ls_lname
//	Else
//		ls_fullname = ''
//	End If
//
//	If ls_fullname > '' Then
//		SetNull(ll_other)
//		
//		select max(contact_id)
//		into :ll_other
//		from gigp_contacts
//		where upper(first_name) = upper(:ls_fname)
//		and upper(last_name) = upper(:ls_lname)
//		and phone_1 = :ls_phone;
//		
//		If IsNull(ll_other) or ll_other <= 0 Then
//
//			ll_other = f_gettokenvalue('contactID', 1)
//	
//			insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
//			values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
//			
//		End If
//		
//		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
//		Values (:ll_other, :ll_gigpID, 'PRC');
//		
//	End If
	

Next

//of_add_log('Done adding Contacts')

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps
end event

type cb_report_count from commandbutton within w_util
boolean visible = false
integer x = 571
integer y = 148
integer width = 361
integer height = 100
integer taborder = 70
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Report Count"
end type

event clicked;dw_log.DataObject = 'd_report_count'
dw_log.SetTransObject(SQLCA)
dw_log.Retrieve()
end event

type cb_6 from commandbutton within w_util
boolean visible = false
integer x = 1888
integer y = 52
integer width = 361
integer height = 100
integer taborder = 50
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "S&&P Load"
end type

event clicked;string ls_input, ls_return, ls_archive, ls_cusip, ls_header, ls_trailer, ls_today, ls_now, ls_result, ls_values[], ls_clear[]
datetime ldt_price_dt
decimal ld_price_pct
long ll_investmentid, ll_ret, ll_row, ll_ids_ret, ll_ids_row
integer li_list, li_results, li_read
datastore lds_data, lds_ids
n_cst_string ln_string

//Get input file to create
select ref_code
into :ls_input
from reference
where ref_type = 'SPInputFile';

//Retrieve investment records to get list of cusips for pricing
If NOT IsValid(lds_data) Then lds_data = CREATE datastore
lds_data.DataObject = 'd_ls_cusip_list'
lds_data.SetTransObject(SQLCA)
ll_ret = lds_data.Retrieve()

If ll_ret <= 0 Then
	Goto eof
End If

//Get date and time
ls_today = String(today(), 'mm/dd/yyyy')
ls_now = String(now(), 'hh:mm:ss')

//Open key file (list of cusips)
li_list = FileOpen(ls_input, LineMode!, Write!, LockReadWrite!, Replace!)

//Create header record
ls_header = 'MONYSEF|0001|R|' + ls_today + '|' + String(ll_ret + 2) + '|' + ls_today + '|' + ls_now

FileWrite(li_list, ls_header)

//Add CUSIPs to the key file
For ll_row = 1 to ll_ret
		ls_cusip = lds_data.GetItemString(ll_row, 'cusip') + '|CUSIP'
		FileWrite(li_list, ls_cusip)
Next

//Create trailer record
ls_trailer = 'MONYSEF|T|' + ls_today + '|' + String(ll_ret + 2) + '|' + ls_today + '|' + ls_now

FileWrite(li_list, ls_trailer)
FileClose(li_list)


//Get return file to create
select ref_code
into :ls_return
from reference
where ref_type = 'SPReturnFile';

If FileExists(ls_return) Then
	
	//Create IDs datastore to find multiple investment_ids per cusip
	If NOT IsValid(lds_ids) Then lds_ids = CREATE datastore
	lds_ids.DataObject = 'd_ls_cusip_ids'
	lds_ids.SetTransObject(SQLCA)
	
	SetNull(ls_cusip)
		
	//Open results file
	li_results = FileOpen(ls_return)
	
	//Read first two lines (headers)
	li_read = FileRead(li_results, ls_result)
	If li_read <= 0 Then Goto eof
	
	li_read = FileRead(li_results, ls_result)
	If li_read <= 0 Then Goto eof
	
	//Third line is the first row of data
	li_read = FileRead(li_results, ls_result)
	
	Do While li_read > 0
		
		If Left(ls_result, 5) <> 'CUSIP' Then Exit	//Reached the Trailer record
		
		//Get values out of string which is full line text
		ln_string.of_ParseToArray(ls_result, '|', ls_values[])
	
		ls_cusip = ls_values[2]
		ld_price_pct = Dec(ls_values[7])
		ldt_price_dt = DateTime(Date(Left(ls_values[8], 2) + '/' + Mid(ls_values[8], 3, 2) + '/' + Right(ls_values[8],4)))
		
		//Get investment records for that cusip
		ll_ids_ret = lds_ids.Retrieve(ls_cusip)
		
		If ll_ids_ret > 0 Then
			
			For ll_ids_row = 1 to ll_ids_ret
				
				ll_investmentid = lds_ids.GetItemNumber(ll_ids_row, 'investment_id')
				
				//Insert new price
				Insert into ls_investment_price(investment_id, price_dt, price_amt, price_pct, price_method, last_updated_dt, last_updated_by)
				Values (:ll_investmentId, :ldt_price_dt, 0, :ld_price_pct,  'SP', getdate(), 'SYSTEM');
				
			Next
			
		End If
		
		ls_values[] = ls_clear[]
		
		//Read next line
		li_read = FileRead(li_results, ls_result)
		
	Loop
	
	//Close file
	FileClose(li_results)
	
	//Get Archive file and move
	select ref_code
	into :ls_archive
	from reference
	where ref_type = 'SPArchiveFile';
	
	FileCopy(ls_return, ls_archive, True)
	FileDelete(ls_return)
	
End If

eof:
If IsValid(lds_data) Then DESTROY lds_data
If IsValid(lds_ids) Then DESTROY lds_ids
end event

type st_1 from statictext within w_util
integer x = 174
integer y = 3032
integer width = 155
integer height = 56
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Entry:"
alignment alignment = right!
boolean focusrectangle = false
end type

type sle_entry from singlelineedit within w_util
integer x = 352
integer y = 3020
integer width = 1664
integer height = 84
integer taborder = 160
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
borderstyle borderstyle = stylelowered!
end type

type cb_5 from commandbutton within w_util
boolean visible = false
integer x = 1449
integer y = 52
integer width = 361
integer height = 100
integer taborder = 40
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Test Cusip"
end type

event clicked;string ls_cusip
long ll_row, ll_ret
datastore lds_data

//lds_data = CREATE datastore
//
//lds_data.dataobject = 'd_ls_ft_input'
//lds_data.SetTransObject(SQLCA)
//ll_ret = lds_data.Retrieve()
//
//For ll_row = 1 to ll_ret
//	
//	ls_cusip = lds_data.GetItemString(ll_row, 'cusip')
//	
//	If NOT parent.of_checkCusip(ls_cusip) Then
//		of_add_log(ls_cusip + ' is NOT valid.')
//	End If
//
//Next


ls_cusip = sle_entry.Text

If NOT parent.of_checkCusip(ls_cusip) Then
	of_add_log(ls_cusip + ' is NOT valid.')
Else
	of_add_log(ls_cusip + ' IS valid.')
End If

end event

type cb_4 from commandbutton within w_util
event ue_posturl_attempt ( )
boolean visible = false
integer x = 1010
integer y = 52
integer width = 361
integer height = 100
integer taborder = 30
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "RPlus Load"
end type

event ue_posturl_attempt();
integer li_rc, li_post
Blob lblb_args
String ls_header, ls_url, ls_request, ls_result, ls_authorization
long ll_length

//Get reference to the internet service
li_rc = GetContextService( 'Internet', iinet )

IF li_rc = 1 THEN

	//Create the Internet Response object
	ir = CREATE n_ir
	
	//Set the URL
//	ls_url = 'http://rplus.intdata.com/cgi/nph-rplus'
	ls_url = 'http://rplus.intdata.com/cgi/nph-rplus'
	
	//Set the Authorization credentials as Base64 Encoded for our userid:password
	ls_authorization = 'ZDRueWVmYzpkYXRhMTI='

	//Set the Request and get length (example is url encoded "GET,IDC,DES1")
	ls_request = 'Request=GET%2CIDC%2CDES1&Done=flag'
	
	lblb_args = Blob( ls_request )
	ll_length = Len( lblb_args )

	//Create the header (~r is carriage return)
	ls_header = 'POST /cgi/nph-rplus HTTP/1.0~n' + &
					'Content-Type: application/x-www-form-urlencoded~n' + &
					'Authorization: Basic ' + ls_authorization + '~n' + &
					'Content-Length: ' + String( ll_length ) + '~n~n'

//'POST /cgi/nph-rplus HTTP/1.0~n' + &
	clipboard(ls_header)
	
	//Call the POST
	li_post = iinet.PostURL( ls_url, lblb_args, ls_header, ir )
	
	Choose Case li_post
		Case 1
			ls_result = 'Success'
		Case -1
			ls_result = 'General error'
		Case -2
			ls_result = 'Invalid URL'
		Case -4
			ls_result = 'Cannot connect to the Internet'
		Case -5
			ls_result = 'Unsupported secure (HTTPS) connection attempted'
		Case -6
			ls_result = 'Internet request failed'
			
	End Choose
	
	Messagebox('Post Result', ls_result)

END IF

end event

event clicked;string ls_cusip, ls_out, ls_list, ls_run, ls_cusip_check, ls_path
long ll_ret, ll_row, ll_investmentId, ll_ids_ret, ll_ids_row
datetime ldt_inv_date
decimal {3} ld_price_pct
integer li_list, li_out
time lt_begin
datastore lds_data, lds_results, lds_ids

If NOT IsValid(lds_data) Then lds_data = CREATE datastore
If NOT IsValid(lds_results) Then lds_results = CREATE datastore
If NOT IsValid(lds_ids) Then lds_ids = CREATE datastore

//Get reference to file path location for FT files
select ref_code
into :ls_path
from reference
where ref_type = 'FTfileLocation';

ls_path = 'f:\rplus\ft\'

//Build file names
ls_list = ls_path + 'cusiplist.lst' 
ls_out = ls_path + 'rplus.dat'
ls_run = ls_path + 'rplus.bat'

////Retrieve investment records to get list of cusips for pricing
//lds_data.DataObject = 'd_ls_cusip_list'
//lds_data.SetTransObject(SQLCA)
//ll_ret = lds_data.Retrieve()
//
//of_add_log(string(ll_ret) + ' cusips retrieved.')
//
//If ll_ret <= 0 Then
//	If IsValid(lds_data) Then DESTROY lds_data
//	If IsValid(lds_results) Then DESTROY lds_results
//	Goto EOF
//End If
//
////Open key file (list of cusips)
//li_list = FileOpen(ls_list, LineMode!, Write!, LockReadWrite!, Replace!)
//
////Add CUSIPs to the key file
//For ll_row = 1 to ll_ret
//		ls_cusip = lds_data.GetItemString(ll_row, 'cusip')
//		FileWrite(li_list, ls_cusip)
//Next
//FileClose(li_list)
//
//of_add_log('list written')
//
////Run the FFG32 executable via a batch file - will rename the original data file and log file for backup
//Run(ls_run)
//
//of_add_log('ffg run')
//
////Once we know the datafile is back and complete, read it into the results datastore 
////(add a 60 second timer for all rows to be written since they are written in blocks of data)
//Do While NOT FileExists(ls_out)
//	//Just to make sure it exists
//Loop
//
//of_add_log('output file found')
//
//lt_begin = Now()
//
////Give 1 minute lag for results to come back
//Do while SecondsAfter(lt_begin, Now()) < 60
//	//
//Loop

lds_results.DataObject = 'd_ls_ft_results'
ll_ret = lds_results.ImportFile(CSV!, ls_out)

If ll_ret <= 0 Then
	//LOG THIS EVENT ERROR
	Goto EOF
End If

of_add_log(string(lds_results.RowCount()) + ' rows on data file.')

lds_ids.DataObject = 'd_ls_cusip_ids'
lds_ids.SetTransObject(SQLCA)

//Loop through all the returned cusip prices and get Investement records (potentially more than 1) for each and insert new prices
For ll_row = 1 to ll_ret
	ls_cusip = lds_results.GetItemString(ll_row, 'cusip')
	ld_price_pct = lds_results.GetItemDecimal(ll_row, 'price_pct')
	ldt_inv_date = lds_results.GetItemDateTime(ll_row, 'price_dt')
		
	//Get investment records for that cusip
	ll_ids_ret = lds_ids.Retrieve(ls_cusip)
	
	If ll_ids_ret > 0 Then
		
		For ll_ids_row = 1 to ll_ids_ret
			
			ll_investmentid = lds_ids.GetItemNumber(ll_ids_row, 'investment_id')
			
			//Insert new price
			Insert into ls_investment_price(investment_id, price_dt, price_amt, price_pct, price_method, last_updated_dt, last_updated_by)
			Values (:ll_investmentId, :ldt_inv_date, 0, :ld_price_pct,  'FT', getdate(), 'SYSTEM');
			
		Next
		
	End If

Next

of_add_log('done inserting prices')

EOF:
If IsValid(lds_data) Then DESTROY lds_data
If IsValid(lds_results) Then DESTROY lds_results
If IsValid(lds_ids) Then DESTROY lds_ids
end event

type cb_3 from commandbutton within w_util
boolean visible = false
integer x = 571
integer y = 52
integer width = 361
integer height = 100
integer taborder = 20
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Move Dates"
end type

event clicked;integer li_x
long ll_count, ll_ret, ll_row, ll_gigpid
string ls_from[], ls_to[]
string ls_comment_from, ls_comment_to, ls_return
datetime ldt_date
datastore lds_data

ls_from = {'readyPROJPLANAPRV','readyREGDECCERT','readyFINPLANSAPRV','readySERPCERTCOMPL'}
ls_to = {'readyPROJPLANSUB', 'regCERTSNTDEC','readyFINPLANSSUB','readySERPCERTSNTREG'}
ls_return = Char(13)

lds_data = CREATE datastore
lds_data.DataObject = 'd_move_dates'
lds_data.SetTransObject(SQLCA)

For li_x = 1 to 4
	of_add_log('***Starting ' + ls_from[li_x] + '***')
	
	ll_ret = lds_data.Retrieve(ls_from[li_x])
	
	For ll_row = 1 to ll_ret
		ll_gigpid = lds_data.GetItemNumber(ll_row, 'gigp_id')
		
		select count(*)
		into :ll_count
		from gigp_key_dates
		where gigp_id = :ll_gigpid
		and ref_code = :ls_to[li_x];
		
		If ll_count <= 0 Then
			//insert
			insert into gigp_key_dates (gigp_id, ref_code, keydate_value, keydate_value2, keydate_ind, keydate_choice, keydate_comments, alternate_text, last_updated_by, last_updated_dt)
			select gigp_id, :ls_to[li_x], null, keydate_value, keydate_ind, keydate_choice, keydate_comments, alternate_text, 'SYSTEM', getdate()
			from gigp_key_dates
			where gigp_id = :ll_gigpid
			and ref_code = :ls_from[li_x];
			
			of_add_log('	GIGP ' + String(ll_gigpid) + ' inserted.')
			
		Else
			//update
			ls_comment_from = lds_data.GetItemString(ll_row, 'keydate_comments')
			ldt_date = lds_data.GetItemDateTime(ll_row, 'keydate_value')
			
			select keydate_comments
			into :ls_comment_to
			from gigp_key_dates
			where gigp_id = :ll_gigpid
			and ref_code = :ls_to[li_x];
			
			If NOT IsNull(ls_comment_from) and ls_comment_from > '' Then
				If NOT IsNull(ls_comment_to) and ls_comment_to > '' Then
					ls_comment_to = ls_comment_from + ls_return + ls_comment_to
				Else
					ls_comment_to = ls_comment_from
				End If
			End If
			
			update gigp_key_dates
			set keydate_value2 = :ldt_date,
				keydate_comments = :ls_comment_to,
				last_updated_by = 'SYSTEM',
				last_updated_dt = getdate()
			where gigp_id = :ll_gigpid
			and ref_code = :ls_to[li_x];
			
			of_add_log('	GIGP ' + String(ll_gigpid) + ' updated.')
			
		End If
		
	Next
	
Next

//move dates over for these ref_codes from one date to the other
update gigp_key_dates
set keydate_value2 = keydate_value
where ref_code = 'readyPROJPLANDEC';

update gigp_key_dates
set keydate_value = null
where ref_code = 'readyPROJPLANDEC';

update gigp_key_dates
set keydate_value2 = keydate_value
where ref_code = 'readyPLANSSPECSDEC';

update gigp_key_dates
set keydate_value = null
where ref_code = 'readyPLANSSPECSDEC';


If IsValid(lds_data) Then DESTROY lds_data
end event

type cb_1 from commandbutton within w_util
integer x = 2103
integer y = 3020
integer width = 187
integer height = 84
integer taborder = 170
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Save"
end type

event clicked;dw_log.SaveAs()
end event

type dw_log from u_dw within w_util
integer x = 123
integer y = 1780
integer width = 2555
integer height = 1144
integer taborder = 190
string dataobject = "d_util_log"
end type

type cb_2 from commandbutton within w_util
boolean visible = false
integer x = 133
integer y = 52
integer width = 361
integer height = 100
integer taborder = 10
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "Load R3 Apps"
end type

event clicked;datetime ldt_app
integer li_district, li_checklist
decimal ld_metric
long ll_gigpId, ll_row, ll_count, ll_cfa, ll_contact, ll_place, ll_semi, ll_semi_hold, ll_plc, ll_applicant, ll_other
string ls_name, ls_type, ls_status, ls_senate, ls_assembly, ls_metric, ls_busname, ls_addr, ls_city, ls_state, ls_zip, ls_phone, ls_lon, ls_lat, ls_applicant, ls_email, ls_checklist
string ls_prefix, ls_fname, ls_lname, ls_title, ls_fullname, ls_applicantname, ls_funding_rec
datastore lds_apps
n_cst_string ln_string

of_add_log('Begin at ' + String(Today(), "m/d/yy hh:mm"))

ii_round = 3

ldt_app = DateTime(Date('10/31/2011'))

//Create Application Record
lds_apps = CREATE Datastore
lds_apps.DataObject = 'd_round3_apps'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve()

of_add_log(String(ll_count) + ' raw applications found.')

If ll_count <= 0 Then
	of_add_log('Load aborted.')
	Return
End If

For ll_row = 1 to ll_count
	ll_gigpID = f_gettokenvalue('gigpID', 1)
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'app_id')
	ls_busname =  lds_apps.GetItemString(ll_row, 'business_name')
	ls_type = of_get_answer(549, ll_cfa)
	
	insert into gigp_application (gigp_id, round_no, project_name, srf_program, grant_type, eligible_pct, dec_region, muni_code, seqr_type, project_no, loan_id, typeof_applicant, applicant_type, app_recvd_dt, app_status, ccr_name, funding_recommendation, reviewing_agency, federal_id_no, duns_no, naics_no, county_fips_code, spdes_no, pop_count, pop_source, project_score, last_updated_dt, last_updated_by, cfa_no, locked_flag)
	values (:ll_gigpID, 3, :ls_busname, 'CW', 'Construction', 90, null, null, null, null, null, :ls_type, null, :ldt_app, null, null, null, null, null, null, null, null, null, null, null, 0, getdate(), 'SYSTEM', :ll_cfa, 0);
	
	of_add_log('Application added for ' + ls_busname)
	
	//Create Metrics  
	of_insertMetric(35, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OSAVE')	
	of_insertMetric(42, ll_gigpID, ll_cfa, 'Water Efficiency', 'GALYEARH2OREUSE')	
	of_insertMetric(43, ll_gigpID, ll_cfa, 'Green Infrastructure', 'RUNOFFREDUCTION')
	of_insertMetric(45, ll_gigpID, ll_cfa, 'Green Infrastructure', 'TONSYEARSEDIMENT')
	of_insertMetric(46, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADSALT')
	of_insertMetric(47, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADPHOS')
	of_insertMetric(49, ll_gigpID, ll_cfa, 'Green Infrastructure', 'LBSYEARROADNITR')
	of_insertMetric(52, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETRESTORE')
	of_insertMetric(53, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANACREWETCREATED')
	of_insertMetric(56, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSHOREPROTECT')
	of_insertMetric(58, ll_gigpID, ll_cfa, 'Green Infrastructure', 'PLANFEETSTREAMSTABILZ')

	of_add_log('Metrics added for ' + ls_busname)

	
	//Create Summaries
	of_insertSummary(63, ll_gigpId, ll_cfa, 'waterBodies')
	of_insertSummary(72, ll_gigpId, ll_cfa, 'additWaterQualBen')
	of_insertSummary(77, ll_gigpId, ll_cfa, 'spurGreenInnov')
	of_insertSummary(82, ll_gigpId, ll_cfa, 'buildGreenCapacty')
	of_insertSummary(91, ll_gigpId, ll_cfa, 'outrchEdOpportunty')
	of_insertSummary(94, ll_gigpId, ll_cfa, 'projMonitoring')
	of_insertSummary(109, ll_gigpId, ll_cfa, 'projCollaboration')
	of_insertSummary(575, ll_gigpId, ll_cfa, 'appProjDescription')
	
	of_insertSummary(97, ll_gigpid, ll_cfa, 'ltOperationMaint')
	
	
	of_add_log('Summaries added for ' + ls_busname)

	
	//Create Budget (Total Project Costs???)
	of_insertAmount(670, ll_gigpId, ll_cfa, 'PLN', 'Engineering')
	of_insertAmount(672, ll_gigpId, ll_cfa, 'DES', 'Engineering')
	of_insertAmount(674, ll_gigpId, ll_cfa, 'TCC', 'Construction')
	of_insertAmount(679, ll_gigpId, ll_cfa, 'MISC', 'Miscellaneous')
	
	of_add_log('Budget added for ' + ls_busname)
	
	//Create Funding
	of_insertAmount(658, ll_gigpId, ll_cfa, 'GIGPFR', 'Reqeusted')
	of_insertAmount(659, ll_gigpId, ll_cfa, '10MMN', 'Matching')
	
//	Need to discuss further:
//	of_insertAmount(660, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(662, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(664, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(665, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
//	of_insertAmount(668, ll_gigpId, ll_cfa, 'OTHFS', 'Other')
	
	of_add_log('Funding added for ' + ls_busname)
	
	//Insert checklist item for Project Required by MS 4...
	SetNull(ls_checklist)
	
	ls_checklist = of_get_answer(21, ll_cfa)
	
	If NOT IsNull(ls_checklist) and ls_checklist > '' Then
		
		If Upper(Trim(ls_checklist)) = 'YES' Then
			li_checklist = 1
		Else
			li_checklist = 0
		End If
		
	End If
	
	insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
	values(:ll_gigpId, 'noMuniQues3', 1, 'SYSTEM', getdate());
	
	//Insert rest of checklist items
	insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
	values(:ll_gigpId, 'PROJCWSRFELIG', 1, 'SYSTEM', getdate());
	
	insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
	values(:ll_gigpId, 'APPLNTCWSRFELIG', 1, 'SYSTEM', getdate());
	
	insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
	values(:ll_gigpId, 'GPRELIG', 1, 'SYSTEM', getdate());
	
	insert into gigp_checklist(gigp_id, ref_code, checklist_value, last_updated_by, last_updated_dt)
	values(:ll_gigpId, 'GWWI', 1, 'SYSTEM', getdate());
	
	
Next


//Create Contacts (and update App Status) and load Senate / Assembly
lds_apps.DataObject = 'd_round3_contacts'
lds_apps.SetTransObject(SQLCA)

ll_count = lds_apps.Retrieve()

of_add_log(String(ll_count) + ' Contact Records found.')

If ll_count <= 0 Then
	of_add_log('Contacts aborted.')
	Return
End If

of_add_log('Adding Contacts, Updating App Status, Project Name, Senate & Assembly')

For ll_row = 1 to ll_count
	ll_cfa = lds_apps.GetItemNumber(ll_row, 'cfa_no')
	ls_status = lds_apps.GetItemString(ll_row, 'appstatus')
	ls_name = lds_apps.GetItemString(ll_row, 'projecttitle')
	
	If ls_status = 'ELIGIBLE' Then
		ls_funding_rec = 'DONOTREC'
	Else
		ls_funding_rec = 'INELIGIBLE'
	End If
	
	of_add_log('Contacts for cfa ' + String(ll_cfa) + '...')
	
	//Get GIGPID
	select gigp_id, project_name
	into :ll_gigpID, :ls_busname
	from gigp_application
	where cfa_no = :ll_cfa;
	
	//Update App status and Project Name
	update gigp_application
	set app_status = :ls_status,
		project_name = :ls_name,
		funding_recommendation = :ls_funding_rec
	where cfa_no = :ll_cfa;
	
	//Insert Project Location Record (then link political districts to it)
	ll_plc = f_gettokenvalue('contactID', 1)
	ls_addr = of_get_answer(928, ll_cfa)
	
	If IsNull(ls_addr) or ls_addr = '' Then
		ls_addr = of_get_answer(971, ll_cfa)
	End If
	
	ls_city = of_get_answer(565, ll_cfa)
	ls_state = of_get_answer(568, ll_cfa)
	ls_zip = of_get_answer(1034, ll_cfa)
	
//	ls_lon = of_get_answer(573, ll_cfa)	//Cleaned up versions below
//	ls_lat = of_get_answer(572, ll_cfa)	//Cleaned up versions below

	ls_lat = lds_apps.GetItemString(ll_row, 'lat')
	ls_lon = lds_apps.GetItemString(ll_row, 'lon')
	
	ls_phone = of_get_answer(651, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
	values (:ll_plc, :ls_busname, :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_plc, :ll_gigpID, 'PLC');
	
	
	//Add Senate (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_senate = Trim(lds_apps.GetItemString(ll_row, 'senate'))
	
	If NOT IsNull(ls_senate) and ls_senate > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_senate, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no)
				values(:ll_plc, 'nysSenate', :li_district);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_senate, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_senate, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysSenate', :li_district);
			
			
		Else
			li_district = Integer(ls_senate)
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysSenate', :li_district);
			
		End If
		
	End If
	
	
	//Add Assembly (Use District to get Contact ID from District table, then Add Contact Link w/ PLC Contact Type)
	ls_assembly = Trim(lds_apps.GetItemString(ll_row, 'assembly'))
	
	If NOT IsNull(ls_assembly) and ls_assembly > '' Then
	
		ll_place = 1
		ll_semi = 0
		ll_semi_hold = 0
		
		ll_semi = POS(ls_assembly, ';', ll_place)
		
		If ll_semi > 0 Then
			Do While ll_semi > 0
				li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi - ll_place)))
				ll_semi_hold = ll_semi
				
				insert into gigp_political_districts(contact_id, district_type, district_no)
				values(:ll_plc, 'nysAssembly', :li_district);
						
				ll_place = ll_semi + 1
				ll_semi = POS(ls_assembly, ';', ll_place)
				
			Loop
			//last one
			li_district = Integer(Trim(Mid(ls_assembly, ll_place, ll_semi_hold - ll_place)))
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysAssembly', :li_district);
			
			
		Else
			li_district = Integer(ls_assembly)
			
			insert into gigp_political_districts(contact_id, district_type, district_no)
			values(:ll_plc, 'nysAssembly', :li_district);
			
		End If
		
	End If
	
	
	//Search for Applicant
	SetNull(ll_applicant)
	
	ls_applicant = of_get_answer(546, ll_cfa)

	select max(contact_id)
	into :ll_applicant
	from gigp_contacts
	where Upper(organization) = Upper(:ls_applicant);
	
	
	//Add or Link to Contact (***using contacts table instead of of_get_answer???)
	If IsNull(ll_applicant) or ll_applicant <= 0 Then
		ll_applicant = f_gettokenvalue('contactID', 1)
//		ls_addr = of_get_answer(551, ll_cfa)
//		ls_city = of_get_answer(552, ll_cfa)
//		ls_state = of_get_answer(553, ll_cfa)
//		ls_zip = of_get_answer(554, ll_cfa)
//		ls_email = of_get_answer(555, ll_cfa)

		ls_addr =  lds_apps.GetItemString(ll_row, 'applicantstreet')
		ls_city = lds_apps.GetItemString(ll_row, 'applicantcity')
		ls_state = lds_apps.GetItemString(ll_row, 'applicantstate')
		ls_zip = lds_apps.GetItemString(ll_row, 'applicantzip')
		ls_email = lds_apps.GetItemString(ll_row, 'applicantemail')
		
		If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
			ls_fullname = ls_fname + ' ' + ls_lname
		Else
			ls_fullname = ''
		End If
		
		ls_phone = of_get_answer(651, ll_cfa)
		ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
		ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')
		
	
		insert into gigp_contacts (contact_id, organization, mail_address1, mail_city, mail_state, mail_zip, email, phone_1, status, last_updated_by, last_updated_dt, gis_longitude, gis_latitude)
		values (:ll_applicant, :ls_applicant,  :ls_addr, :ls_city, :ls_state, :ls_zip, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate(), :ls_lon, :ls_lat);
		
	End if
	
	insert into gigp_contact_links (contact_id, gigp_id, contact_type)
	Values (:ll_applicant, :ll_gigpID, 'APP');
	
	
	//Add "Other" Contact???
	ls_fname = lds_apps.GetItemString(ll_row, 'addlfname')
	ls_lname = lds_apps.GetItemString(ll_row, 'addllname')
	ls_title = lds_apps.GetItemString(ll_row, 'addltitle')
	ls_email = lds_apps.GetItemString(ll_row, 'addlemail')
	
	ls_phone = of_get_answer(562, ll_cfa)
	ls_phone = ln_string.of_globalreplace(ls_phone, '-', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, '(', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ')', '')
	ls_phone = ln_string.of_globalreplace(ls_phone, ' ', '')

	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then

		ll_other = f_gettokenvalue('contactID', 1)
	
		insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, email, phone_1, status, last_updated_by, last_updated_dt)
		values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname, :ls_email, :ls_phone, 'Active', 'SYSTEM', getdate());
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'OTH');
		
	End If
	
	
	//Add "Primary" Contact???
	ls_fname = of_get_answer(547, ll_cfa)
	ls_lname = of_get_answer(1049, ll_cfa)
	ls_title = of_get_answer(1050, ll_cfa)
	
	If NOT IsNull(ls_fname) and NOT IsNull(ls_lname) Then
		ls_fullname = ls_fname + ' ' + ls_lname
	Else
		ls_fullname = ''
	End If

	If ls_fullname > '' Then

		ll_other = f_gettokenvalue('contactID', 1)
	
		insert into gigp_contacts (contact_id, first_name, last_name, title, full_name, status, last_updated_by, last_updated_dt)
		values (:ll_other, :ls_fname, :ls_lname, :ls_title, :ls_fullname,  'Active', 'SYSTEM', getdate());
		
		insert into gigp_contact_links (contact_id, gigp_id, contact_type)
		Values (:ll_other, :ll_gigpID, 'PRC');
		
	End If
	

Next

of_add_log('Done adding Contacts')

of_add_log('End at ' + String(Today(), "m/d/yy hh:mm"))

If IsValid(lds_apps) Then DESTROY lds_apps
end event

type gb_1 from groupbox within w_util
integer x = 82
integer y = 1688
integer width = 2647
integer height = 1276
integer textsize = -8
integer weight = 700
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
string text = "Status"
end type

type dw_cfa from datawindow within w_util
integer x = 1312
integer y = 1720
integer width = 686
integer height = 116
integer taborder = 180
string title = "none"
string dataobject = "d_round5_answers"
boolean livescroll = true
borderstyle borderstyle = stylelowered!
end type

type gb_2 from groupbox within w_util
integer x = 82
integer y = 4
integer width = 2647
integer height = 1632
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
long textcolor = 33554432
long backcolor = 67108864
end type

type cb_147 from commandbutton within w_util
integer x = 1056
integer y = 1300
integer width = 343
integer height = 100
integer taborder = 330
integer textsize = -8
integer weight = 400
fontcharset fontcharset = ansi!
fontpitch fontpitch = variable!
fontfamily fontfamily = swiss!
string facename = "Arial"
string text = "test"
end type

